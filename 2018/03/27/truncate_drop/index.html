
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>truncate table 和 drop table 的一点坑 | Focus on MySQL,Focus on Life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" content="网上一搜这个关键字，得到的结果大多都是delete、truncate、drop之间的区别
但是今天我们要讲的内容，是我们在生产环境中遇到的真实案例
互联网公司一般对大表，都会采用分区表或者物理分表吧，这里主要描述的是分表的删除过程中的问题
案例一

环境

12345MySQL5.1.54InnoD">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Life">Focus on MySQL,Focus on Life</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2018/03/27/truncate_drop/" title="truncate table 和 drop table 的一点坑" itemprop="url">truncate table 和 drop table 的一点坑</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2018-03-27T02:32:24.000Z" itemprop="datePublished">Mar 27 2018</time>
    Updated:<time datetime="2018-04-18T12:33:03.000Z" itemprop="dateModified">Apr 18 2018</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#案例一"><span class="toc-number">1.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例二"><span class="toc-number">2.</span> <span class="toc-text">案例二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例三"><span class="toc-number">3.</span> <span class="toc-text">案例三</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最佳实践"><span class="toc-number">5.</span> <span class="toc-text">最佳实践</span></a></li></ol>
		</div>
		
		<p>网上一搜这个关键字，得到的结果大多都是delete、truncate、drop之间的区别</p>
<p>但是今天我们要讲的内容，是我们在生产环境中遇到的真实案例</p>
<p>互联网公司一般对大表，都会采用分区表或者物理分表吧，这里主要描述的是分表的删除过程中的问题</p>
<h2 id="案例一">案例一</h2>
<ul>
<li>环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MySQL5.<span class="number">1.54</span></div><div class="line">InnoDB</div><div class="line"><span class="number">128</span>G memory</div><div class="line">innodb_adaptive_<span class="built_in">hash</span>_index=<span class="number">1</span></div><div class="line">centos6.<span class="number">6</span></div></pre></td></tr></table></figure>

<ul>
<li>问题复现</li>
</ul>
<p>业务描述：由于磁盘空间不断上涨，DBA定期会去删除业务过期不用的表，比如自动删除1年之前的数据</p>
<p>当执行到 drop table的时候，实例的慢查询从 5/s 飙升到 3000/s， 10ms 飙升到 200ms （表大小在10G左右）</p>
<p>slow sql的种类非常多，并不是被删除表的slow ，而是其他表的查询变慢。</p>
<p>别问我怎么知道的，这是我们的slow 监控系统发现的</p>
<p>那么问题来了，Drop table 为啥会出现这样的问题呢？</p>
<p>当然，当时还不得而知，后来我们就换了种思路，drop table = truncate table + drop table，结果神奇的是：慢查询不见了</p>
<h2 id="案例二">案例二</h2>
<ul>
<li>环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">MySQL5.<span class="number">6.27</span></div><div class="line">InnoDB</div><div class="line"><span class="number">128</span>G memory</div><div class="line">innodb_adaptive_<span class="built_in">hash</span>_index=<span class="number">1</span></div><div class="line">centos6.<span class="number">6</span></div></pre></td></tr></table></figure>

<ul>
<li>问题复现</li>
</ul>
<p>业务描述：由于磁盘空间不断上涨，DBA定期会去删除业务过期不用的表，比如自动删除1年之前的数据</p>
<p>由于之前5.1的经验，我们的脚本同样延续之前的做法，drop table = truncate table + drop table</p>
<p>结果在 truncate table 的时候，慢查询出现了，症状和5.1之前的drop table 一模一样</p>
<p>后来，我们还是换了种思路，将truncate table 直接换成 drop table ， 神奇的是：慢查询又不见了</p>
<h2 id="案例三">案例三</h2>
<blockquote>
<p>最后一个血腥的案例</p>
</blockquote>
<ul>
<li>环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="constant">MySQL5</span>.<span class="number">6.27</span></div><div class="line"><span class="constant">MySQL5</span>.<span class="number">7.21</span></div><div class="line"><span class="constant">InnoDB</span></div><div class="line"><span class="number">128</span>G memory</div><div class="line">innodb_adaptive_hash_index=<span class="number">1</span></div><div class="line"><span class="input"><span class="prompt">centos6.6</span></span></div><div class="line"></div><div class="line"></div><div class="line">M(5.6)</div><div class="line">|</div><div class="line">-&gt; <span class="constant">S1</span>(<span class="number">5.6</span>)</div><div class="line"><span class="input"><span class="prompt">-&gt;</span> <span class="constant">S2</span>(<span class="number">5.6</span>)</span></div><div class="line"><span class="input"><span class="prompt">-&gt;</span> <span class="constant">S3</span>(<span class="number">5.7</span>)</span></div></pre></td></tr></table></figure>

<ul>
<li>问题</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div></pre></td><td class="code"><pre><div class="line">* 业务描述：</div><div class="line">一主三从，从库有<span class="number">2</span>个版本，<span class="number">2</span>个是<span class="number">5.6</span><span class="number">.27</span>，<span class="number">1</span>个是<span class="number">5.7</span><span class="number">.21</span></div><div class="line">在Master 执行truncate table xx ， 当master执行完毕后，过了一会，<span class="number">3</span>个slave全部开始延迟，延迟一段时间后，其中两个crash，自动重启。</div><div class="line">这是多么一个神奇的事情</div><div class="line"></div><div class="line"></div><div class="line">* 错误日志</div><div class="line"></div><div class="line">mysql tables <span class="keyword">in</span> use <span class="number">1</span>, locked <span class="number">1</span></div><div class="line"><span class="number">0</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">0</span> row lock(s)</div><div class="line">MySQL thread id <span class="number">24952</span>, OS thread handle <span class="number">140332353423104</span>, query id <span class="number">70663631</span> System lock</div><div class="line">truncate table broker_lifecycle_status</div><div class="line"></div><div class="line">SEMAPHORES</div><div class="line">----------</div><div class="line">OS WAIT ARRAY INFO: reservation count <span class="number">88024435</span></div><div class="line">--Thread <span class="number">140329857865472</span> has waited at buf0flu.cc line <span class="number">1209</span> <span class="keyword">for</span> <span class="number">0.00</span> seconds the semaphore:</div><div class="line">SX-lock on RW-latch at <span class="number">0x7faf43804cb8</span> created <span class="keyword">in</span> file buf0buf.cc line <span class="number">1460</span></div><div class="line">a writer (thread id <span class="number">140332353423104</span>) has reserved it <span class="keyword">in</span> mode  SX</div><div class="line">number of readers <span class="number">0</span>, waiters flag <span class="number">1</span>, lock_word: <span class="number">10000000</span></div><div class="line">Last time read locked <span class="keyword">in</span> file row0sel.cc line <span class="number">3751</span></div><div class="line">Last time write locked <span class="keyword">in</span> file /export/home/pb2/build/sb_0-<span class="number">26514852</span>-<span class="number">1514433850.9</span>/mysql-<span class="number">5.7</span><span class="number">.21</span>/storage/innobase/fsp/fsp0fsp.cc line <span class="number">656</span></div><div class="line">--Thread <span class="number">140332352624384</span> has waited at ha_innodb.cc line <span class="number">5582</span> <span class="keyword">for</span> <span class="number">240.00</span> seconds the semaphore:</div><div class="line">Mutex at <span class="number">0x8af31638</span>, Mutex DICT_SYS created dict0dict.cc:<span class="number">1172</span>, lock var <span class="number">1</span></div><div class="line"></div><div class="line">--Thread <span class="number">140332512077568</span> has waited at srv0srv.cc line <span class="number">1982</span> <span class="keyword">for</span> <span class="number">270.00</span> seconds the semaphore:</div><div class="line">X-lock on RW-latch at <span class="number">0x8af31598</span> created <span class="keyword">in</span> file dict0dict.cc line <span class="number">1183</span></div><div class="line">a writer (thread id <span class="number">140332353423104</span>) has reserved it <span class="keyword">in</span> mode  exclusive</div><div class="line">number of readers <span class="number">0</span>, waiters flag <span class="number">1</span>, lock_word: <span class="number">0</span></div><div class="line">Last time read locked <span class="keyword">in</span> file row0purge.cc line <span class="number">862</span></div><div class="line">Last time write locked <span class="keyword">in</span> file /export/home/pb2/build/sb_0-<span class="number">26514852</span>-<span class="number">1514433850.9</span>/mysql-<span class="number">5.7</span><span class="number">.21</span>/storage/innobase/row/row0trunc.cc line <span class="number">1835</span></div><div class="line">OS WAIT ARRAY INFO: signal count <span class="number">232035265</span></div><div class="line">RW-shared spins <span class="number">0</span>, rounds <span class="number">279022143</span>, OS waits <span class="number">12780361</span></div><div class="line">RW-excl spins <span class="number">0</span>, rounds <span class="number">1878235251</span>, OS waits <span class="number">18129012</span></div><div class="line">RW-sx spins <span class="number">129404128</span>, rounds <span class="number">2720581091</span>, OS waits <span class="number">36295215</span></div><div class="line">Spin rounds per wait: <span class="number">279022143.00</span> RW-shared, <span class="number">1878235251.00</span> RW-excl, <span class="number">21.02</span> RW-sx</div><div class="line"></div><div class="line"></div><div class="line">InnoDB: <span class="comment">###### Diagnostic info printed to the standard error stream</span></div><div class="line"><span class="number">2018</span>-<span class="number">04</span>-17T11:<span class="number">59</span>:<span class="number">30.590002</span>+<span class="number">08</span>:<span class="number">00</span> <span class="number">0</span> [ERROR] [FATAL] InnoDB: Semaphore wait has lasted &gt; <span class="number">600</span> seconds. We intentionally crash the server because it appears to be hung.</div><div class="line"><span class="number">2018</span>-<span class="number">04</span>-<span class="number">17</span> <span class="number">11</span>:<span class="number">59</span>:<span class="number">30</span> <span class="number">0x7fa1b6c88700</span>  InnoDB: Assertion failure <span class="keyword">in</span> thread <span class="number">140332533057280</span> <span class="keyword">in</span> file ut0ut.cc line <span class="number">942</span></div><div class="line">InnoDB: We intentionally generate a memory trap.</div><div class="line">InnoDB: Submit a detailed bug report to http://bugs.mysql.com.</div><div class="line">InnoDB: If you get repeated assertion failures or crashes, even</div><div class="line">InnoDB: immediately after the mysqld startup, there may be</div><div class="line">InnoDB: corruption <span class="keyword">in</span> the InnoDB tablespace. Please refer to</div><div class="line">InnoDB: http://dev.mysql.com/doc/refman/<span class="number">5.7</span>/en/forcing-innodb-recovery.html</div><div class="line">InnoDB: about forcing recovery.</div><div class="line"></div><div class="line"></div><div class="line">* strace 结果</div><div class="line"></div><div class="line"><span class="number">91079</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">91071</span> futex(<span class="number">0x8af31764</span>, FUTEX_WAIT_PRIVATE, <span class="number">3508</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">90833</span> futex(<span class="number">0x1e73a84</span>, FUTEX_WAIT_PRIVATE, <span class="number">295237</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">44265</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">14421</span> futex(<span class="number">0x1e73a84</span>, FUTEX_WAIT_PRIVATE, <span class="number">295236</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">25300</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">192855</span> futex(<span class="number">0x8af31764</span>, FUTEX_WAIT_PRIVATE, <span class="number">3507</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">60765</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">51043</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36890</span> futex(<span class="number">0x1e41a44</span>, FUTEX_WAIT_PRIVATE, <span class="number">1</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36889</span> rt_sigtimedwait([HUP QUIT TERM], <span class="literal">NULL</span>, <span class="literal">NULL</span>, <span class="number">8</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36886</span> futex(<span class="number">0x3b99394</span>, FUTEX_WAIT_PRIVATE, <span class="number">1</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36885</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36884</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36883</span> futex(<span class="number">0x3b99274</span>, FUTEX_WAIT_PRIVATE, <span class="number">1</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36882</span> futex(<span class="number">0x3b990c4</span>, FUTEX_WAIT_PRIVATE, <span class="number">170512183</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36881</span> futex(<span class="number">0x3b99034</span>, FUTEX_WAIT_PRIVATE, <span class="number">230090551</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36880</span> futex(<span class="number">0x3b98fa4</span>, FUTEX_WAIT_PRIVATE, <span class="number">302280849</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36879</span> futex(<span class="number">0x3b98f14</span>, FUTEX_WAIT_PRIVATE, <span class="number">72214487</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36878</span> futex(<span class="number">0x8af0b5c4</span>, FUTEX_WAIT_PRIVATE, <span class="number">23749</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36877</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36876</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36875</span> restart_syscall(&lt;<span class="keyword">...</span> resuming interrupted call <span class="keyword">...</span>&gt; &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36873</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270083</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36872</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270082</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36871</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270080</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36870</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270081</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36869</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270077</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36868</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270079</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36867</span> futex(<span class="number">0x8af01f64</span>, FUTEX_WAIT_PRIVATE, <span class="number">12270078</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36866</span> futex(<span class="number">0x33dd8ae4</span>, FUTEX_WAIT_PRIVATE, <span class="number">6225</span>, <span class="literal">NULL</span> &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36865</span> io_getevents(<span class="number">140422104584192</span>, <span class="number">1</span>, <span class="number">256</span>,  &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36864</span> io_getevents(<span class="number">140422104596480</span>, <span class="number">1</span>, <span class="number">256</span>,  &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36863</span> io_getevents(<span class="number">140422104608768</span>, <span class="number">1</span>, <span class="number">256</span>,  &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36862</span> io_getevents(<span class="number">140422104621056</span>, <span class="number">1</span>, <span class="number">256</span>,  &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36861</span> io_getevents(<span class="number">140422104633344</span>, <span class="number">1</span>, <span class="number">256</span>,  &lt;unfinished <span class="keyword">...</span>&gt;</div><div class="line"><span class="number">36860</span> io_getevents(<span class="number">140422104645632</span>, <span class="number">1</span>, <span class="number">256</span>,  &lt;unfinished <span class="keyword">...</span>&gt;</div></pre></td></tr></table></figure>

<ul>
<li>分析</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">1. 很明显，执行<span class="operator"><span class="keyword">truncate</span>再<span class="keyword">slave</span>被卡住了</span></div><div class="line"></div><div class="line"><span class="number">2.</span> <span class="number">3</span>台<span class="keyword">slave</span>都报同样的错误，卡了很长时间，ACTIVE <span class="number">252</span> sec truncating <span class="keyword">table</span> 一直增加。</div><div class="line"></div><div class="line"><span class="number">3.</span> 其中两台<span class="keyword">slave</span>（<span class="number">1</span>台<span class="number">5.6</span>，<span class="number">1</span>台<span class="number">5.7</span>）Semaphore wait has lasted &gt; <span class="number">600</span> seconds之后重启</div><div class="line"></div><div class="line"><span class="number">4.</span> 还有一台<span class="keyword">slave</span> 当Semaphore快要到<span class="number">600</span>s的时候，结束了，所以怀疑是MySQL bug（MySQL8<span class="number">.0</span>修复），<span class="keyword">truncate</span>的时候<span class="keyword">purge</span>线程处理太慢导致</div><div class="line"></div><div class="line"><span class="number">5.</span> 网上也有类似故障：</div><div class="line"></div><div class="line">	Truncation was executed <span class="keyword">on</span> <span class="keyword">master</span> which executed it <span class="keyword">as</span> expected without failure but <span class="keyword">immediate</span> <span class="keyword">slave</span> crashed afterwards, heavy <span class="keyword">read</span> activity <span class="keyword">is</span> mostly happening <span class="keyword">on</span> <span class="keyword">slave</span></div><div class="line"></div><div class="line">https://bugs.mysql.com/bug.php?id=<span class="number">68184</span></div><div class="line">https://bugs.launchpad.net/percona-<span class="keyword">server</span>/+bug/<span class="number">1633869</span></div><div class="line"></div><div class="line"><span class="number">6.</span> 还有说innodb_purge_threads=<span class="number">4</span>导致的，但是我们的MySQL5<span class="number">.6</span>设置的就是<span class="number">1</span>，所以这个不成立。</div><div class="line">https://blog.pythian.com/mysql-crashes-ddl-statement-lesson-<span class="keyword">purge</span>-threads/</div></pre></td></tr></table></figure>

<h2 id="总结">总结</h2>
<p>好了，这几个问题彻底弄晕我们，不同版本之间的truncate 和 drop 会给用户带来不同的体验</p>
<p>后来，仔细研究了下官方文档，其实有一些猫腻在里面，有兴趣的同学可以深究下</p>
<p><a href="https://dev.mysql.com/doc/refman/5.7/en/truncate-table.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.7/en/truncate-table.html</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">On</span> a system <span class="keyword">with</span> a large InnoDB <span class="keyword">buffer</span> pool <span class="keyword">and</span> innodb_adaptive_hash_index enabled,</div><div class="line">TRUNCATE TABLE operations may cause a temporary drop <span class="keyword">in</span> system performance due <span class="keyword">to</span> an LRU scan that occurs <span class="keyword">when</span> removing an InnoDB table<span class="attribute">'s</span> adaptive hash index entries.</div><div class="line">The problem was addressed <span class="keyword">for</span> DROP TABLE <span class="keyword">in</span> MySQL <span class="number">5.5</span><span class="number">.23</span> (Bug #<span class="number">13704145</span>, Bug #<span class="number">64284</span>) but remains a known issue <span class="keyword">for</span> TRUNCATE TABLE (Bug #<span class="number">68184</span>).</div></pre></td></tr></table></figure>

<h2 id="最佳实践">最佳实践</h2>
<ul>
<li>MySQL5.6版本以下：使用truncate table + drop table 替代 drop table</li>
<li>MySQL5.6版本+ ： 直接使用drop table</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/Error/">Error</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2018/03/27/truncate_drop/" data-title="truncate table 和 drop table 的一点坑 | Focus on MySQL,Focus on Life" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/05/03/gtid_binlog_gtid_simple_recovery/" title="MySQL运维之 binlog_gtid_simple_recovery(GTID)">
  <strong>PREVIOUS:</strong><br/>
  <span>
  MySQL运维之 binlog_gtid_simple_recovery(GTID)</span>
</a>
</div>


<div class="next">
<a href="/2017/11/22/mha_by_hand_non_gtid/"  title="MHA failover NON-GTID 专题">
 <strong>NEXT:</strong><br/> 
 <span>MHA failover NON-GTID 专题
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2018/03/27/truncate_drop/" data-title="truncate table 和 drop table 的一点坑" data-url="https://Keithlan.github.io/2018/03/27/truncate_drop/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#案例一"><span class="toc-number">1.</span> <span class="toc-text">案例一</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例二"><span class="toc-number">2.</span> <span class="toc-text">案例二</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#案例三"><span class="toc-number">3.</span> <span class="toc-text">案例三</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#总结"><span class="toc-number">4.</span> <span class="toc-text">总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#最佳实践"><span class="toc-number">5.</span> <span class="toc-text">最佳实践</span></a></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>50</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>37</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Error/" title="Error">Error<sup>2</sup></a></li>
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>9</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MHA/" title="MHA">MHA<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>46</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>6</sup></a></li>
		
			<li><a href="/tags/MySQL-实战/" title="MySQL 实战">MySQL 实战<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
