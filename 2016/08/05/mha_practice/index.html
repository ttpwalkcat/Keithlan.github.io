
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>MySQL Master High Available 实战篇 | Focus on MySQL,Focus on Life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" content="测试背景

以下所有测试，全部基于以下复制结构完成

123host_1(host_1:3306) (current master) +--host_2(host_2:3306) +--host_3(host_3:3306)

一、MHA安装

mha node 所有服务器节点都要安装mha man">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Life">Focus on MySQL,Focus on Life</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/08/05/mha_practice/" title="MySQL Master High Available 实战篇" itemprop="url">MySQL Master High Available 实战篇</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2016-08-05T05:50:24.000Z" itemprop="datePublished">Aug 5 2016</time>
    Updated:<time datetime="2017-04-24T08:34:10.000Z" itemprop="dateModified">Apr 24 2017</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试背景"><span class="toc-number">1.</span> <span class="toc-text">测试背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、MHA安装"><span class="toc-number">2.</span> <span class="toc-text">一、MHA安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、MHA配置文件"><span class="toc-number">3.</span> <span class="toc-text">二、MHA配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、前提要求(必须满足)"><span class="toc-number">4.</span> <span class="toc-text">三、前提要求(必须满足)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1_SSH公钥认证"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 SSH公钥认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2_操作系统"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 操作系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3_单写master和多slave或者只读master"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 单写master和多slave或者只读master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4_三层或者多层复制环境"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 三层或者多层复制环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5_MySQL版本必须是5-0_或者高于_5-0"><span class="toc-number">4.5.</span> <span class="toc-text">3.5 MySQL版本必须是5.0 或者高于 5.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6_使用mysqlbinlog_5-1+_支持MySQL5-1+"><span class="toc-number">4.6.</span> <span class="toc-text">3.6 使用mysqlbinlog 5.1+ 支持MySQL5.1+</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7_log-bin必须在候选master上开启"><span class="toc-number">4.7.</span> <span class="toc-text">3.7 log-bin必须在候选master上开启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8_binlog，relay-log_主从环境必须全部一致"><span class="toc-number">4.8.</span> <span class="toc-text">3.8 binlog，relay-log 主从环境必须全部一致</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9_复制用户必须在候选master上要存在"><span class="toc-number">4.9.</span> <span class="toc-text">3.9 复制用户必须在候选master上要存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-10_使用purge_relay_logs来定期删除relay_logs"><span class="toc-number">4.10.</span> <span class="toc-text">3.10 使用purge_relay_logs来定期删除relay logs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11_不要在SBR的环境中使用load_data_infile"><span class="toc-number">4.11.</span> <span class="toc-text">3.11 不要在SBR的环境中使用load data infile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、实战演练"><span class="toc-number">5.</span> <span class="toc-text">四、实战演练</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-0_简单的failover过程"><span class="toc-number">5.1.</span> <span class="toc-text">4.0 简单的failover过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2_测试场景一、_手工操作，手动完成，failover"><span class="toc-number">6.</span> <span class="toc-text">4.2 测试场景一、 手工操作，手动完成，failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3_[功能测试]_测试场景二、手工操作,_自动完成，failover"><span class="toc-number">7.</span> <span class="toc-text">4.3 [功能测试] 测试场景二、手工操作, 自动完成，failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4_[功能测试]_测试场景三、手工操作，自动完成，online_master_switch"><span class="toc-number">8.</span> <span class="toc-text">4.4 [功能测试] 测试场景三、手工操作，自动完成，online master switch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5_测试场景四、自动监控，自动操作，自动完成，failover"><span class="toc-number">9.</span> <span class="toc-text">4.5 测试场景四、自动监控，自动操作，自动完成，failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6_[用例测试]_MySQL_master_too_many_connection，无权限，响应慢"><span class="toc-number">10.</span> <span class="toc-text">4.6 [用例测试] MySQL master too many connection，无权限，响应慢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7_[用例测试]_MySQL_master_服务器_down掉，且候选master落后的最多，_是否自动failover，知否可以成功的做日志补偿"><span class="toc-number">11.</span> <span class="toc-text">4.7 [用例测试] MySQL master 服务器 down掉，且候选master落后的最多， 是否自动failover，知否可以成功的做日志补偿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8_[用例测试]_Master_没挂，但是MySQL_slave_服务_down掉，是否自动failover"><span class="toc-number">12.</span> <span class="toc-text">4.8 [用例测试] Master 没挂，但是MySQL slave 服务 down掉，是否自动failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9_[用例测试]_Master_挂了，但是MySQL_slave_有问题，是否自动failover"><span class="toc-number">13.</span> <span class="toc-text">4.9 [用例测试] Master 挂了，但是MySQL slave 有问题，是否自动failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10_[用例测试]_MySQL_master_有大事务超过100s再执行，是否online_master_switch"><span class="toc-number">14.</span> <span class="toc-text">4.10 [用例测试] MySQL master 有大事务超过100s再执行，是否online master switch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-11_[用例测试]_MySQL_master_网络断掉"><span class="toc-number">15.</span> <span class="toc-text">4.11 [用例测试] MySQL master 网络断掉</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-12_[用例测试]_MySQL_master_网路瞬断（1~30秒），是否自动failover"><span class="toc-number">16.</span> <span class="toc-text">4.12 [用例测试] MySQL master 网路瞬断（1~30秒），是否自动failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试0_（没有二次检测的机制）"><span class="toc-number">17.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试0 （没有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试1_（有二次检测的机制）"><span class="toc-number">18.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试1 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试2_（有二次检测的机制）"><span class="toc-number">19.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试2 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试3_（有二次检测的机制）"><span class="toc-number">20.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试3 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试4_（没有二次检测的机制）"><span class="toc-number">21.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试4 （没有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试5_（有二次检测的机制）"><span class="toc-number">22.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试5 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试6_（没有二次检测的机制）"><span class="toc-number">23.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试6 （没有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试7_（有二次检测的机制）"><span class="toc-number">24.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试7 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-15_[用例测试]_Non-GTID模式下，需要relay-log吗？是否能够成功的补齐日志"><span class="toc-number">25.</span> <span class="toc-text">4.15 [用例测试] Non-GTID模式下，需要relay-log吗？是否能够成功的补齐日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-16_[用例测试]_GTID模式下，需要relay-log吗？是否能够成功的补齐日志"><span class="toc-number">26.</span> <span class="toc-text">4.16 [用例测试] GTID模式下，需要relay-log吗？是否能够成功的补齐日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-18_[用例测试]_在一开始没有开启MHA的group中，然后master挂了，如何做到日志补偿，然后change_master呢？"><span class="toc-number">27.</span> <span class="toc-text">4.18 [用例测试] 在一开始没有开启MHA的group中，然后master挂了，如何做到日志补偿，然后change master呢？</span></a></li></ol>
		</div>
		
		<h2 id="测试背景">测试背景</h2>
<blockquote>
<p>以下所有测试，全部基于以下复制结构完成</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">host_1</span><span class="params">(host_1:<span class="number">3306</span>)</span> <span class="params">(current master)</span></span></div><div class="line"> +--<span class="title">host_2</span><span class="params">(host_2:<span class="number">3306</span>)</span></div><div class="line"> +--<span class="title">host_3</span><span class="params">(host_3:<span class="number">3306</span>)</span></div></pre></td></tr></table></figure>

<h2 id="一、MHA安装">一、MHA安装</h2>
<blockquote>
<p>mha node 所有服务器节点都要安装<br>mha manager 只需要安装在manager节点  </p>
</blockquote>
<ul>
<li><strong>MHA NODE</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">1. </span>yum install perl-DBD-MySQL</div><div class="line"><span class="bullet">2. </span>rpm -ivh mha4mysql-node-0.56-0.el6.noarch.rpm</div></pre></td></tr></table></figure>

<ul>
<li><strong>MHA Manager</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">1. yum <span class="operator"><span class="keyword">install</span> perl-DBD-MySQL</span></div><div class="line"><span class="number">2.</span> yum <span class="keyword">install</span> perl-Config-Tiny</div><div class="line"><span class="number">3.</span> yum <span class="keyword">install</span> perl-<span class="keyword">Log</span>-Dispatch</div><div class="line"><span class="number">4.</span> yum <span class="keyword">install</span> perl-Parallel-ForkManager</div><div class="line"><span class="number">5.</span> yum <span class="keyword">install</span> perl-<span class="keyword">Time</span>-HiRes</div><div class="line"><span class="number">6.</span> rpm -ivh mha4mysql-manager-<span class="number">0.56</span>-<span class="number">0.</span>el6.noarch.rpm</div></pre></td></tr></table></figure>

<ul>
<li><strong>MHA rpm安装路径</strong></li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">* Node </div><div class="line">Node&gt; rpm -qpl mha4mysql-node-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm</div><div class="line"></div><div class="line">/usr/bin/apply_diff_relay_logs</div><div class="line">/usr/bin/filter_mysqlbinlog</div><div class="line">/usr/bin/purge_relay_logs</div><div class="line">/usr/bin/save_binary_logs</div><div class="line">/usr/share/man/man1/apply_diff_relay_logs.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/filter_mysqlbinlog.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/purge_relay_logs.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/save_binary_logs.<span class="number">1</span>.gz</div><div class="line">/usr/share/perl5/vendor_perl/MHA/BinlogHeaderParser.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/BinlogManager.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/BinlogPosFindManager.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/BinlogPosFinder.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/BinlogPosFinderElp.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/BinlogPosFinderXid.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/NodeConst.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/NodeUtil.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/SlaveUtil.pm</div><div class="line"></div><div class="line">* Manager</div><div class="line">Manager&gt; rpm -qpl mha4mysql-manager-<span class="number">0.56</span>-<span class="number">0</span>.el6.noarch.rpm</div><div class="line"></div><div class="line">/usr/bin/masterh<span class="built_in">a_check</span>_repl</div><div class="line">/usr/bin/masterh<span class="built_in">a_check</span>_ssh</div><div class="line">/usr/bin/masterh<span class="built_in">a_check</span>_status</div><div class="line">/usr/bin/masterh<span class="built_in">a_conf</span>_host</div><div class="line">/usr/bin/masterh<span class="built_in">a_manager</span></div><div class="line">/usr/bin/masterh<span class="built_in">a_master</span>_monitor</div><div class="line">/usr/bin/masterh<span class="built_in">a_master</span>_switch</div><div class="line">/usr/bin/masterh<span class="built_in">a_secondary</span>_check</div><div class="line">/usr/bin/masterh<span class="built_in">a_stop</span></div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_check</span>_repl.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_check</span>_ssh.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_check</span>_status.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_conf</span>_host.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_manager</span>.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_master</span>_monitor.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_master</span>_switch.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_secondary</span>_check.<span class="number">1</span>.gz</div><div class="line">/usr/share/man/man1/masterh<span class="built_in">a_stop</span>.<span class="number">1</span>.gz</div><div class="line">/usr/share/perl5/vendor_perl/MHA/Config.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/DBHelper.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/FileStatus.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/HealthCheck.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/ManagerAdmin.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/ManagerAdminWrapper.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/ManagerConst.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/MasterRotate.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/SSHCheck.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/Server.pm</div><div class="line">/usr/share/perl5/vendor_perl/MHA/ServerManager.pm</div></pre></td></tr></table></figure>

<h2 id="二、MHA配置文件">二、MHA配置文件</h2>
<ul>
<li>global scope</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">* /etc/masterha_default.cnf</div><div class="line"></div><div class="line">[server default]  -- 这下面的都是全局配置，适用于所有app.cnf</div><div class="line"><span class="variable">user=</span>dba</div><div class="line"><span class="variable">password=</span>dba</div><div class="line"><span class="variable">ssh_user=</span>root</div><div class="line"><span class="variable">master_binlog_dir=</span> /data/mysql.bin</div><div class="line"><span class="variable">secondary_check_script=</span> masterha_secondary_check -s remote_host1 -s remote_host2</div><div class="line"><span class="variable">ping_interval=</span><span class="number">3</span></div><div class="line"><span class="variable">master_ip_failover_script=</span>/script/masterha/master_ip_failover</div><div class="line"><span class="variable">shutdown_script=</span> /script/masterha/power_manager</div><div class="line"><span class="variable">report_script=</span> /script/masterha/send_master_failover_mail</div></pre></td></tr></table></figure>

<ul>
<li>application scope  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">* /etc/app1.cnf</div><div class="line"></div><div class="line">[<span class="built_in">server</span> <span class="keyword">default</span>]</div><div class="line">remote_workdir=/var/<span class="built_in">log</span>/masterha/app1</div><div class="line">manager_workdir=/var/<span class="built_in">log</span>/masterha/app1</div><div class="line">manager_log=/var/<span class="built_in">log</span>/masterha/app1/app1.<span class="built_in">log</span></div><div class="line"></div><div class="line">[<span class="built_in">server</span> <span class="keyword">default</span>] 里面的这些配置，会影响到下面的N 个 <span class="built_in">server</span></div></pre></td></tr></table></figure>

<ul>
<li>local scope</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">* /etc/app1.cnf</div><div class="line"></div><div class="line">[server1]</div><div class="line"><span class="variable">hostname=</span><span class="number">192.168</span>.<span class="number">1.10</span></div><div class="line"><span class="variable">candidate_master=</span><span class="number">1</span></div><div class="line"></div><div class="line">[server2]</div><div class="line"><span class="variable">hostname=</span><span class="number">192.168</span>.<span class="number">1.11</span></div><div class="line"><span class="variable">candidate_master=</span><span class="number">1</span></div><div class="line"></div><div class="line">[server3]</div><div class="line"><span class="variable">hostname=</span><span class="number">192.168</span>.<span class="number">1.12</span></div><div class="line"><span class="variable">no_master=</span><span class="number">1</span></div><div class="line"></div><div class="line">每个server下面的配置，专属于某个server</div></pre></td></tr></table></figure>

<h2 id="三、前提要求(必须满足)">三、前提要求(必须满足)</h2>
<h3 id="3-1_SSH公钥认证">3.1 SSH公钥认证</h3>
<p>基本上MHA manager，MNA node，以及二次检测的节点，都需要互相信任  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># masterha_check_ssh --conf=/etc/app1.cnf</span></div><div class="line">  </div><div class="line">  <span class="title">Sat</span> May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">19</span> <span class="number">2011</span> - [<span class="built_in">warn</span>] Global configuration file /etc/masterha_default.cnf not found. Skipping.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">19</span> <span class="number">2011</span> - [<span class="built_in">info</span>] Reading application default configurations from /etc/app1.cnf..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">19</span> <span class="number">2011</span> - [<span class="built_in">info</span>] Reading server configurations from /etc/app1.cnf..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">19</span> <span class="number">2011</span> - [<span class="built_in">info</span>] Starting SSH connection tests..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">19</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]  Connecting via SSH from root<span class="variable">@host1</span>(<span class="number">192.168.0.1</span>) to root<span class="variable">@host2</span>(<span class="number">192.168.0.2</span>)..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">20</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]   ok.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">20</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]  Connecting via SSH from root<span class="variable">@host1</span>(<span class="number">192.168.0.1</span>) to root<span class="variable">@host3</span>(<span class="number">192.168.0.3</span>)..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">20</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]   ok.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">21</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]  Connecting via SSH from root<span class="variable">@host2</span>(<span class="number">192.168.0.2</span>) to root<span class="variable">@host1</span>(<span class="number">192.168.0.1</span>)..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">21</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]   ok.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">21</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]  Connecting via SSH from root<span class="variable">@host2</span>(<span class="number">192.168.0.2</span>) to root<span class="variable">@host3</span>(<span class="number">192.168.0.3</span>)..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">21</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]   ok.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]  Connecting via SSH from root<span class="variable">@host3</span>(<span class="number">192.168.0.3</span>) to root<span class="variable">@host1</span>(<span class="number">192.168.0.1</span>)..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]   ok.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]  Connecting via SSH from root<span class="variable">@host3</span>(<span class="number">192.168.0.3</span>) to root<span class="variable">@host2</span>(<span class="number">192.168.0.2</span>)..</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2011</span> - [<span class="built_in">debug</span>]   ok.</div><div class="line">  Sat May <span class="number">14</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">22</span> <span class="number">2011</span> - [<span class="built_in">info</span>] All SSH connection tests passed successfully.</div></pre></td></tr></table></figure>

<p>如果slave比较多，实例比较多，最好提高下 /etc/ssh/sshd_config MaxStartups 的值（默认是10）  </p>
<h3 id="3-2_操作系统">3.2 操作系统</h3>
<blockquote>
<p>仅在Linux上测试过  </p>
</blockquote>
<h3 id="3-3_单写master和多slave或者只读master">3.3 单写master和多slave或者只读master</h3>
<p>打从一开始，MHA就是为了解决数据一致性而出生，所以，最好是多个slave<br>如果你只有一个slave，根本就碰不到数据一致性问题，也就不需要mha了<br>如果是一个slave，用版同步复制也能解决  </p>
<p>从0.52开始，MHA就支持多master的复制架构了,下面列举了多master环境下注意点  </p>
<ul>
<li>多master，但是只允许单点写入  </li>
<li>默认情况下，只支持2层复制架构  </li>
</ul>
<h3 id="3-4_三层或者多层复制环境">3.4 三层或者多层复制环境</h3>
<p>默认情况下，MHA是不支持3层或多层复制架构的（Master1 -&gt; Master2 -&gt; Slave3）<br>MHA可以恢复Master2，但是不能恢复Slave3，因为Master2，Slave3有不同的master<br>为了让MHA支持以上架构，可以参考如下配置：  </p>
<ul>
<li>在配置文件中，只配置两层(master1 and master2)  </li>
<li>使用 “multi_tier_slave=1” 参数，然后设置所有hosts  </li>
</ul>
<h3 id="3-5_MySQL版本必须是5-0_或者高于_5-0">3.5 MySQL版本必须是5.0 或者高于 5.0</h3>
<ul>
<li>MySQL版本必须大于等于5.0  </li>
<li>尽量使用高版本的MySQL  </li>
</ul>
<h3 id="3-6_使用mysqlbinlog_5-1+_支持MySQL5-1+">3.6 使用mysqlbinlog 5.1+ 支持MySQL5.1+</h3>
<ul>
<li>MHA使用mysqlbinlog来应用日志到目标slave上的  </li>
<li>如果MySQL master设置的是row格式，那么MySQL必须是大于等于5.1版本，因为5.0不支持row  </li>
<li>mysqlbinlog版本可以这样被检测：</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[app<span class="variable">@slave_host1</span>]<span class="variable">$ </span> mysqlbinlog --version</div><div class="line">mysqlbinlog <span class="constant">Ver</span> <span class="number">3.3</span> <span class="keyword">for</span> unknown-linux-gnu at x86_64</div></pre></td></tr></table></figure>

<ul>
<li>如果你使用的是MySQL5.1，那么mysqlbinlog必须大于等于3.3  </li>
<li>如果mysqlbinlog的版本是3.2，而mysql的版本是5.1，那么mha manager会报错，且停止monitoring  </li>
</ul>
<h3 id="3-7_log-bin必须在候选master上开启">3.7 log-bin必须在候选master上开启</h3>
<ul>
<li>如果当前slave没有设置log-bin，那么很显然它不能成为提升为new master  </li>
<li>如果没有任何机器设置了log-bin，那么mha会报错且停止failover  </li>
</ul>
<h3 id="3-8_binlog，relay-log_主从环境必须全部一致">3.8 binlog，relay-log 主从环境必须全部一致</h3>
<ul>
<li>复制过滤规则（binlog-do-db, replicate-ignore-db 等等）必须全部一致  </li>
</ul>
<h3 id="3-9_复制用户必须在候选master上要存在">3.9 复制用户必须在候选master上要存在</h3>
<ul>
<li>切换完成后，所有slave都必须执行change master 命令。在new master上复制用户必须有（REPLICATEION SLAVE权限）</li>
</ul>
<h3 id="3-10_使用purge_relay_logs来定期删除relay_logs">3.10 使用purge_relay_logs来定期删除relay logs</h3>
<p>默认情况下，如果SQL线程执行完relay-log，relay logs就会被自动删除。<br>但是这些relay-logs 也许还会用来恢复其他的slave，所以你需要关闭自动删除relay-logs的purge线程，然后自己阶段性的来删除<br>如果是你自己来删的话，必须考虑repl 延迟问题  </p>
<p>最好让slave删除relay log不要在同一时间点，假如需要恢复，那么这个时间点所有relay logs都被删除了就不好了  </p>
<h3 id="3-11_不要在SBR的环境中使用load_data_infile">3.11 不要在SBR的环境中使用load data infile</h3>
<p>不管是SBR，还是RBR，最好不要使用load data  </p>
<h2 id="四、实战演练">四、实战演练</h2>
<blockquote>
<ol>
<li>[功能测试] 测试场景一、手工操作，手动完成，failover    </li>
<li>[功能测试] 测试场景二、手工操作, 自动完成，failover  </li>
<li>[功能测试] 测试场景三、手工操作，自动完成，online master switch  </li>
<li>[功能测试] 测试场景四、自动监控，自动操作，自动完成，failover  </li>
<li>[用例测试] MySQL master 服务 down掉，是否成功自动failover   </li>
<li>[用例测试] MySQL master too many connection，无权限，响应慢，是否自动failover    </li>
<li>[用例测试] MySQL master 服务器 down掉，且候选master落后的最多， 是否自动failover，知否可以成功的做日志补偿      </li>
<li>[用例测试] MySQL slave 服务 down掉，是否自动failover    </li>
<li>[用例测试] MySQL 有一台slave，或者多台slave服务器延迟很大，是否自动failover      </li>
<li>[用例测试] MySQL slave IO/SQL线程 stop，是否自动failover    </li>
<li>[用例测试] MySQL slave IO/SQL线程 报错，是否自动failover</li>
<li>[用例测试] MySQL master 有大事务超过100s再执行，是否可以online master switch      </li>
<li>[用例测试] MySQL master 网络断掉，是否自动failover     </li>
<li>[用例测试] MySQL master 网路瞬断（1~30秒），是否自动failover    </li>
<li>[用例测试] MySQL master 和 候选master 网络都挂掉的情况，是否自动failover    </li>
<li>[用例测试] MHA manager 和 MySQL master之间的网络断掉,但是master和slave之间的网络是好的，是否自动failover      </li>
<li>[用例测试] MHA manager 和 MySQL master,slave 网络都断掉的情况，是否自动failover    </li>
<li>[用例测试] GTID模式下，还需要relay-log吗？是否能够成功的补齐日志    </li>
<li>[用例测试] 多线程复制模式下，做failover 和 online master switch，会不会有问题呢？   </li>
<li>[用例测试] 在一开始没有开启MHA的group中，如何做到日志补偿，然后change master呢？  </li>
</ol>
</blockquote>
<h3 id="4-0_简单的failover过程">4.0 简单的failover过程</h3>
<ul>
<li><p>step1：安装MHA node在所有节点上</p>
</li>
<li><p>step2：安装MHA manager</p>
</li>
<li><p>step3：创建配置文件</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">manager_host$ cat /etc/app1.cnf</div><div class="line">  </div><div class="line">  [server default]</div><div class="line">  <span class="comment"># mysql user and password</span></div><div class="line">  <span class="variable">user=</span>root</div><div class="line">  <span class="variable">password=</span>mysqlpass</div><div class="line">  <span class="variable">ssh_user=</span>root</div><div class="line">  <span class="comment"># working directory on the manager</span></div><div class="line">  <span class="variable">manager_workdir=</span>/var/log/masterha/app1</div><div class="line">  <span class="comment"># working directory on MySQL servers</span></div><div class="line">  <span class="variable">remote_workdir=</span>/var/log/masterha/app1</div><div class="line">  </div><div class="line">  [server1]</div><div class="line">  <span class="variable">hostname=</span>host1</div><div class="line">  </div><div class="line">  [server2]</div><div class="line">  <span class="variable">hostname=</span>host2</div><div class="line">  </div><div class="line">  [server3]</div><div class="line">  <span class="variable">hostname=</span>host3</div></pre></td></tr></table></figure>

<ul>
<li>step4: 检查SSH 互信</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># masterha_check_ssh --<span class="keyword">conf</span>=/etc/app1.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step5: 检查复制配置</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager_host$ masterha_check_repl --<span class="keyword">conf</span>=/etc/app1.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step6：开启Manager</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager_host$ masterha_manager --<span class="keyword">conf</span>=/etc/app1.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step7: 检查manager的状态</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager_host$ masterha_check_status --<span class="keyword">conf</span>=/etc/app1.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step8: 测试关闭manager</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">manager_host$ masterha_stop --<span class="keyword">conf</span>=/etc/app1.<span class="keyword">cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step9：测试master failover</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">host1<span class="variable">$ </span> killall -<span class="number">9</span> mysqld mysqld_safe</div></pre></td></tr></table></figure>

<ul>
<li>未完成的步骤(进阶)</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">* 二次检测： 检查master是否真的挂了，避免脑裂   secondary_network_script</div><div class="line"></div><div class="line">* master_ip_failover: 默认的是空，什么都不做  </div><div class="line">	ip漂移</div><div class="line">	新master赋予写</div><div class="line">	日志保留</div><div class="line">	报警</div><div class="line">等等</div></pre></td></tr></table></figure>

<h2 id="4-2_测试场景一、_手工操作，手动完成，failover">4.2 测试场景一、 手工操作，手动完成，failover</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境 </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">* 检查SSH  </div><div class="line">	masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf  </span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)    </div><div class="line">	masterha_check_repl <span class="comment">--conf=/etc/app1.cnf  </span></div><div class="line">		Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">		Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态  </div><div class="line">	masterha_check_status <span class="comment">--conf=/etc/app1.cnf  </span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">	nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &  </span></div><div class="line"></div><div class="line">* 关闭mha 监控  </div><div class="line">	masterha_stop <span class="comment">--conf=/etc/app1.cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手工制造master mysql挂了  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">killall</span> -<span class="number">9</span> mysqld mysqld_safe</div></pre></td></tr></table></figure>



<ul>
<li>step3: 人工交互式failover </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div></pre></td><td class="code"><pre><div class="line">masterha_master_switch <span class="comment">--master_state=dead --conf=/etc/app1.cnf --dead_master_host=host_1 --interactive=1 --ignore_last_failover</span></div><div class="line"></div><div class="line"></div><div class="line">* 切换日志如下：</div><div class="line"></div><div class="line"><span class="comment">--dead_master_ip=&lt;dead_master_ip&gt; is not set. Using host_1.</span></div><div class="line"><span class="comment">--dead_master_port=&lt;dead_master_port&gt; is not set. Using 3306.</span></div><div class="line">Thu Jul 28 16:37:04 2016 - [info] Reading default configuration from /etc/masterha_default.cnf..</div><div class="line">Thu Jul 28 16:37:04 2016 - [info] Reading application default configuration from /etc/app1.cnf..</div><div class="line">Thu Jul 28 16:37:04 2016 - [info] Reading server configuration from /etc/app1.cnf..</div><div class="line">Thu Jul 28 16:37:04 2016 - [info] MHA::MasterFailover version 0.56.</div><div class="line">Thu Jul 28 16:37:04 2016 - [info] Starting master failover.</div><div class="line">Thu Jul 28 16:37:04 2016 - [info]</div><div class="line">Thu Jul 28 16:37:04 2016 - [info] * Phase 1: Configuration <span class="operator"><span class="keyword">Check</span> Phase..</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">0</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Checking <span class="keyword">master</span> reachability via MySQL(<span class="keyword">double</span> <span class="keyword">check</span>)...</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line"><span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> dead. Proceed? (yes/<span class="keyword">NO</span>): yes</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> Non-GTID based failover.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">06</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Forcing shutdown so that applications never <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> <span class="keyword">master</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> the dead <span class="keyword">master</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase completed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000004</span>:<span class="number">154</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000004</span>:<span class="number">154</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead <span class="keyword">Master</span><span class="string">'s Binlog Phase..</span></div><div class="line">Thu Jul 28 16:37:07 2016 - [info]</div><div class="line">Thu Jul 28 16:37:07 2016 - [info] Fetching dead master's <span class="built_in">binary</span> <span class="keyword">logs</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Executing command <span class="keyword">on</span> the dead <span class="keyword">master</span> host_1(host_1:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_1_name.000004  --start_pos=154 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160728163704.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1 <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span>..    ok.</div><div class="line"> <span class="keyword">Concat</span> <span class="built_in">binary</span>/relay <span class="keyword">logs</span> <span class="keyword">from</span> host_1_name<span class="number">.000004</span> pos <span class="number">154</span> <span class="keyword">to</span> host_1_name<span class="number">.000004</span> EOF <span class="keyword">into</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160728163704.<span class="keyword">binlog</span> ..</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line">  Dumping <span class="keyword">binlog</span> <span class="keyword">format</span> description <span class="keyword">event</span>, <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">0</span> <span class="keyword">to</span> <span class="number">154.</span>. ok.</div><div class="line">  <span class="keyword">No</span> need <span class="keyword">to</span> dump effective <span class="keyword">binlog</span> <span class="keyword">data</span> <span class="keyword">from</span> /<span class="keyword">data</span>/mysql.<span class="keyword">bin</span>/host_1_name<span class="number">.000004</span> (pos starts <span class="number">154</span>, filesize <span class="number">154</span>). Skipping.</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160728163704.<span class="keyword">binlog</span> has <span class="keyword">no</span> effective <span class="keyword">data</span> <span class="keyword">events</span>.</div><div class="line"><span class="keyword">Event</span> <span class="keyword">not</span> <span class="keyword">exists</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Additional <span class="keyword">events</span> were <span class="keyword">not</span> <span class="keyword">found</span> <span class="keyword">from</span> the orig <span class="keyword">master</span>. <span class="keyword">No</span> need <span class="keyword">to</span> save.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: Determining New <span class="keyword">Master</span> Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Finding the latest <span class="keyword">slave</span> that has <span class="keyword">all</span> relay <span class="keyword">logs</span> <span class="keyword">for</span> recovering other slaves..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] <span class="keyword">All</span> slaves received relay <span class="keyword">logs</span> <span class="keyword">to</span> the same <span class="keyword">position</span>. <span class="keyword">No</span> need <span class="keyword">to</span> resync <span class="keyword">each</span> other.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Searching new <span class="keyword">master</span> <span class="keyword">from</span> slaves..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration file:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]  Non-candidate masters:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> <span class="keyword">events</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] New <span class="keyword">master</span> <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">07</span> <span class="number">2016</span> - [info]</div><div class="line"><span class="keyword">From</span>:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (new <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">Starting</span> <span class="keyword">master</span> switch <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>)? (yes/<span class="keyword">NO</span>): yes</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info] New <span class="keyword">master</span> decided manually <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: New <span class="keyword">Master</span> Diff <span class="keyword">Log</span> Generation Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]  This <span class="keyword">server</span> has <span class="keyword">all</span> relay <span class="keyword">logs</span>. <span class="keyword">No</span> need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> the latest <span class="keyword">slave</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.4</span>: <span class="keyword">Master</span> <span class="keyword">Log</span> Apply Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info] *NOTICE: <span class="keyword">If</span> <span class="keyword">any</span> error happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> recovery <span class="keyword">on</span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]  This <span class="keyword">server</span> has <span class="keyword">all</span> relay <span class="keyword">logs</span>. Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info]  <span class="keyword">All</span> relay <span class="keyword">logs</span> were successfully applied.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">37</span>:<span class="number">09</span> <span class="number">2016</span> - [info] Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..</span></div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  host_2_name.000002:294</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_2<span class="string">', MASTER_PORT=3306, MASTER_LOG_FILE='</span>host_2_name<span class="number">.000002</span><span class="string">', MASTER_LOG_POS=294, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></div><div class="line">Thu Jul 28 16:37:09 2016 - [info] Executing master IP activate script:</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]   /home/mysql/MHA/masterha/master_ip_failover --command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba<span class="string">' --new_master_password='</span>dba<span class="string">'</span></div><div class="line">Set read_only=0 on the new master.</div><div class="line">No need to Creating app user on the new master..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  OK.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] ** Finished master recovery successfully.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] * Phase 3: Master Recovery Phase completed.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] * Phase 4: Slaves Recovery Phase..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] * Phase 4.1: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] -- Slave diff file generation on host host_3(host_3:3306) started, pid: 6211. Check tmp log /var/log/masterha/app1/host_3_3306_20160728163704.log if it takes time..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] Log messages from host_3 ...</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  This server has all relay logs. No need to generate diff files from the latest slave.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] End of log messages from host_3.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] -- host_3(host_3:3306) has the latest relay log events.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] Generating relay diff files from the latest slave succeeded.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] * Phase 4.2: Starting Parallel Slave Log Apply Phase..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] -- Slave recovery on host host_3(host_3:3306) started, pid: 6216. Check tmp log /var/log/masterha/app1/host_3_3306_20160728163704.log if it takes time..</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] Log messages from host_3 ...</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]</div><div class="line">Thu Jul 28 16:37:09 2016 - [info] Starting recovery on host_3(host_3:3306)..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  This server has all relay logs. Waiting all logs to be applied..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]   done.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  All relay logs were successfully applied.</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  Resetting slave host_3(host_3:3306) and starting replication from the new master host_2(host_2:3306)..</div><div class="line">Thu Jul 28 16:37:09 2016 - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]  Slave started.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] End of log messages from host_3.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] -- Slave recovery on host host_3(host_3:3306) succeeded.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] All new slave servers recovered successfully.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] * Phase 5: New master cleanup phase..</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] Resetting slave info on the new master..</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]  host_2: Resetting slave info succeeded.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info] Master failover to host_2(host_2:3306) completed successfully.</div><div class="line">Thu Jul 28 16:37:10 2016 - [info]</div><div class="line"></div><div class="line">----- Failover Report -----</div><div class="line"></div><div class="line">app1: MySQL Master failover host_1(host_1:3306) to host_2(host_2:3306) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:3306) is down!</div><div class="line"></div><div class="line">Check MHA Manager logs at host_manager_name for details.</div><div class="line"></div><div class="line">Started manual(interactive) failover.</div><div class="line">Invalidated master IP address on host_1(host_1:3306)</div><div class="line">The latest slave host_2(host_2:3306) has all relay logs for recovery.</div><div class="line">Selected host_2(host_2:3306) as a new master.</div><div class="line">host_2(host_2:3306): OK: Applying all logs succeeded.</div><div class="line">host_2(host_2:3306): OK: Activated master IP address.</div><div class="line">host_3(host_3:3306): This host has the latest relay log events.</div><div class="line">Generating relay diff files from the latest slave succeeded.</div><div class="line">host_3(host_3:3306): OK: Applying all logs succeeded. Slave started, replicating from host_2(host_2:3306)</div><div class="line">host_2(host_2:3306): Resetting slave info succeeded.</div><div class="line">Master failover to host_2(host_2:3306) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-3_[功能测试]_测试场景二、手工操作,_自动完成，failover">4.3 [功能测试] 测试场景二、手工操作, 自动完成，failover</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div><div class="line"></div><div class="line">* 关闭mha 监控  </div><div class="line">    masterha_stop <span class="comment">--conf=/etc/app1.cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手工制造master mysql挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">killall</span> -<span class="number">9</span> mysqld mysqld_safe</div></pre></td></tr></table></figure>

<ul>
<li>step3: 人工-非交互式 failover</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">masterha_master_switch --master_state=dead --conf=/etc/app1.cnf --dead_master_host=host_1 --interactive=<span class="number">0</span> --ignore_last_failover</div><div class="line"></div><div class="line"></div><div class="line">* 切换日志如下：</div><div class="line"></div><div class="line">--dead_master_ip=&lt;dead_master_ip&gt; <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. <span class="keyword">Using</span> host_1.</div><div class="line">--dead_master_port=&lt;dead_master_port&gt; <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. <span class="keyword">Using</span> <span class="number">3306.</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2016</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">33</span>:<span class="number">21</span> <span class="number">2016</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/app1.cnf..</div></pre></td></tr></table></figure>

<h2 id="4-4_[功能测试]_测试场景三、手工操作，自动完成，online_master_switch">4.4 [功能测试] 测试场景三、手工操作，自动完成，online master switch</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手工制造master mysql挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">killall</span> -<span class="number">9</span> mysqld mysqld_safe</div></pre></td></tr></table></figure>

<ul>
<li>step3: 手工操作，自动完成，online master switch</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">masterha_master_switch <span class="comment">--master_state=alive --conf=/etc/app1.cnf  --orig_master_is_new_slave --interactive=0</span></div><div class="line"></div><div class="line">* 在online master切换过程中，如果MHA manager 开启，那么切换不会成功</div><div class="line"></div><div class="line">Thu Jul 28 16:13:57 2016 - [info] Checking MHA is not monitoring or doing failover..</div><div class="line">Thu Jul 28 16:13:57 2016 - [error][/usr/share/perl5/vendor_perl/MHA/MasterRotate.pm, ln142] Getting advisory <span class="operator"><span class="keyword">lock</span> failed <span class="keyword">on</span> the <span class="keyword">current</span> <span class="keyword">master</span>. MHA Monitor runs <span class="keyword">on</span> the <span class="keyword">current</span> <span class="keyword">master</span>. <span class="keyword">Stop</span> MHA Manager/Monitor <span class="keyword">and</span> try again.</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">13</span>:<span class="number">57</span> <span class="number">2016</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177] Got ERROR:  <span class="keyword">at</span> /usr/<span class="keyword">bin</span>/masterha_master_switch line <span class="number">53</span></div><div class="line"></div><div class="line">* 在online <span class="keyword">master</span>切换过程中，如果设置<span class="comment">--orig_master_is_new_slave, 但是没有设置repl_password，就会报错  </span></div><div class="line"></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">13</span> <span class="number">2016</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/<span class="keyword">Server</span>.pm, ln784] <span class="keyword">Slave</span> could <span class="keyword">not</span> be started <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)! <span class="keyword">Check</span> <span class="keyword">slave</span> <span class="keyword">status</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">13</span> <span class="number">2016</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/<span class="keyword">Server</span>.pm, ln862] <span class="keyword">Starting</span> <span class="keyword">slave</span> IO/<span class="keyword">SQL</span> thread <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>) failed!</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">13</span> <span class="number">2016</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterRotate.pm, ln573]  Failed!</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">15</span>:<span class="number">13</span> <span class="number">2016</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterRotate.pm, ln602] Switching <span class="keyword">master</span> <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) done, but switching slaves partially failed.</div><div class="line"></div><div class="line"></div><div class="line">* 切换成功的日志如下：</div><div class="line"></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] MHA::MasterRotate <span class="keyword">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> online <span class="keyword">master</span> switch..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">0</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Executing <span class="keyword">FLUSH</span> <span class="keyword">NO_WRITE_TO_BINLOG</span> <span class="keyword">TABLES</span>. This may take long <span class="keyword">time</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking MHA <span class="keyword">is</span> <span class="keyword">not</span> monitoring <span class="keyword">or</span> doing failover..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking replication health <span class="keyword">on</span> host_1..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking replication health <span class="keyword">on</span> host_3..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Searching new <span class="keyword">master</span> <span class="keyword">from</span> slaves..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration file:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  Non-candidate masters:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> <span class="keyword">events</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]</div><div class="line"><span class="keyword">From</span>:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_1(host_1:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (new <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Checking whether host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> ok <span class="keyword">for</span> the new <span class="keyword">master</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] host_2(host_2:<span class="number">3306</span>): <span class="keyword">SHOW</span> <span class="keyword">SLAVE</span> <span class="keyword">STATUS</span> returned empty result. <span class="keyword">To</span> <span class="keyword">check</span> replication filtering rules, temporarily executing <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span> <span class="keyword">to</span> a dummy host.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] host_2(host_2:<span class="number">3306</span>): Resetting <span class="keyword">slave</span> pointing <span class="keyword">to</span> the dummy host.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Rejecting updates Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [warning] master_ip_online_change_script <span class="keyword">is</span> <span class="keyword">not</span> defined. Skipping disabling writes <span class="keyword">on</span> the <span class="keyword">current</span> <span class="keyword">master</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Locking <span class="keyword">all</span> <span class="keyword">tables</span> <span class="keyword">on</span> the orig <span class="keyword">master</span> <span class="keyword">to</span> reject updates <span class="keyword">from</span> everybody (including root):</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Executing <span class="keyword">FLUSH</span> <span class="keyword">TABLES</span> <span class="keyword">WITH</span> <span class="keyword">READ</span> <span class="keyword">LOCK</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Orig <span class="keyword">master</span> <span class="keyword">binlog</span>:pos <span class="keyword">is</span> host_2_name<span class="number">.000002</span>:<span class="number">294.</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  Waiting <span class="keyword">to</span> <span class="keyword">execute</span> <span class="keyword">all</span> relay <span class="keyword">logs</span> <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]  <span class="keyword">master_pos_wait</span>(host_2_name<span class="number">.000002</span>:<span class="number">294</span>) completed <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>). Executed <span class="number">0</span> <span class="keyword">events</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">16</span>:<span class="number">23</span>:<span class="number">25</span> <span class="number">2016</span> - [info] Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..</span></div><div class="line">Thu Jul 28 16:23:25 2016 - [info]  host_1_name.000004:154</div><div class="line">Thu Jul 28 16:23:25 2016 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_1<span class="string">', MASTER_PORT=3306, MASTER_LOG_FILE='</span>host_1_name<span class="number">.000004</span><span class="string">', MASTER_LOG_POS=154, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></div><div class="line">Thu Jul 28 16:23:25 2016 - [info] Setting read_only=0 on host_1(host_1:3306)..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  ok.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] * Switching slaves in parallel..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] -- Slave switch on host host_3(host_3:3306) started, pid: 32120</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] Log messages from host_3 ...</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Waiting to execute all relay logs on host_3(host_3:3306)..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  master_pos_wait(host_2_name.000002:294) completed on host_3(host_3:3306). Executed 0 events.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]   done.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Resetting slave host_3(host_3:3306) and starting replication from the new master host_1(host_1:3306)..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Slave started.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] End of log messages from host_3 ...</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] -- Slave switch on host host_3(host_3:3306) succeeded.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] Unlocking all tables on the orig master:</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] Executing UNLOCK TABLES..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  ok.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] Starting orig master as a new slave..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Resetting slave host_2(host_2:3306) and starting replication from the new master host_1(host_1:3306)..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  Slave started.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] All new slave servers switched successfully.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] * Phase 5: New master cleanup phase..</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]</div><div class="line">Thu Jul 28 16:23:26 2016 - [info]  host_1: Resetting slave info succeeded.</div><div class="line">Thu Jul 28 16:23:26 2016 - [info] Switching master to host_1(host_1:3306) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-5_测试场景四、自动监控，自动操作，自动完成，failover">4.5 测试场景四、自动监控，自动操作，自动完成，failover</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手工制造master mysql挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="title">killall</span> -<span class="number">9</span> mysqld mysqld_safe</div></pre></td></tr></table></figure>

<ul>
<li>step3:  自动监控，自动操作，自动完成，自动failover</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div></pre></td><td class="code"><pre><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">25</span> <span class="number">2016</span> - [info] MHA::MasterMonitor <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Current Alive Master: host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Checking slave configurations..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Checking replication filtering settings..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]  binlog_do_db= , binlog_ignore_db=</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info]  Replication filtering check ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] GTID (<span class="keyword">with</span> auto-pos) <span class="keyword">is</span> <span class="keyword">not</span> supported</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Starting SSH connection tests..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">27</span> <span class="number">2016</span> - [info] All SSH connection tests passed successfully.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">27</span> <span class="number">2016</span> - [info] Checking MHA Node <span class="property">version</span>..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">28</span> <span class="number">2016</span> - [info]  Version check ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">28</span> <span class="number">2016</span> - [info] Checking SSH publickey authentication settings <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> current master..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">28</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Master MHA Node <span class="property">version</span> <span class="keyword">is</span> <span class="number">0.56</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Checking recovery <span class="keyword">script</span> configurations <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   Executing command: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --start_file=host_1_name.000004</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> root@host_1(host_1:<span class="number">22</span>)..</div><div class="line">  Creating /var/<span class="command">log</span>/masterha/app1 <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line">  Checking output directory <span class="keyword">is</span> accessible <span class="keyword">or</span> <span class="keyword">not</span>..</div><div class="line">   ok.</div><div class="line">  Binlog found <span class="keyword">at</span> /data/mysql.bin, up <span class="keyword">to</span> host_1_name<span class="number">.000004</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Binlog setting check done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Checking SSH publickey authentication <span class="keyword">and</span> checking recovery <span class="keyword">script</span> configurations <span class="function_start"><span class="keyword">on</span></span> all alive slave servers..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   Executing command : apply_diff_relay_logs <span class="comment">--command=test --slave_user='dba' --slave_host=host_2 --slave_ip=host_2 --slave_port=3306 --workdir=/var/log/masterha/app1 --target_version=5.7.13-log --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_2_name-relay-bin.000001  --slave_pass=xxx</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> root@host_2(host_2:<span class="number">22</span>)..</div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_2_name-relay-bin<span class="number">.000002</span></div><div class="line">    Temporary relay <span class="command">log</span> <span class="type">file</span> <span class="keyword">is</span> /data/mysql_data/host_2_name-relay-bin<span class="number">.000002</span></div><div class="line">    Testing mysql connection <span class="keyword">and</span> privileges..mysql: [Warning] Using a password <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> command line interface can be insecure.</div><div class="line"> done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning up test <span class="type">file</span>(s).. done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   Executing command : apply_diff_relay_logs <span class="comment">--command=test --slave_user='dba' --slave_host=host_3 --slave_ip=host_3 --slave_port=3306 --workdir=/var/log/masterha/app1 --target_version=5.7.13-log --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3_name-relay-bin.000001  --slave_pass=xxx</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   Connecting <span class="keyword">to</span> root@host_3(host_3:<span class="number">22</span>)..</div><div class="line">  Checking slave recovery environment settings..</div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_3_name-relay-bin<span class="number">.000002</span></div><div class="line">    Temporary relay <span class="command">log</span> <span class="type">file</span> <span class="keyword">is</span> /data/mysql_data/host_3_name-relay-bin<span class="number">.000002</span></div><div class="line">    Testing mysql connection <span class="keyword">and</span> privileges..mysql: [Warning] Using a password <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> command line interface can be insecure.</div><div class="line"> done.</div><div class="line">    Testing mysqlbinlog output.. done.</div><div class="line">    Cleaning up test <span class="type">file</span>(s).. done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Slaves settings check done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]</div><div class="line">host_1(host_1:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info] Checking master_ip_failover_script status:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">29</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--command=status --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30</span> <span class="number">2016</span> - [info]  OK.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> defined.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Set master ping interval <span class="number">3</span> seconds.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] secondary_check_script <span class="keyword">is</span> <span class="keyword">not</span> defined. It <span class="keyword">is</span> highly recommended setting <span class="keyword">it</span> <span class="keyword">to</span> check master reachability <span class="keyword">from</span> two <span class="keyword">or</span> more routes.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Starting ping health check <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">10</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Ping(SELECT) succeeded, waiting <span class="keyword">until</span> MySQL doesn't respond..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">21</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL select ping: <span class="number">2006</span> (MySQL server has gone away)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">21</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">21</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">24</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL server <span class="keyword">at</span> 'reading initial communication packet', system <span class="keyword">error</span>: <span class="number">111</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">24</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">27</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL server <span class="keyword">at</span> 'reading initial communication packet', system <span class="keyword">error</span>: <span class="number">111</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">27</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2013</span> (Lost connection <span class="keyword">to</span> MySQL server <span class="keyword">at</span> 'reading initial communication packet', system <span class="keyword">error</span>: <span class="number">111</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> reachable.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> a master server failed. Reading configuration <span class="type">file</span> /etc/masterha_default.cnf <span class="keyword">and</span> /etc/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check server status..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Reading default configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Reading <span class="type">application</span> default configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Checking slave configurations..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Checking replication filtering settings..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]  Replication filtering check ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Master <span class="keyword">is</span> down!</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Terminating monitoring <span class="keyword">script</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (Master dead).</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Starting master failover.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Starting Non-GTID based failover.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_1_name<span class="number">.000004</span>:<span class="number">154</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_1_name<span class="number">.000004</span>:<span class="number">154</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Fetching dead master's binary logs..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Executing command <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> dead master host_1(host_1:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_1_name.000004  --start_pos=154 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160728171130.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /var/<span class="command">log</span>/masterha/app1 <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_1_name<span class="number">.000004</span> pos <span class="number">154</span> <span class="keyword">to</span> host_1_name<span class="number">.000004</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160728171130.binlog ..</div><div class="line"> Binlog Checksum enabled</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">154.</span>. ok.</div><div class="line">  No need <span class="keyword">to</span> dump effective binlog data <span class="keyword">from</span> /data/mysql.bin/host_1_name<span class="number">.000004</span> (pos starts <span class="number">154</span>, filesize <span class="number">154</span>). Skipping.</div><div class="line"> Binlog Checksum enabled</div><div class="line"> /var/<span class="command">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160728171130.binlog has no effective data events.</div><div class="line">Event <span class="keyword">not</span> exists.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Additional events were <span class="keyword">not</span> found <span class="keyword">from</span> <span class="keyword">the</span> orig master. No need <span class="keyword">to</span> save.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Finding <span class="keyword">the</span> latest slave <span class="keyword">that</span> has all relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] All slaves received relay logs <span class="keyword">to</span> <span class="keyword">the</span> same position. No need <span class="keyword">to</span> resync each other.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  Non-candidate masters:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] New master <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Starting master failover..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">From:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] *NOTICE: If any <span class="keyword">error</span> happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  This server has all relay logs. Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  host_2_name<span class="number">.000002</span>:<span class="number">294</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_2', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='host_2_name<span class="number">.000002</span>', MASTER_LOG_POS=<span class="number">294</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Set read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master.</div><div class="line">No need <span class="keyword">to</span> Creating app user <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  OK.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 22427. Check tmp log /var/log/masterha/app1/host_3_3306_20160728171130.log if it takes time..</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] <span class="comment">-- host_3(host_3:3306) has the latest relay log events.</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 22429. Check tmp log /var/log/masterha/app1/host_3_3306_20160728171130.log if it takes time..</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  This server has all relay logs. Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  Slave started.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] All new slave servers recovered successfully.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]  host_2: Resetting slave info succeeded.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Jul <span class="number">28</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2016</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">app1: MySQL Master failover host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> host_manager_name:/var/<span class="command">log</span>/masterha/app1/app1.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest slave host_2(host_2:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has <span class="keyword">the</span> latest relay <span class="command">log</span> events.</div><div class="line">Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-6_[用例测试]_MySQL_master_too_many_connection，无权限，响应慢">4.6 [用例测试] MySQL master too many connection，无权限，响应慢</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手工制造master too many connection  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">mysqlslap  --concurrency=<span class="number">4000</span> --iterations=<span class="number">10</span>  --query=<span class="comment">'insert into tb(id_2) select (1);'  --debug-info -hhost_1 -uxx -pxx --create-schema=lc  </span></div><div class="line"></div><div class="line">mysqlslap: <span class="keyword">Error</span> <span class="keyword">when</span> connecting <span class="keyword">to</span> server: <span class="number">1040</span> Too many connections</div><div class="line">mysqlslap: <span class="keyword">Error</span> <span class="keyword">when</span> connecting <span class="keyword">to</span> server: <span class="number">1040</span> Too many connections</div><div class="line">mysqlslap: <span class="keyword">Error</span> <span class="keyword">when</span> connecting <span class="keyword">to</span> server: <span class="number">1040</span> Too many connections</div></pre></td></tr></table></figure>

<ul>
<li>step3: 检查是否发生failover</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">* 1. 手动开启另一个<span class="tag">session</span>，链接报错<span class="tag">tmc</span>。 但是并没有发生<span class="tag">failover</span>，说明<span class="tag">master</span> 还活着  </div><div class="line">* 2. 检查了<span class="tag">MHA</span>的<span class="tag">health</span> <span class="tag">check</span>机制，原来是长链接  </div><div class="line"></div><div class="line"><span class="tag">DIGEST_TEXT</span>: <span class="tag">SELECT</span> ? <span class="tag">AS</span> <span class="tag">VALUE</span></div><div class="line"> <span class="tag">COUNT_STAR</span>: 46</div><div class="line"> <span class="tag">FIRST_SEEN</span>: 2016<span class="tag">-08-02</span> 11<span class="pseudo">:28</span><span class="pseudo">:00</span></div><div class="line">  <span class="tag">LAST_SEEN</span>: 2016<span class="tag">-08-02</span> 11<span class="pseudo">:30</span><span class="pseudo">:37</span></div></pre></td></tr></table></figure>

<h2 id="4-7_[用例测试]_MySQL_master_服务器_down掉，且候选master落后的最多，_是否自动failover，知否可以成功的做日志补偿">4.7 [用例测试] MySQL master 服务器 down掉，且候选master落后的最多， 是否自动failover，知否可以成功的做日志补偿</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造候选master落后的情况</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">候选master&gt;</span> stop slave； sleep <span class="number">600</span>s ； start slave；</span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 手动制造master 服务器挂掉的情况  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">master &gt;</span> reboot</span></div></pre></td></tr></table></figure>

<ul>
<li>step4: 观察MHA 日志</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Tue Aug  2 14:33:34 2016 - [warning]  Slave host<span class="emphasis">_2(host_</span>2:3306) SQL Thread delays too much. Latest log file:host<span class="emphasis">_1_</span>name.000002:576864, Current log file:host<span class="emphasis">_1_</span>name.000001:39731438. This server is not selected as a new master because recovery will take long time.</div><div class="line">Tue Aug  2 14:33:34 2016 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln970</span>] None of existing slaves matches as a new master. Maybe preferred node is misconfigured or all slaves are too  far behind.</div><div class="line">Tue Aug  2 14:33:34 2016 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177</span>] Got ERROR:  at /usr/bin/masterha<span class="emphasis">_master_</span>switch line 53</div></pre></td></tr></table></figure>

<ul>
<li>step5：重新修正配置文件</li>
</ul>
<blockquote>
<p>由于要指定特定的slave为候选master，而此slave还落后非常多<br>必须在每组服务器上都加上check_repl_delay=0   </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">vi /etc/app1.cnf</div><div class="line"></div><div class="line">[server default]</div><div class="line"><span class="variable">remote_workdir=</span>/var/log/masterha/app1</div><div class="line"><span class="variable">manager_workdir=</span>/var/log/masterha/app1</div><div class="line"><span class="variable">manager_log=</span>/var/log/masterha/app1/app1.log</div><div class="line"></div><div class="line">[server1]</div><div class="line"><span class="variable">hostname=</span>host_1</div><div class="line"><span class="variable">candidate_master=</span><span class="number">1</span></div><div class="line"><span class="variable">check_repl_delay=</span><span class="number">0</span></div><div class="line"></div><div class="line">[server2]</div><div class="line"><span class="variable">hostname=</span>host_2</div><div class="line"><span class="variable">candidate_master=</span><span class="number">1</span></div><div class="line"><span class="variable">check_repl_delay=</span><span class="number">0</span></div><div class="line"></div><div class="line">[server3]</div><div class="line"><span class="variable">hostname=</span>host_3</div><div class="line"><span class="variable">no_master=</span><span class="number">1</span></div><div class="line"><span class="variable">check_repl_delay=</span><span class="number">0</span></div></pre></td></tr></table></figure>

<ul>
<li>step6：用手工failover再来模拟  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="comment">masterha_master_switch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master_state=dead</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf=/etc/app1</span><span class="string">.</span><span class="comment">cnf</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_host=host_1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">interactive=1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_last_failover</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">new_master_host=host_2</span></div></pre></td></tr></table></figure>





<ul>
<li>step7： 观察MHA 日志  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div></pre></td><td class="code"><pre><div class="line">Tue Aug  2 14:38:55 2016 - [info] Reading default configuration from /etc/masterha_default.cnf..</div><div class="line">Tue Aug  2 14:38:55 2016 - [info] Reading application default configuration from /etc/app1.cnf..</div><div class="line">Tue Aug  2 14:38:55 2016 - [info] Reading server configuration from /etc/app1.cnf..</div><div class="line">Tue Aug  2 14:38:55 2016 - [info] MHA::MasterFailover version 0.56.</div><div class="line">Tue Aug  2 14:38:55 2016 - [info] Starting master failover.</div><div class="line">Tue Aug  2 14:38:55 2016 - [info]</div><div class="line">Tue Aug  2 14:38:55 2016 - [info] * Phase 1: Configuration <span class="operator"><span class="keyword">Check</span> Phase..</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">0</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info] Checking <span class="keyword">master</span> reachability via MySQL(<span class="keyword">double</span> <span class="keyword">check</span>)...</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">55</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line"><span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> dead. Proceed? (yes/<span class="keyword">NO</span>): yes</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">57</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> Non-GTID based failover.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">57</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">57</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">57</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">57</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">57</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] Forcing shutdown so that applications never <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> <span class="keyword">master</span>..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> the dead <span class="keyword">master</span>.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase completed.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000002</span>:<span class="number">576864</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000001</span>:<span class="number">39731619</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead <span class="keyword">Master</span><span class="string">'s Binlog Phase..</span></div><div class="line">Tue Aug  2 14:38:58 2016 - [info]</div><div class="line">Tue Aug  2 14:38:58 2016 - [info] Fetching dead master's <span class="built_in">binary</span> <span class="keyword">logs</span>..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">58</span> <span class="number">2016</span> - [info] Executing command <span class="keyword">on</span> the dead <span class="keyword">master</span> host_1(host_1:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_1_name.000002  --start_pos=576864 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1 <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span>..    ok.</div><div class="line"> <span class="keyword">Concat</span> <span class="built_in">binary</span>/relay <span class="keyword">logs</span> <span class="keyword">from</span> host_1_name<span class="number">.000002</span> pos <span class="number">576864</span> <span class="keyword">to</span> host_1_name<span class="number">.000002</span> EOF <span class="keyword">into</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> ..</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line">  Dumping <span class="keyword">binlog</span> <span class="keyword">format</span> description <span class="keyword">event</span>, <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">0</span> <span class="keyword">to</span> <span class="number">154.</span>. ok.</div><div class="line">  Dumping effective <span class="keyword">binlog</span> <span class="keyword">data</span> <span class="keyword">from</span> /<span class="keyword">data</span>/mysql.<span class="keyword">bin</span>/host_1_name<span class="number">.000002</span> <span class="keyword">position</span> <span class="number">576864</span> <span class="keyword">to</span> tail(<span class="number">577435</span>).. ok.</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> <span class="keyword">Concat</span> succeeded.</div><div class="line">saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span>                                                           <span class="number">100</span>%  <span class="number">725</span>     <span class="number">0.7</span>KB/s   <span class="number">00</span>:<span class="number">00</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">59</span> <span class="number">2016</span> - [info] scp <span class="keyword">from</span> root@host_1:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">local</span>:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> succeeded.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">38</span>:<span class="number">59</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: Determining New <span class="keyword">Master</span> Phase..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Finding the latest <span class="keyword">slave</span> that has <span class="keyword">all</span> relay <span class="keyword">logs</span> <span class="keyword">for</span> recovering other slaves..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Checking whether host_3 has relay <span class="keyword">logs</span> <span class="keyword">from</span> the oldest <span class="keyword">position</span>..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_1_name.000002 --latest_rmlp=576864 --target_mlf=host_1_name.000001 --target_rmlp=39731619 --server_id=12616606 --workdir=/var/log/masterha/app1 --timestamp=20160802143855 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3_name-relay-bin.000004  :</span></div><div class="line">    Relay <span class="keyword">log</span> <span class="keyword">found</span> <span class="keyword">at</span> /<span class="keyword">data</span>/mysql_data, up <span class="keyword">to</span> host_3_name-relay-<span class="keyword">bin</span><span class="number">.000004</span></div><div class="line"> <span class="keyword">Fast</span> relay <span class="keyword">log</span> <span class="keyword">position</span> search failed. Reading relay <span class="keyword">logs</span> <span class="keyword">to</span> find..</div><div class="line">Reading host_3_name-relay-<span class="keyword">bin</span><span class="number">.000004</span></div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> <span class="keyword">Master</span> <span class="keyword">Version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span></div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> host_3_name-relay-<span class="keyword">bin</span><span class="number">.000004</span> contains <span class="keyword">master</span> host_1_name<span class="number">.000002</span> <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">4</span></div><div class="line">Reading host_3_name-relay-<span class="keyword">bin</span><span class="number">.000003</span></div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> host_3_name-relay-<span class="keyword">bin</span><span class="number">.000003</span> contains <span class="keyword">master</span> host_1_name<span class="number">.000001</span> <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">218246073</span></div><div class="line">Reading host_3_name-relay-<span class="keyword">bin</span><span class="number">.000002</span></div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> host_3_name-relay-<span class="keyword">bin</span><span class="number">.000002</span> contains <span class="keyword">master</span> host_1_name<span class="number">.000001</span> <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">154</span></div><div class="line">Target relay <span class="keyword">log</span> <span class="keyword">FOUND</span>!</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] OK. host_3 has <span class="keyword">all</span> relay <span class="keyword">logs</span>.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Searching new <span class="keyword">master</span> <span class="keyword">from</span> slaves..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration file:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]  Non-candidate masters:</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> <span class="keyword">events</span>..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]   <span class="keyword">Not</span> <span class="keyword">found</span>.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> <span class="keyword">all</span> candidate_master slaves..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] New <span class="keyword">master</span> <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">00</span> <span class="number">2016</span> - [info]</div><div class="line"><span class="keyword">From</span>:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (new <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">Starting</span> <span class="keyword">master</span> switch <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>)? (yes/<span class="keyword">NO</span>): yes</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">05</span> <span class="number">2016</span> - [info] New <span class="keyword">master</span> decided manually <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">05</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">05</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: New <span class="keyword">Master</span> Diff <span class="keyword">Log</span> Generation Phase..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">05</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">05</span> <span class="number">2016</span> - [info] <span class="keyword">Server</span> host_2 received relay <span class="keyword">logs</span> up <span class="keyword">to</span>: host_1_name<span class="number">.000001</span>:<span class="number">39731619</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">05</span> <span class="number">2016</span> - [info] Need <span class="keyword">to</span> <span class="keyword">get</span> diffs <span class="keyword">from</span> the latest <span class="keyword">slave</span>(host_3) up <span class="keyword">to</span>: host_1_name<span class="number">.000002</span>:<span class="number">576864</span> (<span class="keyword">using</span> the latest <span class="keyword">slave</span><span class="string">'s relay logs)</span></div><div class="line">Tue Aug  2 14:39:05 2016 - [info] Connecting to the latest slave host host_3, generating diff relay log files..</div><div class="line">Tue Aug  2 14:39:05 2016 - [info] Executing command: apply_diff_relay_logs --command=generate_and_send --scp_user=root --scp_host=host_2 --latest_mlf=host_1_name.000002 --latest_rmlp=576864 --target_mlf=host_1_name.000001 --target_rmlp=39731619 --server_id=12616606 --diff_file_readtolatest=/var/log/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.binlog --workdir=/var/log/masterha/app1 --timestamp=20160802143855 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3_name-relay-bin.000004</div><div class="line">Tue Aug  2 14:39:11 2016 - [info]</div><div class="line">    Relay log found at /data/mysql_data, up to host_3_name-relay-bin.000004</div><div class="line"> Fast relay log position search failed. Reading relay logs to find..</div><div class="line">Reading host_3_name-relay-bin.000004</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Master Version is 5.7.13-log</div><div class="line"> Binlog Checksum enabled</div><div class="line"> host_3_name-relay-bin.000004 contains master host_1_name.000002 from position 4</div><div class="line">Reading host_3_name-relay-bin.000003</div><div class="line"> Binlog Checksum enabled</div><div class="line"> host_3_name-relay-bin.000003 contains master host_1_name.000001 from position 218246073</div><div class="line">Reading host_3_name-relay-bin.000002</div><div class="line"> Binlog Checksum enabled</div><div class="line"> host_3_name-relay-bin.000002 contains master host_1_name.000001 from position 154</div><div class="line"> Target relay log file/position found. start_file:host_3_name-relay-bin.000002, start_pos:39731788.</div><div class="line"> Concat binary/relay logs from host_3_name-relay-bin.000002 pos 39731788 to host_3_name-relay-bin.000004 EOF into /var/log/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.binlog ..</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Binlog Checksum enabled</div><div class="line">  Dumping binlog format description event, from position 0 to 323.. ok.</div><div class="line">  Dumping effective binlog data from /data/mysql_data/host_3_name-relay-bin.000002 position 39731788 to tail(218246252).. ok.</div><div class="line">  Dumping binlog head events (rotate events), skipping format description events from /data/mysql_data/host_3_name-relay-bin.000003..  Binlog Checksum enabled</div><div class="line">dumped up to pos 264. ok.</div><div class="line">  No need to dump effective binlog data from /data/mysql_data/host_3_name-relay-bin.000003 (pos starts 264, filesize 264). Skipping.</div><div class="line">  Dumping binlog head events (rotate events), skipping format description events from /data/mysql_data/host_3_name-relay-bin.000004..  Binlog Checksum enabled</div><div class="line"> Binlog Checksum enabled</div><div class="line">dumped up to pos 373. ok.</div><div class="line">  Dumping effective binlog data from /data/mysql_data/host_3_name-relay-bin.000004 position 373 to tail(577083).. ok.</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay log succeeded. Saved at /var/log/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.binlog .</div><div class="line"> scp host_3_name.58os.org:/var/log/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.binlog to root@host_2(22) succeeded.</div><div class="line">Tue Aug  2 14:39:11 2016 - [info]  Generating diff files succeeded.</div><div class="line">Tue Aug  2 14:39:11 2016 - [info] Sending binlog..</div><div class="line">saved_master_binlog_from_host_1_3306_20160802143855.binlog                                                           100%  725     0.7KB/s   00:00</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] scp from local:/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog to root@host_2:/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog succeeded.</div><div class="line">Tue Aug  2 14:39:12 2016 - [info]</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] * Phase 3.4: Master Log Apply Phase..</div><div class="line">Tue Aug  2 14:39:12 2016 - [info]</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] *NOTICE: If any error happens from this phase, manual recovery is needed.</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] Starting recovery on host_2(host_2:3306)..</div><div class="line">Tue Aug  2 14:39:12 2016 - [info]  Generating diffs succeeded.</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] Waiting until all relay logs are applied.</div><div class="line">Tue Aug  2 14:39:12 2016 - [info]  done.</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] Getting slave status..</div><div class="line">Tue Aug  2 14:39:12 2016 - [info] This slave(host_2)'s Exec_Master_Log_Pos(host_1_name<span class="number">.000001</span>:<span class="number">39731438</span>) does <span class="keyword">not</span> equal <span class="keyword">to</span> Read_Master_Log_Pos(host_1_name<span class="number">.000001</span>:<span class="number">39731619</span>). It <span class="keyword">is</span> likely that relay <span class="keyword">log</span> was cut during <span class="keyword">transaction</span>. Need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Saving <span class="keyword">local</span> relay <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">exec</span> pos <span class="keyword">to</span> <span class="keyword">read</span> pos <span class="keyword">on</span> host_2: <span class="keyword">from</span> host_2_name-relay-<span class="keyword">bin</span><span class="number">.000003</span>:<span class="number">39726380</span> <span class="keyword">to</span> the <span class="keyword">end</span> <span class="keyword">of</span> the relay <span class="keyword">log</span>..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Executing command : save_binary_logs <span class="comment">--command=save --start_file=host_2_name-relay-bin.000003  --start_pos=39726380 --output_file=/var/log/masterha/app1/relay_from_exec_to_read_host_2_3306_20160802143855.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --binlog_dir=/data/mysql_data</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">12</span> <span class="number">2016</span> - [info]</div><div class="line">  Creating /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1 <span class="keyword">if</span> <span class="keyword">not</span> <span class="keyword">exists</span>..    ok.</div><div class="line"> <span class="keyword">Concat</span> <span class="built_in">binary</span>/relay <span class="keyword">logs</span> <span class="keyword">from</span> host_2_name-relay-<span class="keyword">bin</span><span class="number">.000003</span> pos <span class="number">39726380</span> <span class="keyword">to</span> host_2_name-relay-<span class="keyword">bin</span><span class="number">.000003</span> EOF <span class="keyword">into</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_exec_to_read_host_2_3306_20160802143855.<span class="keyword">binlog</span> ..</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line">  Dumping <span class="keyword">binlog</span> <span class="keyword">format</span> description <span class="keyword">event</span>, <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">0</span> <span class="keyword">to</span> <span class="number">323.</span>. ok.</div><div class="line">  Dumping effective <span class="keyword">binlog</span> <span class="keyword">data</span> <span class="keyword">from</span> /<span class="keyword">data</span>/mysql_data/host_2_name-relay-<span class="keyword">bin</span><span class="number">.000003</span> <span class="keyword">position</span> <span class="number">39726380</span> <span class="keyword">to</span> tail(<span class="number">39726561</span>).. ok.</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> <span class="keyword">Concat</span> succeeded.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> the target <span class="keyword">slave</span> host host_2, running recover script..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">39</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_2 --slave_ip=host_2  --slave_port=3306 --apply_files=/var/log/masterha/app1/relay_from_exec_to_read_host_2_3306_20160802143855.binlog,/var/log/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.binlog,/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog --workdir=/var/log/masterha/app1 --target_version=5.7.13-log --timestamp=20160802143855 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">11</span> <span class="number">2016</span> - [info]</div><div class="line"> <span class="keyword">Concat</span> <span class="keyword">all</span> apply files <span class="keyword">to</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/total_binlog_for_host_2_3306<span class="number">.20160802143855</span>.<span class="keyword">binlog</span> ..</div><div class="line"> Copying the <span class="keyword">first</span> <span class="keyword">binlog</span> file /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_exec_to_read_host_2_3306_20160802143855.<span class="keyword">binlog</span> <span class="keyword">to</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/total_binlog_for_host_2_3306<span class="number">.20160802143855</span>.<span class="keyword">binlog</span>.. ok.</div><div class="line">  Dumping <span class="keyword">binlog</span> head <span class="keyword">events</span> (rotate <span class="keyword">events</span>), skipping <span class="keyword">format</span> description <span class="keyword">events</span> <span class="keyword">from</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.<span class="keyword">binlog</span>..  <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line"> <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line">dumped up <span class="keyword">to</span> pos <span class="number">323.</span> ok.</div><div class="line"> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.<span class="keyword">binlog</span> has effective <span class="keyword">binlog</span> <span class="keyword">events</span> <span class="keyword">from</span> pos <span class="number">323.</span></div><div class="line">  Dumping effective <span class="keyword">binlog</span> <span class="keyword">data</span> <span class="keyword">from</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.<span class="keyword">binlog</span> <span class="keyword">position</span> <span class="number">323</span> <span class="keyword">to</span> tail(<span class="number">179091707</span>).. ok.</div><div class="line">  Dumping <span class="keyword">binlog</span> head <span class="keyword">events</span> (rotate <span class="keyword">events</span>), skipping <span class="keyword">format</span> description <span class="keyword">events</span> <span class="keyword">from</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span>..  <span class="keyword">Binlog</span> <span class="keyword">Checksum</span> enabled</div><div class="line">dumped up <span class="keyword">to</span> pos <span class="number">154.</span> ok.</div><div class="line"> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> has effective <span class="keyword">binlog</span> <span class="keyword">events</span> <span class="keyword">from</span> pos <span class="number">154.</span></div><div class="line">  Dumping effective <span class="keyword">binlog</span> <span class="keyword">data</span> <span class="keyword">from</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> <span class="keyword">position</span> <span class="number">154</span> <span class="keyword">to</span> tail(<span class="number">725</span>).. ok.</div><div class="line"> <span class="keyword">Concat</span> succeeded.</div><div class="line"><span class="keyword">All</span> apply target <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> concatinated <span class="keyword">at</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/total_binlog_for_host_2_3306<span class="number">.20160802143855</span>.<span class="keyword">binlog</span> .</div><div class="line">MySQL client <span class="keyword">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. <span class="keyword">Using</span> <span class="comment">--binary-mode.</span></div><div class="line">Applying differential <span class="built_in">binary</span>/relay <span class="keyword">log</span> files /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_exec_to_read_host_2_3306_20160802143855.<span class="keyword">binlog</span>,/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/relay_from_read_to_latest_host_2_3306_20160802143855.<span class="keyword">binlog</span>,/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> <span class="keyword">on</span> host_2:<span class="number">3306.</span> This may take long <span class="keyword">time</span>...</div><div class="line">Applying <span class="keyword">log</span> files succeeded.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">11</span> <span class="number">2016</span> - [info]  <span class="keyword">All</span> relay <span class="keyword">logs</span> were successfully applied.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">11</span> <span class="number">2016</span> - [info] Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..</span></div><div class="line">Tue Aug  2 14:42:11 2016 - [info]  host_2_name.000001:217647730</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_2<span class="string">', MASTER_PORT=3306, MASTER_LOG_FILE='</span>host_2_name<span class="number">.000001</span><span class="string">', MASTER_LOG_POS=217647730, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></div><div class="line">Tue Aug  2 14:42:11 2016 - [info] Executing master IP activate script:</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]   /home/mysql/MHA/masterha/master_ip_failover --command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba<span class="string">' --new_master_password='</span>dba<span class="string">'</span></div><div class="line">Set read_only=0 on the new master.</div><div class="line">No need to Creating app user on the new master..</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]  OK.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] ** Finished master recovery successfully.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] * Phase 3: Master Recovery Phase completed.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] * Phase 4: Slaves Recovery Phase..</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] * Phase 4.1: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] -- Slave diff file generation on host host_3(host_3:3306) started, pid: 22541. Check tmp log /var/log/masterha/app1/host_3_3306_20160802143855.log if it takes time..</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] Log messages from host_3 ...</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]  This server has all relay logs. No need to generate diff files from the latest slave.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] End of log messages from host_3.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] -- host_3(host_3:3306) has the latest relay log events.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] Generating relay diff files from the latest slave succeeded.</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] * Phase 4.2: Starting Parallel Slave Log Apply Phase..</div><div class="line">Tue Aug  2 14:42:11 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] -- Slave recovery on host host_3(host_3:3306) started, pid: 22543. Check tmp log /var/log/masterha/app1/host_3_3306_20160802143855.log if it takes time..</div><div class="line">saved_master_binlog_from_host_1_3306_20160802143855.binlog                                                           100%  725     0.7KB/s   00:00</div><div class="line">Tue Aug  2 14:42:12 2016 - [info]</div><div class="line">Tue Aug  2 14:42:12 2016 - [info] Log messages from host_3 ...</div><div class="line">Tue Aug  2 14:42:12 2016 - [info]</div><div class="line">Tue Aug  2 14:42:11 2016 - [info] Sending binlog..</div><div class="line">Tue Aug  2 14:42:12 2016 - [info] scp from local:/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog to root@host_3:/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog succeeded.</div><div class="line">Tue Aug  2 14:42:12 2016 - [info] Starting recovery on host_3(host_3:3306)..</div><div class="line">Tue Aug  2 14:42:12 2016 - [info]  Generating diffs succeeded.</div><div class="line">Tue Aug  2 14:42:12 2016 - [info] Waiting until all relay logs are applied.</div><div class="line">Tue Aug  2 14:42:12 2016 - [info]  done.</div><div class="line">Tue Aug  2 14:42:12 2016 - [info] Getting slave status..</div><div class="line">Tue Aug  2 14:42:12 2016 - [info] This slave(host_3)'s Exec_Master_Log_Pos equals <span class="keyword">to</span> Read_Master_Log_Pos(host_1_name<span class="number">.000002</span>:<span class="number">576864</span>). <span class="keyword">No</span> need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> the target <span class="keyword">slave</span> host host_3, running recover script..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_3 --slave_ip=host_3  --slave_port=3306 --apply_files=/var/log/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.binlog --workdir=/var/log/masterha/app1 --target_version=5.7.13-log --timestamp=20160802143855 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]</div><div class="line">MySQL client <span class="keyword">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. <span class="keyword">Using</span> <span class="comment">--binary-mode.</span></div><div class="line">Applying differential <span class="built_in">binary</span>/relay <span class="keyword">log</span> files /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/saved_master_binlog_from_host_1_3306_20160802143855.<span class="keyword">binlog</span> <span class="keyword">on</span> host_3:<span class="number">3306.</span> This may take long <span class="keyword">time</span>...</div><div class="line">Applying <span class="keyword">log</span> files succeeded.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]  <span class="keyword">All</span> relay <span class="keyword">logs</span> were successfully applied.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]  Resetting <span class="keyword">slave</span> host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> <span class="keyword">starting</span> replication <span class="keyword">from</span> the new <span class="keyword">master</span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]  Executed <span class="keyword">CHANGE</span> <span class="keyword">MASTER</span>.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]  <span class="keyword">Slave</span> started.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] <span class="keyword">All</span> new <span class="keyword">slave</span> servers recovered successfully.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] * Phase <span class="number">5</span>: New <span class="keyword">master</span> cleanup phase..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] Resetting <span class="keyword">slave</span> info <span class="keyword">on</span> the new <span class="keyword">master</span>..</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]  host_2: Resetting <span class="keyword">slave</span> info succeeded.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info] <span class="keyword">Master</span> failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Tue Aug  <span class="number">2</span> <span class="number">14</span>:<span class="number">42</span>:<span class="number">12</span> <span class="number">2016</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">app1: MySQL <span class="keyword">Master</span> failover host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line"><span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> host_manager_name <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started manual(interactive) failover.</div><div class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest <span class="keyword">slave</span> host_3(host_3:<span class="number">3306</span>) has <span class="keyword">all</span> relay <span class="keyword">logs</span> <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new <span class="keyword">master</span>.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated <span class="keyword">master</span> IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has the latest relay <span class="keyword">log</span> <span class="keyword">events</span>.</div><div class="line">Generating relay diff files <span class="keyword">from</span> the latest <span class="keyword">slave</span> succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded. <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting <span class="keyword">slave</span> info succeeded.</div><div class="line"><span class="keyword">Master</span> failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-8_[用例测试]_Master_没挂，但是MySQL_slave_服务_down掉，是否自动failover">4.8 [用例测试] Master 没挂，但是MySQL slave 服务 down掉，是否自动failover</h2>
<ul>
<li>MySQL slave down掉，不会自动failover</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">* MHA 只会监控master的状态，只有master挂了，才会自动failover  </div><div class="line"></div><div class="line">[info] Ping(<span class="keyword">SELECT</span>) succeeded, waiting <span class="keyword">until</span> MySQL doesn<span class="comment">'t respond..</span></div></pre></td></tr></table></figure>

<ul>
<li>master没挂，其他slave的错误，都不会导致自动failover</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">&gt; 10. [用例测试] MySQL slave IO/SQL线程 stop，是否自动failover    </span></span></div><div class="line">&gt; <span class="number">11</span>. [用例测试] <span class="constant">MySQL</span> slave <span class="constant">IO</span>/<span class="constant">SQL</span>线程 报错，是否自动failover</div></pre></td></tr></table></figure>

<h2 id="4-9_[用例测试]_Master_挂了，但是MySQL_slave_有问题，是否自动failover">4.9 [用例测试] Master 挂了，但是MySQL slave 有问题，是否自动failover</h2>
<blockquote>
<p> MySQL slave IO/SQL线程 stop<br> MySQL slave IO/SQL线程 延迟很多  </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动让某台slave stop slave  ，然后再让master 挂掉  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">某台slave&gt;</span> stop slave;</span></div><div class="line">master&gt; shutdown mysql;</div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志，观察情况  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">* </span>如果是slave 停止同步，然后master也挂了，任然会自动failover，不会报错  </div><div class="line"><span class="bullet">* </span>如果是slave 延迟严重，然后master也挂了，任然会自动failover，不会报错</div></pre></td></tr></table></figure>

<h2 id="4-10_[用例测试]_MySQL_master_有大事务超过100s再执行，是否online_master_switch">4.10 [用例测试] MySQL master 有大事务超过100s再执行，是否online master switch</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动在master上制造大事务</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">master&gt; <span class="keyword">select</span> id , sleep(<span class="number">20</span>) <span class="keyword">from</span> tb <span class="keyword">for</span> update;</div></pre></td></tr></table></figure>

<ul>
<li>step3: 哪种情况MHA会报错  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">* </span>slave 有问题的时候</div><div class="line"> 	IO，sql thread有问题 </div><div class="line"> 	slave 挂了</div><div class="line"> 	slave 延迟太多</div><div class="line"><span class="code">	复制过滤规则不统一  </span></div><div class="line"> 	等等</div><div class="line"> 	</div><div class="line">以上情况，都会导致切换失败</div></pre></td></tr></table></figure>

<ul>
<li>step4：日志如下<blockquote>
<p>如果有大事务，MHA会一直等待，直到事务结束  </p>
</blockquote>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Wed Aug  3 15:33:04 2016 - [info] MHA::MasterRotate version 0.56.</div><div class="line">Wed Aug  3 15:33:04 2016 - [info] Starting online master switch..</div><div class="line">Wed Aug  3 15:33:04 2016 - [info]</div><div class="line">Wed Aug  3 15:33:04 2016 - [info] * Phase 1: Configuration <span class="operator"><span class="keyword">Check</span> Phase..</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">0</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] <span class="keyword">Current</span> Alive <span class="keyword">Master</span>: host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">04</span> <span class="number">2016</span> - [info] Executing <span class="keyword">FLUSH</span> <span class="keyword">NO_WRITE_TO_BINLOG</span> <span class="keyword">TABLES</span>. This may take long <span class="keyword">time</span>..</div><div class="line"></div><div class="line">... 一直等待  ...</div></pre></td></tr></table></figure>

<h2 id="4-11_[用例测试]_MySQL_master_网络断掉">4.11 [用例测试] MySQL master 网络断掉</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造master网络不通的情况  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">* MASTER 网络断掉，只允许host_monitor的22端口访问（便于恢复网络）  </span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor --dprot <span class="number">22</span> -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">* MASTER 恢复网络</div><div class="line">master&gt; service iptables restart</div></pre></td></tr></table></figure>



<ul>
<li>step3: master的网络不通，观察MHA日志</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">26</span> <span class="number">2016</span> - [warning] Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> MySQL Ping(SELECT) child process <span class="keyword">and</span> killed <span class="keyword">it</span>! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">431.</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">26</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">29</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">29</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">31</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">32</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">32</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> NOT reachable.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> a master server failed. Reading configuration <span class="type">file</span> /etc/masterha_default.cnf <span class="keyword">and</span> /etc/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check server status..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Reading default configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Reading <span class="type">application</span> default configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Checking slave configurations..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Checking replication filtering settings..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]  Replication filtering check ok.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Master <span class="keyword">is</span> down!</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Terminating monitoring <span class="keyword">script</span>.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (Master dead).</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Starting master failover.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">35</span> <span class="number">2016</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln309] Last failover was done <span class="keyword">at</span> <span class="number">2016</span>/<span class="number">08</span>/<span class="number">03</span> <span class="number">16</span>:<span class="number">07</span>:<span class="number">43.</span> Current <span class="property">time</span> <span class="keyword">is</span> too early <span class="keyword">to</span> do failover again. If you want <span class="keyword">to</span> do failover, manually remove /var/<span class="command">log</span>/masterha/app1/app1.failover.complete <span class="keyword">and</span> <span class="command">run</span> this <span class="keyword">script</span> again.</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">32</span>:<span class="number">36</span> <span class="number">2016</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177] Got ERROR:  <span class="keyword">at</span> /usr/bin/masterha_manager line <span class="number">65</span></div><div class="line"></div><div class="line">* 由于之前做过多次切换，然后时间太短，所以failover终止，但是从这里可以看出，MHA已经检测到网络问题，进行failover动作了</div></pre></td></tr></table></figure>

<h2 id="4-12_[用例测试]_MySQL_master_网路瞬断（1~30秒），是否自动failover">4.12 [用例测试] MySQL master 网路瞬断（1~30秒），是否自动failover</h2>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造master网络不通的情况, 断掉1~10s左右</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt">* MASTER 网络断掉，只允许host_monitor的22端口访问（便于恢复网络）</span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor --dprot <span class="number">22</span> -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line"></div><div class="line">* 1~10秒左右 MASTER 恢复网络</div><div class="line">master&gt; service iptables restart</div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察MHA日志</li>
</ul>
<blockquote>
<p>结论：如果时间非常短，比如1~2秒的网络瞬断，不会failover<br>结论：如果时间比较长，比如：&gt; 5~10秒，那么如果MHA已经判定到Master is not reachable from health checker! 那么，就会进行failover阶段    </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">Wed Aug  3 18:48:35 2016 - [info] Ping(<span class="operator"><span class="keyword">SELECT</span>) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Wed Aug  3 18:48:50 2016 - [warning] Got timeout on MySQL Ping(SELECT) child process and killed it! at /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line 431.</div><div class="line">Wed Aug  3 18:48:50 2016 - [info] Executing SSH check script: save_binary_logs --command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</div><div class="line">Wed Aug  3 18:48:53 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">53</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">2</span> <span class="keyword">time</span>(s)..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">55</span> <span class="number">2016</span> - [warning] HealthCheck: Got timeout <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">56</span> <span class="number">2016</span> - [warning] Got error <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">'t connect to MySQL server on '</span>host_1<span class="string">' (4))</span></div><div class="line">Wed Aug  3 18:48:56 2016 - [warning] Connection failed 3 time(s)..</div><div class="line">Wed Aug  3 18:48:59 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">4</span> <span class="keyword">time</span>(s)..</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Wed Aug  <span class="number">3</span> <span class="number">18</span>:<span class="number">48</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> <span class="keyword">NOT</span> reachable.</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">app1: MySQL <span class="keyword">Master</span> failover host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line"><span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> host_manager_name:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/app1.<span class="keyword">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest <span class="keyword">slave</span> host_2(host_2:<span class="number">3306</span>) has <span class="keyword">all</span> relay <span class="keyword">logs</span> <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new <span class="keyword">master</span>.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated <span class="keyword">master</span> IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has the latest relay <span class="keyword">log</span> <span class="keyword">events</span>.</div><div class="line">Generating relay diff files <span class="keyword">from</span> the latest <span class="keyword">slave</span> succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded. <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting <span class="keyword">slave</span> info succeeded.</div><div class="line"><span class="keyword">Master</span> failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试0_（没有二次检测的机制）">4.14 [用例测试] 多段网络测试0 （没有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 正常 —&gt; S1 &lt;— 正常 —&gt; master<br>Manager &lt;— 正常 —&gt; S2 &lt;— 正常 —&gt; master   </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_2  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_3  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 检查日志</li>
</ul>
<blockquote>
<p>已经发生failover   </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">app1: MySQL Master failover host_1(host_1:3306) to host_2(host_2:3306) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:3306) is down!</div><div class="line"></div><div class="line"><span class="operator"><span class="keyword">Check</span> MHA Manager <span class="keyword">logs</span> <span class="keyword">at</span> host_manager_name:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/app1/app1.<span class="keyword">log</span> <span class="keyword">for</span> details.</span></div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated <span class="keyword">master</span> IP address <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest <span class="keyword">slave</span> host_2(host_2:<span class="number">3306</span>) has <span class="keyword">all</span> relay <span class="keyword">logs</span> <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new <span class="keyword">master</span>.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated <span class="keyword">master</span> IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has the latest relay <span class="keyword">log</span> <span class="keyword">events</span>.</div><div class="line">Generating relay diff files <span class="keyword">from</span> the latest <span class="keyword">slave</span> succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> <span class="keyword">logs</span> succeeded. <span class="keyword">Slave</span> started, replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting <span class="keyword">slave</span> info succeeded.</div><div class="line"><span class="keyword">Master</span> failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试1_（有二次检测的机制）">4.14 [用例测试] 多段网络测试1 （有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 正常 —&gt; S1 &lt;— 正常 —&gt; master<br>Manager &lt;— 正常 —&gt; S2 &lt;— 正常 —&gt; master         </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf --last_failover_minute=1 &</span></div><div class="line"></div><div class="line">* 二次检测</div><div class="line">	secondary_check_script= masterha_secondary_check -s host_2 -s host_3</div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_2  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_3  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>结论： 因为二次检查可以通过，所以MHA认为master没有挂，没有failover，但是在一直循环检测中<br>结论： 只要有二次检测，那么只要有一个别的server可以连通master，那么就会认为master没有挂，就不会failover  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">24</span> <span class="number">2016</span> - [info] Ping(SELECT) succeeded, waiting <span class="keyword">until</span> MySQL doesn't respond..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">16</span>:<span class="number">24</span> <span class="number">2016</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">06</span> <span class="number">2016</span> - [warning] Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> MySQL Ping(SELECT) child process <span class="keyword">and</span> killed <span class="keyword">it</span>! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">431.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Master <span class="keyword">is</span> reachable <span class="keyword">from</span> host_2!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">07</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> least one <span class="keyword">of</span> other monitoring servers. Failover should <span class="keyword">not</span> happen.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">09</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">09</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">11</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">12</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">12</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">15</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">15</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">15</span> <span class="number">2016</span> - [warning] Secondary network check <span class="keyword">script</span> returned errors. Failover should <span class="keyword">not</span> start so checking server status again. Check network settings <span class="keyword">for</span> details.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">18</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">18</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">1</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">19</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">19</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Master <span class="keyword">is</span> reachable <span class="keyword">from</span> host_2!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">19</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> least one <span class="keyword">of</span> other monitoring servers. Failover should <span class="keyword">not</span> happen.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">22</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">22</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">24</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">25</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">28</span> <span class="number">2016</span> - [warning] Secondary network check <span class="keyword">script</span> returned errors. Failover should <span class="keyword">not</span> start so checking server status again. Check network settings <span class="keyword">for</span> details.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">31</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">31</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">1</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">17</span>:<span class="number">31</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Master <span class="keyword">is</span> reachable <span class="keyword">from</span> host_2!</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试2_（有二次检测的机制）">4.14 [用例测试] 多段网络测试2 （有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 正常 —&gt; S1 &lt;— 不通 —&gt; master<br>Manager &lt;— 正常 —&gt; S2 &lt;— 正常 —&gt; master  </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_3  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>结论： 因为二次检查可以通过，所以MHA认为master没有挂，没有failover，但是在一直循环检测中<br>结论： 只要有二次检测，那么只要有一个别的server可以连通master，那么就会认为master没有挂，就不会failover  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div></pre></td><td class="code"><pre><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">32</span>:<span class="number">27</span> <span class="number">2016</span> - [info] Starting ping health check <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">32</span>:<span class="number">27</span> <span class="number">2016</span> - [info] Ping(SELECT) succeeded, waiting <span class="keyword">until</span> MySQL doesn't respond..</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">30</span> <span class="number">2016</span> - [warning] Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> MySQL Ping(SELECT) child process <span class="keyword">and</span> killed <span class="keyword">it</span>! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">431.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">30</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">33</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Monitoring server host_2 <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> host_2. OK.</div><div class="line">Master <span class="keyword">is</span> reachable <span class="keyword">from</span> host_3!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">35</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> least one <span class="keyword">of</span> other monitoring servers. Failover should <span class="keyword">not</span> happen.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">36</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">36</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">39</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">39</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">39</span> <span class="number">2016</span> - [warning] Secondary network check <span class="keyword">script</span> returned errors. Failover should <span class="keyword">not</span> start so checking server status again. Check network settings <span class="keyword">for</span> details.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">42</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">42</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">1</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">42</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">42</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">45</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">45</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">47</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Monitoring server host_2 <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> host_2. OK.</div><div class="line">Master <span class="keyword">is</span> reachable <span class="keyword">from</span> host_3!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">47</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> least one <span class="keyword">of</span> other monitoring servers. Failover should <span class="keyword">not</span> happen.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">48</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">48</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] Secondary network check <span class="keyword">script</span> returned errors. Failover should <span class="keyword">not</span> start so checking server status again. Check network settings <span class="keyword">for</span> details.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">54</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">54</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">1</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">54</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">54</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">57</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">57</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">33</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Monitoring server host_2 <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> host_2. OK.</div><div class="line">Master <span class="keyword">is</span> reachable <span class="keyword">from</span> host_3!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">34</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> reachable <span class="keyword">from</span> <span class="keyword">at</span> least one <span class="keyword">of</span> other monitoring servers. Failover should <span class="keyword">not</span> happen.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">34</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">34</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试3_（有二次检测的机制）">4.14 [用例测试] 多段网络测试3 （有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 正常 —&gt; S1 &lt;— 不通 —&gt; master<br>Manager &lt;— 正常 —&gt; S2 &lt;— 不通 —&gt; master  </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>由于都不通，那么会failover  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2016</span> - [warning] Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> MySQL Ping(SELECT) child process <span class="keyword">and</span> killed <span class="keyword">it</span>! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">431.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">56</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">27</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">01</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Monitoring server host_2 <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> host_2. OK.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">02</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">02</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">05</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">05</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Monitoring server host_3 <span class="keyword">is</span> reachable, Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> host_3. OK.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> all other monitoring servers. Failover should start.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [warning] Master <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [warning] Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> NOT reachable.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> a master server failed. Reading configuration <span class="type">file</span> /etc/masterha_default.cnf <span class="keyword">and</span> /etc/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> connect <span class="keyword">to</span> all servers <span class="keyword">to</span> check server status..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Reading default configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Reading <span class="type">application</span> default configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Reading server configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Checking slave configurations..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Checking replication filtering settings..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]  Replication filtering check ok.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Master <span class="keyword">is</span> down!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Terminating monitoring <span class="keyword">script</span>.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Got <span class="keyword">exit</span> code <span class="number">20</span> (Master dead).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] Starting master failover.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">06</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">07</span> <span class="number">2016</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">07</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">07</span> <span class="number">2016</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Starting Non-GTID based failover.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stop</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_1_name<span class="number">.000001</span>:<span class="number">154</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_1_name<span class="number">.000001</span>:<span class="number">154</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [warning] Dead Master <span class="keyword">is</span> <span class="keyword">not</span> SSH reachable. Could <span class="keyword">not</span> save <span class="keyword">it</span>'s binlogs. Transactions <span class="keyword">that</span> were <span class="keyword">not</span> sent <span class="keyword">to</span> <span class="keyword">the</span> latest slave (Read_Master_Log_Pos <span class="keyword">to</span> <span class="keyword">the</span> tail <span class="keyword">of</span> <span class="keyword">the</span> dead master's binlog) were lost.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Finding <span class="keyword">the</span> latest slave <span class="keyword">that</span> has all relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] All slaves received relay logs <span class="keyword">to</span> <span class="keyword">the</span> same position. No need <span class="keyword">to</span> resync each other.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  Non-candidate masters:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] New master <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Starting master failover..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">From:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] *NOTICE: If any <span class="keyword">error</span> happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  This server has all relay logs. Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  host_2_name<span class="number">.000001</span>:<span class="number">154</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_2', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='host_2_name<span class="number">.000001</span>', MASTER_LOG_POS=<span class="number">154</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Set read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master.</div><div class="line">No need <span class="keyword">to</span> Creating app user <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  OK.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] ** Finished master recovery successfully.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 3964. Check tmp log /var/log/masterha/app1/host_3_3306_20160805102806.log if it takes time..</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] <span class="comment">-- host_3(host_3:3306) has the latest relay log events.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 3966. Check tmp log /var/log/masterha/app1/host_3_3306_20160805102806.log if it takes time..</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  This server has all relay logs. Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  All relay logs were successfully applied.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  Slave started.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] All new slave servers recovered successfully.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]  host_2: Resetting slave info succeeded.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info] Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">28</span>:<span class="number">08</span> <span class="number">2016</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">app1: MySQL Master failover host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> host_manager_name:/var/<span class="command">log</span>/masterha/app1/app1.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest slave host_2(host_2:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has <span class="keyword">the</span> latest relay <span class="command">log</span> events.</div><div class="line">Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试4_（没有二次检测的机制）">4.14 [用例测试] 多段网络测试4 （没有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 不通 —&gt; S1  &lt;— 正常 —&gt; master<br>Manager &lt;— 不通 —&gt; S2  &lt;— 正常 —&gt; master   </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_2  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_3  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s1&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s1&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_1  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">s1&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s2&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s2&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_1  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">s2&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>结论：因为master不通，其他slave也不通，那么没有存活的slave，也就不会failover了  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">Fri Aug  5 10:39:39 2016 - [info] Checking master_ip_failover_script status:</div><div class="line">Fri Aug  5 10:39:39 2016 - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--command=status --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306</span></div><div class="line">Fri Aug  5 10:39:39 2016 - [info]  OK.</div><div class="line">Fri Aug  5 10:39:39 2016 - [warning] shutdown_script is not defined.</div><div class="line">Fri Aug  5 10:39:39 2016 - [info] <span class="operator"><span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2016</span> - [warning] secondary_check_script <span class="keyword">is</span> <span class="keyword">not</span> defined. It <span class="keyword">is</span> highly recommended setting it <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">master</span> reachability <span class="keyword">from</span> two <span class="keyword">or</span> more routes.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2016</span> - [info] Ping(<span class="keyword">SELECT</span>) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></div><div class="line">Fri Aug  5 10:41:51 2016 - [warning] Got timeout on MySQL Ping(SELECT) child process and killed it! at /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line 431.</div><div class="line">Fri Aug  5 10:41:51 2016 - [info] Executing SSH check script: save_binary_logs --command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</div><div class="line">Fri Aug  5 10:41:54 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">54</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">2</span> <span class="keyword">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">56</span> <span class="number">2016</span> - [warning] HealthCheck: Got timeout <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">41</span>:<span class="number">57</span> <span class="number">2016</span> - [warning] Got error <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">'t connect to MySQL server on '</span>host_1<span class="string">' (4))</span></div><div class="line">Fri Aug  5 10:41:57 2016 - [warning] Connection failed 3 time(s)..</div><div class="line">Fri Aug  5 10:42:00 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">4</span> <span class="keyword">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> <span class="keyword">NOT</span> reachable.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> a <span class="keyword">master</span> <span class="keyword">server</span> failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">all</span> servers <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">server</span> <span class="keyword">status</span>..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">00</span> <span class="number">2016</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">42</span>:<span class="number">08</span> <span class="number">2016</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/ServerManager.pm, ln188] There <span class="keyword">is</span> <span class="keyword">no</span> alive <span class="keyword">server</span>. We can<span class="string">'t do failover</span></div><div class="line">Fri Aug  5 10:42:08 2016 - [warning] Got Error:  at /usr/share/perl5/vendor_perl/MHA/MasterMonitor.pm line 558</div><div class="line">Fri Aug  5 10:42:08 2016 - [info] Got exit code 1 (Not master dead).</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试5_（有二次检测的机制）">4.14 [用例测试] 多段网络测试5 （有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 不通 —&gt; S1  &lt;— 正常 —&gt; master<br>Manager &lt;— 不通 —&gt; S2  &lt;— 正常 —&gt; master  </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_2  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_3  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s1&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s1&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_1  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">s1&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s2&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s2&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_1  -j <span class="constant">ACCEPT</span></span></div><div class="line"><span class="input"><span class="prompt">s2&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>Monitoring server host_2 is NOT reachable!<br>只要monitor 服务器，有一台不通，那么就不会failover，MHA manager会认为这是网络故障  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">47</span>:<span class="number">41</span> <span class="number">2016</span> - [info] Ping(SELECT) succeeded, waiting <span class="keyword">until</span> MySQL doesn't respond..</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">50</span> <span class="number">2016</span> - [warning] Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> MySQL Ping(SELECT) child process <span class="keyword">and</span> killed <span class="keyword">it</span>! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">431.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">50</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">50</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">53</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">53</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">55</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">ssh: connect <span class="keyword">to</span> host host_2 port <span class="number">22</span>: Connection timed out</div><div class="line">Monitoring server host_2 <span class="keyword">is</span> NOT reachable!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">55</span> <span class="number">2016</span> - [warning] At least one <span class="keyword">of</span> monitoring servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this <span class="keyword">script</span>. This <span class="keyword">is</span> likely a network problem. Failover should <span class="keyword">not</span> happen.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">56</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">56</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">3</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">4</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">55</span>:<span class="number">59</span> <span class="number">2016</span> - [warning] Secondary network check <span class="keyword">script</span> returned errors. Failover should <span class="keyword">not</span> start so checking server status again. Check network settings <span class="keyword">for</span> details.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">02</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">02</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">1</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">02</span> <span class="number">2016</span> - [info] Executing secondary network check <span class="keyword">script</span>: masterha_secondary_check -s host_2 -s host_3  <span class="comment">--user=root  --master_host=host_1  --master_ip=host_1  --master_port=3306 --master_user=dba --master_password=dba --ping_type=SELECT</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">02</span> <span class="number">2016</span> - [info] Executing SSH check <span class="keyword">script</span>: save_binary_logs <span class="comment">--command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">05</span> <span class="number">2016</span> - [warning] Got <span class="keyword">error</span> <span class="function_start"><span class="keyword">on</span></span> MySQL connect: <span class="number">2003</span> (Can't connect <span class="keyword">to</span> MySQL server <span class="function_start"><span class="keyword">on</span></span> 'host_1' (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">05</span> <span class="number">2016</span> - [warning] Connection failed <span class="number">2</span> <span class="property">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">07</span> <span class="number">2016</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">ssh: connect <span class="keyword">to</span> host host_2 port <span class="number">22</span>: Connection timed out</div><div class="line">Monitoring server host_2 <span class="keyword">is</span> NOT reachable!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">10</span>:<span class="number">56</span>:<span class="number">07</span> <span class="number">2016</span> - [warning] At least one <span class="keyword">of</span> monitoring servers <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> this <span class="keyword">script</span>. This <span class="keyword">is</span> likely a network problem. Failover should <span class="keyword">not</span> happen.</div></pre></td></tr></table></figure>

<h2 id="4-14_[用例测试]_多段网络测试6_（没有二次检测的机制）">4.14 [用例测试] 多段网络测试6 （没有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 不通 —&gt; S1  &lt;— 不通 —&gt; master<br>Manager &lt;— 不通 —&gt; S2  &lt;— 不通 —&gt; master  </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s1&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s1&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s2&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s2&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>由于都不通，所以不会failover  </p>
</blockquote>
<h2 id="4-14_[用例测试]_多段网络测试7_（有二次检测的机制）">4.14 [用例测试] 多段网络测试7 （有二次检测的机制）</h2>
<blockquote>
<p>Manager &lt;— 不通 —&gt; Master<br>Manager &lt;— 不通 —&gt; S1  &lt;— 不通 —&gt; master<br>Manager &lt;— 不通 —&gt; S2  &lt;— 不通 —&gt; master  </p>
</blockquote>
<ul>
<li>step1: 检查各种MHA manager的各种环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">* 检查SSH</div><div class="line">    masterha_check_ssh <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 检查复制(如果是非GTID模式，slave如果没有设置relay_log_purge=<span class="number">0</span>，那么会有警告)</div><div class="line">    masterha_check_repl <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_2(host_2:<span class="number">3306</span>).</div><div class="line">        Thu Jul <span class="number">28</span> <span class="number">14</span>:<span class="number">03</span>:<span class="number">33</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="function_start"><span class="keyword">on</span></span> slave host_3(host_3:<span class="number">3306</span>).</div><div class="line"></div><div class="line">* 检查mha状态</div><div class="line">    masterha_check_status <span class="comment">--conf=/etc/app1.cnf</span></div><div class="line"></div><div class="line">* 开启mha 监控</div><div class="line">    nohup masterha_manager <span class="comment">--conf=/etc/app1.cnf &</span></div></pre></td></tr></table></figure>

<ul>
<li>step2: 手动制造上述网络故障</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">master&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">master&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s1&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s1&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div><div class="line"><span class="input"><span class="prompt"></span></span></div><div class="line">s2&gt; iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s host_monitor  -j <span class="constant">ACCEPT</span></div><div class="line"><span class="input"><span class="prompt">s2&gt;</span> iptables -<span class="constant">A</span> <span class="constant">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="constant">DROP</span></span></div></pre></td></tr></table></figure>

<ul>
<li>step3: 观察日志</li>
</ul>
<blockquote>
<p>由于都不通，所以不会failover  </p>
</blockquote>
<h2 id="4-15_[用例测试]_Non-GTID模式下，需要relay-log吗？是否能够成功的补齐日志">4.15 [用例测试] Non-GTID模式下，需要relay-log吗？是否能够成功的补齐日志</h2>
<blockquote>
<p>如果没有足够的relay-log，在恢复的时候，会报错的<br>在生产差异relay log的时候发现没有足够的日志，所以就报错，不会failover  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">Fri Aug  5 11:09:51 2016 - [info] Ping(<span class="operator"><span class="keyword">SELECT</span>) succeeded, waiting until MySQL doesn<span class="string">'t respond..</span></span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">Fri Aug  5 11:10:42 2016 - [warning] Got timeout on MySQL Ping(SELECT) child process and killed it! at /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line 431.</div><div class="line">Fri Aug  5 11:10:42 2016 - [info] Executing SSH check script: save_binary_logs --command=test --start_pos=4 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/app1/save_binary_logs_test --manager_version=0.56 --binlog_prefix=host_1_name</div><div class="line">Fri Aug  5 11:10:45 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">45</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">2</span> <span class="keyword">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">47</span> <span class="number">2016</span> - [warning] HealthCheck: Got timeout <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">48</span> <span class="number">2016</span> - [warning] Got error <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">'t connect to MySQL server on '</span>host_1<span class="string">' (4))</span></div><div class="line">Fri Aug  5 11:10:48 2016 - [warning] Connection failed 3 time(s)..</div><div class="line">Fri Aug  5 11:10:51 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">4</span> <span class="keyword">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> <span class="keyword">NOT</span> reachable.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> a <span class="keyword">master</span> <span class="keyword">server</span> failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">all</span> servers <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">server</span> <span class="keyword">status</span>..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">0</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Checking <span class="keyword">slave</span> configurations..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> host_2(host_2:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> host_2(host_2:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]  read_only=<span class="number">1</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> host_3(host_3:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning]  relay_log_purge=<span class="number">0</span> <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span> <span class="keyword">on</span> <span class="keyword">slave</span> host_3(host_3:<span class="number">3306</span>).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Checking replication filtering settings..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]  Replication filtering <span class="keyword">check</span> ok.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> down!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Terminating monitoring script.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Got exit code <span class="number">20</span> (<span class="keyword">Master</span> dead).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] MHA::MasterFailover <span class="keyword">version</span> <span class="number">0.56</span>.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">0</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">51</span> <span class="number">2016</span> - [info] Checking <span class="keyword">master</span> reachability via MySQL(<span class="keyword">double</span> <span class="keyword">check</span>)...</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]  <span class="keyword">Starting</span> <span class="keyword">SQL</span> thread <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> Non-GTID based failover.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] Forcing shutdown so that applications never <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> <span class="keyword">master</span>..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">52</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stop</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> the dead <span class="keyword">master</span>.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000001</span>:<span class="number">32925754</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000001</span>:<span class="number">2093512</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead <span class="keyword">Master</span><span class="string">'s Binlog Phase..</span></div><div class="line">Fri Aug  5 11:10:53 2016 - [info]</div><div class="line">Fri Aug  5 11:10:53 2016 - [warning] Dead Master is not SSH reachable. Could not save it's binlogs. Transactions that were <span class="keyword">not</span> sent <span class="keyword">to</span> the latest <span class="keyword">slave</span> (Read_Master_Log_Pos <span class="keyword">to</span> the tail <span class="keyword">of</span> the dead <span class="keyword">master</span><span class="string">'s binlog) were lost.</span></div><div class="line">Fri Aug  5 11:10:53 2016 - [info]</div><div class="line">Fri Aug  5 11:10:53 2016 - [info] * Phase 3.3: Determining New Master Phase..</div><div class="line">Fri Aug  5 11:10:53 2016 - [info]</div><div class="line">Fri Aug  5 11:10:53 2016 - [info] Finding the latest slave that has all relay logs for recovering other slaves..</div><div class="line">Fri Aug  5 11:10:53 2016 - [info] HealthCheck: SSH to host_2 is reachable.</div><div class="line">Fri Aug  5 11:10:53 2016 - [info] Checking whether host_2 has relay logs from the oldest position..</div><div class="line">Fri Aug  5 11:10:53 2016 - [info] Executing command: apply_diff_relay_logs --command=find --latest_mlf=host_1_name.000001 --latest_rmlp=32925754 --target_mlf=host_1_name.000001 --target_rmlp=2093512 --server_id=12616506 --workdir=/var/log/masterha/app1 --timestamp=20160805111051 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_2_name-relay-bin.000008  :</div><div class="line">    Relay log found at /data/mysql_data, up to host_2_name-relay-bin.000008</div><div class="line"> Fast relay log position search failed. Reading relay logs to find..</div><div class="line">Reading host_2_name-relay-bin.000008</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Master Version is 5.7.13-log</div><div class="line"> Binlog Checksum enabled</div><div class="line"> host_2_name-relay-bin.000008 contains master host_1_name.000001 from position 26175199</div><div class="line">Reading host_2_name-relay-bin.000007</div><div class="line"> Binlog Checksum enabled</div><div class="line"> host_2_name-relay-bin.000007 contains master host_1_name.000001 from position 12184106</div><div class="line">Reading host_2_name-relay-bin.000006</div><div class="line">No such file or directory:/data/mysql_data/host_2_name-relay-bin.000006 at /usr/share/perl5/vendor_perl/MHA/BinlogPosFindManager.pm line 102</div><div class="line">Fri Aug  5 11:10:53 2016 - [warning] host_2 doesn't have <span class="keyword">all</span> relay <span class="keyword">logs</span>. Maybe <span class="keyword">some</span> <span class="keyword">logs</span> were purged.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">11</span>:<span class="number">10</span>:<span class="number">53</span> <span class="number">2016</span> - [warning] None <span class="keyword">of</span> latest servers have enough relay <span class="keyword">logs</span> <span class="keyword">from</span> oldest <span class="keyword">position</span>. We can<span class="string">'t recover oldest slaves.</span></div><div class="line">Fri Aug  5 11:10:53 2016 - [error][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln947] None of the latest slaves has enough relay logs for recovery.</div><div class="line">Fri Aug  5 11:10:53 2016 - [error][/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177] Got ERROR:  at /usr/bin/masterha_manager line 65</div><div class="line">Fri Aug  5 11:10:53 2016 - [info]</div><div class="line"></div><div class="line">----- Failover Report -----</div><div class="line"></div><div class="line">app1: MySQL Master failover host_1(host_1:3306)</div><div class="line"></div><div class="line">Master host_1(host_1:3306) is down!</div><div class="line"></div><div class="line">Check MHA Manager logs at host_manager_name:/var/log/masterha/app1/app1.log for details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address on host_1(host_1:3306)</div><div class="line">None of the latest slaves has enough relay logs for recovery.</div><div class="line">Got Error so couldn't <span class="keyword">continue</span> failover <span class="keyword">from</span> here.</div></pre></td></tr></table></figure>

<h2 id="4-16_[用例测试]_GTID模式下，需要relay-log吗？是否能够成功的补齐日志">4.16 [用例测试] GTID模式下，需要relay-log吗？是否能够成功的补齐日志</h2>
<blockquote>
<p>GTID模式下，不需要relay-log，因为是走新的协议。<br>但是必须打开 binlog，log_slave_updates  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div></pre></td><td class="code"><pre><div class="line">Fri Aug  5 13:32:25 2016 - [info]  OK.</div><div class="line">Fri Aug  5 13:32:25 2016 - [warning] shutdown_script is not defined.</div><div class="line">Fri Aug  5 13:32:25 2016 - [info] <span class="operator"><span class="keyword">Set</span> <span class="keyword">master</span> ping <span class="built_in">interval</span> <span class="number">3</span> seconds.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">25</span> <span class="number">2016</span> - [warning] secondary_check_script <span class="keyword">is</span> <span class="keyword">not</span> defined. It <span class="keyword">is</span> highly recommended setting it <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">master</span> reachability <span class="keyword">from</span> two <span class="keyword">or</span> more routes.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">25</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> ping health <span class="keyword">check</span> <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">28</span> <span class="number">2016</span> - [warning] Got error <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">'t connect to MySQL server on '</span>host_1<span class="string">' (4))</span></div><div class="line">Fri Aug  5 13:32:28 2016 - [warning] Connection failed 1 time(s)..</div><div class="line">Fri Aug  5 13:32:28 2016 - [info] Executing SSH check script: exit 0</div><div class="line">Fri Aug  5 13:32:31 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">31</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">2</span> <span class="keyword">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">33</span> <span class="number">2016</span> - [warning] HealthCheck: Got timeout <span class="keyword">on</span> checking SSH <span class="keyword">connection</span> <span class="keyword">to</span> host_1! <span class="keyword">at</span> /usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">34</span> <span class="number">2016</span> - [warning] Got error <span class="keyword">on</span> MySQL <span class="keyword">connect</span>: <span class="number">2003</span> (Can<span class="string">'t connect to MySQL server on '</span>host_1<span class="string">' (4))</span></div><div class="line">Fri Aug  5 13:32:34 2016 - [warning] Connection failed 3 time(s)..</div><div class="line">Fri Aug  5 13:32:37 2016 - [warning] Got error on MySQL connect: 2003 (Can't <span class="keyword">connect</span> <span class="keyword">to</span> MySQL <span class="keyword">server</span> <span class="keyword">on</span> <span class="string">'host_1'</span> (<span class="number">4</span>))</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [warning] <span class="keyword">Connection</span> failed <span class="number">4</span> <span class="keyword">time</span>(s)..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable <span class="keyword">from</span> health checker!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [warning] <span class="keyword">Master</span> host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> <span class="keyword">not</span> reachable!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [warning] SSH <span class="keyword">is</span> <span class="keyword">NOT</span> reachable.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Connecting <span class="keyword">to</span> a <span class="keyword">master</span> <span class="keyword">server</span> failed. Reading configuration file /etc/masterha_default.cnf <span class="keyword">and</span> /etc/app1.cnf again, <span class="keyword">and</span> trying <span class="keyword">to</span> <span class="keyword">connect</span> <span class="keyword">to</span> <span class="keyword">all</span> servers <span class="keyword">to</span> <span class="keyword">check</span> <span class="keyword">server</span> <span class="keyword">status</span>..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Reading <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/masterha_default.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Reading application <span class="keyword">default</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Reading <span class="keyword">server</span> configuration <span class="keyword">from</span> /etc/app1.cnf..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">1</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Checking <span class="keyword">slave</span> configurations..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Checking replication filtering settings..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]  Replication filtering <span class="keyword">check</span> ok.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] <span class="keyword">Master</span> <span class="keyword">is</span> down!</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Terminating monitoring script.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Got exit code <span class="number">20</span> (<span class="keyword">Master</span> dead).</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] MHA::MasterFailover <span class="keyword">version</span> <span class="number">0.56</span>.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] * Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">1</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Dead Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">37</span> <span class="number">2016</span> - [info] Checking <span class="keyword">master</span> reachability via MySQL(<span class="keyword">double</span> <span class="keyword">check</span>)...</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  ok.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Alive Servers:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Alive Slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  <span class="keyword">Starting</span> <span class="keyword">SQL</span> thread <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> GTID based failover.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Forcing shutdown so that applications never <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> <span class="keyword">master</span>..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   /home/mysql/MHA/masterha/master_ip_failover <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stop</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> the dead <span class="keyword">master</span>.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase completed.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000002</span>:<span class="number">56745425</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">210949</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1_name<span class="number">.000002</span>:<span class="number">517969</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">1925</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Oldest slaves:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: Determining New <span class="keyword">Master</span> Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Searching new <span class="keyword">master</span> <span class="keyword">from</span> slaves..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration file:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_2(host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  Non-candidate masters:</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   host_3(host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> <span class="keyword">events</span>..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] New <span class="keyword">master</span> <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line"><span class="keyword">From</span>:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (<span class="keyword">current</span> <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (new <span class="keyword">master</span>)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] * Phase <span class="number">3.3</span>: New <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied..</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info]   done.</div><div class="line">Fri Aug  <span class="number">5</span> <span class="number">13</span>:<span class="number">32</span>:<span class="number">38</span> <span class="number">2016</span> - [info] Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..</span></div><div class="line">Fri Aug  5 13:32:38 2016 - [info]  host_2_name.000008:10198806</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_2<span class="string">', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></div><div class="line">Fri Aug  5 13:32:38 2016 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set: host_2_name.000008, 10198806, 0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-210949</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] Executing master IP activate script:</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]   /home/mysql/MHA/masterha/master_ip_failover --command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba<span class="string">' --new_master_password='</span>dba<span class="string">'</span></div><div class="line">Set read_only=0 on the new master.</div><div class="line">No need to Creating app user on the new master..</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]  OK.</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] Setting read_only=0 on host_2(host_2:3306)..</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]  ok.</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] ** Finished master recovery successfully.</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] * Phase 3: Master Recovery Phase completed.</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] * Phase 4: Slaves Recovery Phase..</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] * Phase 4.1: Starting Slaves in parallel..</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]</div><div class="line">Fri Aug  5 13:32:38 2016 - [info] -- Slave recovery on host host_3(host_3:3306) started, pid: 22029. Check tmp log /var/log/masterha/app1/host_3_3306_20160805133237.log if it takes time..</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] Log messages from host_3 ...</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]  Resetting slave host_3(host_3:3306) and starting replication from the new master host_2(host_2:3306)..</div><div class="line">Fri Aug  5 13:32:38 2016 - [info]  Executed CHANGE MASTER.</div><div class="line">Fri Aug  5 13:32:39 2016 - [info]  Slave started.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]  gtid_wait(0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-210949) completed on host_3(host_3:3306). Executed 206170 events.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] End of log messages from host_3.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] -- Slave on host host_3(host_3:3306) started.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] All new slave servers recovered successfully.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] * Phase 5: New master cleanup phase..</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] Resetting slave info on the new master..</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]  host_2: Resetting slave info succeeded.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info] Master failover to host_2(host_2:3306) completed successfully.</div><div class="line">Fri Aug  5 13:33:38 2016 - [info]</div><div class="line"></div><div class="line">----- Failover Report -----</div><div class="line"></div><div class="line">app1: MySQL Master failover host_1(host_1:3306) to host_2(host_2:3306) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:3306) is down!</div><div class="line"></div><div class="line">Check MHA Manager logs at host_manager_name:/var/log/masterha/app1/app1.log for details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address on host_1(host_1:3306)</div><div class="line">Selected host_2(host_2:3306) as a new master.</div><div class="line">host_2(host_2:3306): OK: Applying all logs succeeded.</div><div class="line">host_2(host_2:3306): OK: Activated master IP address.</div><div class="line">host_3(host_3:3306): OK: Slave started, replicating from host_2(host_2:3306)</div><div class="line">host_2(host_2:3306): Resetting slave info succeeded.</div><div class="line">Master failover to host_2(host_2:3306) completed successfully.</div></pre></td></tr></table></figure>

<h2 id="4-18_[用例测试]_在一开始没有开启MHA的group中，然后master挂了，如何做到日志补偿，然后change_master呢？">4.18 [用例测试] 在一开始没有开启MHA的group中，然后master挂了，如何做到日志补偿，然后change master呢？</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">* </span>如果master挂了，而且没有HA，那怎么做日志补偿呢？</div><div class="line"></div><div class="line"><span class="bullet">1. </span>其实很简单，只要之前在slave都设置了relay-log-purge=0就可以  </div><div class="line"></div><div class="line"><span class="bullet">2. </span>然后自己在按照正常流程部署好manager和node  </div><div class="line"></div><div class="line"><span class="bullet">3. </span>操作 手工-自动 failover 就可以了</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/MySQL-share/">MySQL share</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/分享/">分享</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2016/08/05/mha_practice/" data-title="MySQL Master High Available 实战篇 | Focus on MySQL,Focus on Life" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/08/18/mha_source/" title="MySQL Master High Available 源码篇">
  <strong>PREVIOUS:</strong><br/>
  <span>
  MySQL Master High Available 源码篇</span>
</a>
</div>


<div class="next">
<a href="/2016/07/29/life_think/"  title="对人生的一些思考">
 <strong>NEXT:</strong><br/> 
 <span>对人生的一些思考
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2016/08/05/mha_practice/" data-title="MySQL Master High Available 实战篇" data-url="https://Keithlan.github.io/2016/08/05/mha_practice/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#测试背景"><span class="toc-number">1.</span> <span class="toc-text">测试背景</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、MHA安装"><span class="toc-number">2.</span> <span class="toc-text">一、MHA安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、MHA配置文件"><span class="toc-number">3.</span> <span class="toc-text">二、MHA配置文件</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、前提要求(必须满足)"><span class="toc-number">4.</span> <span class="toc-text">三、前提要求(必须满足)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1_SSH公钥认证"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 SSH公钥认证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2_操作系统"><span class="toc-number">4.2.</span> <span class="toc-text">3.2 操作系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3_单写master和多slave或者只读master"><span class="toc-number">4.3.</span> <span class="toc-text">3.3 单写master和多slave或者只读master</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4_三层或者多层复制环境"><span class="toc-number">4.4.</span> <span class="toc-text">3.4 三层或者多层复制环境</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5_MySQL版本必须是5-0_或者高于_5-0"><span class="toc-number">4.5.</span> <span class="toc-text">3.5 MySQL版本必须是5.0 或者高于 5.0</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-6_使用mysqlbinlog_5-1+_支持MySQL5-1+"><span class="toc-number">4.6.</span> <span class="toc-text">3.6 使用mysqlbinlog 5.1+ 支持MySQL5.1+</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-7_log-bin必须在候选master上开启"><span class="toc-number">4.7.</span> <span class="toc-text">3.7 log-bin必须在候选master上开启</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-8_binlog，relay-log_主从环境必须全部一致"><span class="toc-number">4.8.</span> <span class="toc-text">3.8 binlog，relay-log 主从环境必须全部一致</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-9_复制用户必须在候选master上要存在"><span class="toc-number">4.9.</span> <span class="toc-text">3.9 复制用户必须在候选master上要存在</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-10_使用purge_relay_logs来定期删除relay_logs"><span class="toc-number">4.10.</span> <span class="toc-text">3.10 使用purge_relay_logs来定期删除relay logs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-11_不要在SBR的环境中使用load_data_infile"><span class="toc-number">4.11.</span> <span class="toc-text">3.11 不要在SBR的环境中使用load data infile</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、实战演练"><span class="toc-number">5.</span> <span class="toc-text">四、实战演练</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-0_简单的failover过程"><span class="toc-number">5.1.</span> <span class="toc-text">4.0 简单的failover过程</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-2_测试场景一、_手工操作，手动完成，failover"><span class="toc-number">6.</span> <span class="toc-text">4.2 测试场景一、 手工操作，手动完成，failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-3_[功能测试]_测试场景二、手工操作,_自动完成，failover"><span class="toc-number">7.</span> <span class="toc-text">4.3 [功能测试] 测试场景二、手工操作, 自动完成，failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-4_[功能测试]_测试场景三、手工操作，自动完成，online_master_switch"><span class="toc-number">8.</span> <span class="toc-text">4.4 [功能测试] 测试场景三、手工操作，自动完成，online master switch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-5_测试场景四、自动监控，自动操作，自动完成，failover"><span class="toc-number">9.</span> <span class="toc-text">4.5 测试场景四、自动监控，自动操作，自动完成，failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-6_[用例测试]_MySQL_master_too_many_connection，无权限，响应慢"><span class="toc-number">10.</span> <span class="toc-text">4.6 [用例测试] MySQL master too many connection，无权限，响应慢</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-7_[用例测试]_MySQL_master_服务器_down掉，且候选master落后的最多，_是否自动failover，知否可以成功的做日志补偿"><span class="toc-number">11.</span> <span class="toc-text">4.7 [用例测试] MySQL master 服务器 down掉，且候选master落后的最多， 是否自动failover，知否可以成功的做日志补偿</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-8_[用例测试]_Master_没挂，但是MySQL_slave_服务_down掉，是否自动failover"><span class="toc-number">12.</span> <span class="toc-text">4.8 [用例测试] Master 没挂，但是MySQL slave 服务 down掉，是否自动failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-9_[用例测试]_Master_挂了，但是MySQL_slave_有问题，是否自动failover"><span class="toc-number">13.</span> <span class="toc-text">4.9 [用例测试] Master 挂了，但是MySQL slave 有问题，是否自动failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-10_[用例测试]_MySQL_master_有大事务超过100s再执行，是否online_master_switch"><span class="toc-number">14.</span> <span class="toc-text">4.10 [用例测试] MySQL master 有大事务超过100s再执行，是否online master switch</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-11_[用例测试]_MySQL_master_网络断掉"><span class="toc-number">15.</span> <span class="toc-text">4.11 [用例测试] MySQL master 网络断掉</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-12_[用例测试]_MySQL_master_网路瞬断（1~30秒），是否自动failover"><span class="toc-number">16.</span> <span class="toc-text">4.12 [用例测试] MySQL master 网路瞬断（1~30秒），是否自动failover</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试0_（没有二次检测的机制）"><span class="toc-number">17.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试0 （没有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试1_（有二次检测的机制）"><span class="toc-number">18.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试1 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试2_（有二次检测的机制）"><span class="toc-number">19.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试2 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试3_（有二次检测的机制）"><span class="toc-number">20.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试3 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试4_（没有二次检测的机制）"><span class="toc-number">21.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试4 （没有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试5_（有二次检测的机制）"><span class="toc-number">22.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试5 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试6_（没有二次检测的机制）"><span class="toc-number">23.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试6 （没有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-14_[用例测试]_多段网络测试7_（有二次检测的机制）"><span class="toc-number">24.</span> <span class="toc-text">4.14 [用例测试] 多段网络测试7 （有二次检测的机制）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-15_[用例测试]_Non-GTID模式下，需要relay-log吗？是否能够成功的补齐日志"><span class="toc-number">25.</span> <span class="toc-text">4.15 [用例测试] Non-GTID模式下，需要relay-log吗？是否能够成功的补齐日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-16_[用例测试]_GTID模式下，需要relay-log吗？是否能够成功的补齐日志"><span class="toc-number">26.</span> <span class="toc-text">4.16 [用例测试] GTID模式下，需要relay-log吗？是否能够成功的补齐日志</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-18_[用例测试]_在一开始没有开启MHA的group中，然后master挂了，如何做到日志补偿，然后change_master呢？"><span class="toc-number">27.</span> <span class="toc-text">4.18 [用例测试] 在一开始没有开启MHA的group中，然后master挂了，如何做到日志补偿，然后change master呢？</span></a></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>49</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>37</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Error/" title="Error">Error<sup>2</sup></a></li>
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>9</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MHA/" title="MHA">MHA<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>46</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>5</sup></a></li>
		
			<li><a href="/tags/MySQL-实战/" title="MySQL 实战">MySQL 实战<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
