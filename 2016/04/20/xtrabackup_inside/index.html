
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>Xtrabackup 的秘密 | Focus on MySQL,Focus on Life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" content="如果想知道如何使用xtrabackup，请翻阅之前的文章 xtrabackup核心文档
xtrabackup原理深入浅出
为什么要使用xtrabackup

常用的备份有哪些



性能对比



逻辑备份 vs 物理备份
  逻辑备份优点: 占用空间小，安全  逻辑备份缺点: 恢复速度慢  物理备">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Life">Focus on MySQL,Focus on Life</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/04/20/xtrabackup_inside/" title="Xtrabackup 的秘密" itemprop="url">Xtrabackup 的秘密</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2016-04-20T08:32:24.000Z" itemprop="datePublished">Apr 20 2016</time>
    Updated:<time datetime="2019-01-15T06:45:58.000Z" itemprop="dateModified">Jan 15 2019</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#xtrabackup原理深入浅出"><span class="toc-number">1.</span> <span class="toc-text">xtrabackup原理深入浅出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要使用xtrabackup"><span class="toc-number">1.1.</span> <span class="toc-text">为什么要使用xtrabackup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是一致性备份"><span class="toc-number">1.2.</span> <span class="toc-text">什么是一致性备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#percona_xtrabackup基本概念"><span class="toc-number">1.3.</span> <span class="toc-text">percona xtrabackup基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xtrabackup_for_5-6_备份原理"><span class="toc-number">1.4.</span> <span class="toc-text">xtrabackup for 5.6 备份原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生产环境如何备份"><span class="toc-number">2.</span> <span class="toc-text">生产环境如何备份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题1，如何传输到其他服务器呢？"><span class="toc-number">2.1.</span> <span class="toc-text">问题1，如何传输到其他服务器呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#你所不知道的秘密"><span class="toc-number">2.2.</span> <span class="toc-text">你所不知道的秘密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接copy_innoDB的方式备份"><span class="toc-number">2.3.</span> <span class="toc-text">直接copy innoDB的方式备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重要"><span class="toc-number">2.4.</span> <span class="toc-text">重要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最后的几个关键问题"><span class="toc-number">2.5.</span> <span class="toc-text">最后的几个关键问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#相关参考"><span class="toc-number">2.6.</span> <span class="toc-text">相关参考</span></a></li></ol></li></ol>
		</div>
		
		<p>如果想知道如何使用xtrabackup，请翻阅之前的文章 <a href="http://keithlan.github.io/2016/04/19/xtrabackup_doc/" target="_blank" rel="external">xtrabackup核心文档</a></p>
<h2 id="xtrabackup原理深入浅出">xtrabackup原理深入浅出</h2>
<h3 id="为什么要使用xtrabackup">为什么要使用xtrabackup</h3>
<ul>
<li><strong>常用的备份有哪些</strong></li>
</ul>
<p><img src="/image/mysql_xtrabackup/back_type.png" alt="type" title="type"></p>
<ul>
<li><strong>性能对比</strong></li>
</ul>
<p><img src="/image/mysql_xtrabackup/back_time.png" alt="time" title="time"></p>
<ul>
<li><p><strong>逻辑备份 vs 物理备份</strong></p>
<p>  逻辑备份优点: 占用空间小，安全<br>  逻辑备份缺点: 恢复速度慢<br>  物理备份优点: 备份，恢复速度快<br>  物理备份缺点: 占用空间大  </p>
</li>
<li><p><strong>如何选择，全凭业务场景</strong></p>
<pre><code>如果类似facebook这种量级（PB，EB），考虑成本，建议逻辑备份   
如果只是上<span class="literal">T</span>级别，建议物理备份  
本人用的是物理备份，还有一个原因就是： 逻辑备份会遭到DDL的破坏  
试想，晚上经常有DDL这样的操作，备份任务不可能随意调整，这样带来的运维成本很大  
</code></pre></li>
<li><p><strong>物理备份：InnoDB vs  Myisam</strong></p>
<blockquote>
<p>Myisam引擎，只需要flush tables后，就可以随意拷贝文件<br>InnoDB可通过xtrabackup来拷贝文件  </p>
</blockquote>
<p>  在5.6之前，我比较喜欢用Myisam引擎来做备份，原因是就是备份和恢复的速度以及随意拷贝的便利性<br>  在5.6之后，由于可传输表空间的出现，让恢复单表变得简单，我更加愿意用InnoDB备份。关于可传输表空间，可阅读<a href="http://keithlan.github.io/2016/04/21/transportable/" target="_blank" rel="external">transportable tablespace详解</a><br>  用Myisam的一个致命弱点是：如果要还原成innoDB表，需要转换表引擎，痛苦的开始<br>  至于InnoDB和Myisam的选择，就不用纠结了，因为之后的MySQL会废弃掉Myisam  </p>
</li>
</ul>
<h3 id="什么是一致性备份">什么是一致性备份</h3>
<blockquote>
<p>简单来说，就是备份的数据都处在同一时间点  </p>
</blockquote>
<p><img src="/image/mysql_xtrabackup/non-consis.jpg" alt="non-consis" title="non-consis"></p>
<p><img src="/image/mysql_xtrabackup/consis.jpg" alt="consis" title="consis"> </p>
<h3 id="percona_xtrabackup基本概念">percona xtrabackup基本概念</h3>
<blockquote>
<p>innobackupex 是一个perl写的脚本，为了方便，封装了xtrabackup，所以一般备份都用innobackupex<br>xtrabackup 只备份innoDB表  ，其余的都交给innobackupex<br>新版本如：2.4，2.3.xx 已经将innodbex用c 重写了，然后链接到xtrabackup    </p>
</blockquote>
<h3 id="xtrabackup_for_5-6_备份原理">xtrabackup for 5.6 备份原理</h3>
<blockquote>
<ol>
<li>innobackupex 调用 xtrabackup —suspend-at-end   </li>
<li>xtrabackup 开始拷贝 innodb 数据文件,共享表空间 </li>
<li>当xtrabackup拷贝完innodb文件后，会创建  xtrabackup_suspended_2  </li>
<li>当innobackupex看到xtrabackup_suspended_2文件被创建后，进行加锁<br>  a. FLUSH NO_WRITE_TO_BINLOG TABLES<br>  b. FLUSH TABLES WITH READ LOCK  </li>
<li>innobackupex开始检查db server支持的特性，如：gtid，backup locks，changed page bitmap等  </li>
<li>然后开始拷贝非innodb文件，以及表结构frm  </li>
<li>当所有的文件都备份完成后，结束redo 事务的拷贝。  </li>
<li>接下来释放锁<br> a. FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS<br> b. UNLOCK TABLES  </li>
<li>删除xtrabackup_suspended_2文件 , 并且退出  </li>
</ol>
</blockquote>
<p><img src="/image/mysql_xtrabackup/innobackup.jpg" alt="innobackup" title="innobackup"></p>
<p>从上述流程图可以看出，FLUSH TABLES WITH READ LOCK【FTWRL】  这个时间点，就是备份恢复的时间点，即一致性点<br>因为数据再拷贝的过程中是不一致的，MySQL利用其自身的crash recover机制，用redo来保证最终一致性  </p>
<p>这里，假设一种场景，InnoDB是16k的刷新，当刷新到4k的时候，拷贝线程来讲这个页拷贝走，这样不就人为的造成了一次partial-write了吗？<br>对于partial-write的场景，由于redo日志是物理逻辑的，通过redo没有办法恢复，这可如何是好呢？  </p>
<p>这里是核心：</p>
<p>xtrabackup方式： xtrabackup里面做了很多事情，它在拷贝的过程中使用innodb的buf_page_is_corrupted()函数检查此页的数据是否正常，如果不正常，再重新拷贝，尝试N次重试之后还不行，就退出报错。  </p>
<p>flush-method=O_direct，会直接从innodb buffer 写入到 磁盘，这个操作可能就会发生partial-write了。一旦发生这样的事情，MySQL是无法恢复的，所以，我们的备份必须保证脏页全部刷新完，也就是在备份程序中 a）必须保证没有写了 b）必须验证和检测Modified db pages是否等于0。 如果以上都ok，那么这个页肯定是完整的。除此之外，我们还有一招，就是多次rsync，确保完整。  </p>
<p>flush-method=默认 ， 默认的会先从innodb buffer 写入到 OS缓存，这个操作是原子的，由操作系统保证。  </p>
<h2 id="生产环境如何备份">生产环境如何备份</h2>
<blockquote>
<p>备份的意图：备份master或者slave上的数据，然后传输到一个挂有大磁盘的服务器上，保留若干天  </p>
</blockquote>
<h3 id="问题1，如何传输到其他服务器呢？">问题1，如何传输到其他服务器呢？</h3>
<ol>
<li>这个问题，xtrabackup也考虑到了，用xbstream + ssh 的方式，但是有一个致命的缺点，就是无法断点续传，如果网络断掉，那就悲剧  </li>
<li>另外一个方式就是：先xtrabackup到本地一个目录，然后用rsync【支持断点续传】来传送到远端服务器。 这种方法的致命缺点是：本地磁盘需要浪费一半的空间,且copy了两遍备份数据   </li>
</ol>
<p>以上两种方式都存在缺陷，那么我们不得不思考第三种方式，是否可以直接copy到远端机器呢？  </p>
<ul>
<li>如果是在master上备份，那么直接copy是不行的，因为redo一直再变且轮询  </li>
</ul>
<p><img src="/image/mysql_xtrabackup/master.jpg" alt="master" title="master"></p>
<ul>
<li>如果是在slave上，或者etl&amp;backup机器上呢？ 不难发现，xtrabackup记录了redo的变化，如果我们人为的让redo不再增长，stop slave，这样的备份原理是否和xtrabackup一样呢？  </li>
</ul>
<p><img src="/image/mysql_xtrabackup/slave.jpg" alt="slave" title="slave">  </p>
<p>这样做的好处是，不用浪费一半的空间，也不需要传送2次   </p>
<h3 id="你所不知道的秘密">你所不知道的秘密</h3>
<p><img src="/image/mysql_xtrabackup/commit.jpg" alt="commit" title="commit"></p>
<p>通过以上流程图，可以发现一个重要的线索：我们的物理备份，是不会备份binlog的【重要】<br>所以，友谊的小船说翻就翻  </p>
<p><img src="/image/mysql_xtrabackup/commit_1.jpg" alt="commit_1" title="commit_1"></p>
<p>对于5.1 &amp; 5.5，用xtrabackup for 5.1 or 5.5 ，如果innodb_flush_log_at_trx_commit=1 ,应该没问题  </p>
<p><img src="/image/mysql_xtrabackup/commit_2.jpg" alt="commit_2" title="commit_2"></p>
<p>对于5.6 ， 用xtrabackup for 5.1 or 5.5 ， 即便如果innodb_flush_log_at_trx_commit=1，有可能会丢失事务  </p>
<p><img src="/image/mysql_xtrabackup/commit_3.jpg" alt="commit_3" title="commit_3"></p>
<p>对于5.6 ， 用xtrabackup for 5.6， 不会丢失事务  </p>
<h3 id="直接copy_innoDB的方式备份">直接copy innoDB的方式备份</h3>
<p>好了，现在进入正题，我们是否可以类似Myisam的方式随意拷贝呢？  </p>
<p>答案：可以  </p>
<ul>
<li>第一种方法： 保持和Myiam一致就可以。  </li>
</ul>
<blockquote>
<p>Myisam之所以可以随意拷贝，那是因为通过flush tables后，所有文件都会fsync到磁盘，这时候拷贝肯定没有问题。<br>InnoDB则不是，通过flush tables根本没有办法控制redo的刷新，data page的刷新以及ibdata的刷新。<br>所以，这里我们只要解决这三个问题即可。<br>redo: 我们可以通过innodb_flush_log_at_trx_commit=1来保证。<br>data page: 通过自身的checkpoint可以保证。<br>ibdata里面包含了：innodb table的数据字典信息，change buffer，doublewrite ，undo logs，这些目前好像还没有什么可以强制全部刷新。  </p>
</blockquote>
<p>所以，我们可以通过stop slave的方式，至少可以保证数据不丢失。至于ibdata里面的文件不刷新，也没太大关系，通过自身的crash-recover机制，自动修复。<br>所以，我们通过stop slave后，直接copy文件恢复的时候，你可能会看到这样的信息：  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">2016-05-26 13:47:24 15818 [Note] InnoDB: The log sequence numbers 2446418 and 2446418 in ibdata files <span class="operator"><span class="keyword">do</span> <span class="keyword">not</span> <span class="keyword">match</span> the <span class="keyword">log</span> sequence <span class="built_in">number</span> <span class="number">2446945</span> <span class="keyword">in</span> the ib_logfiles!  </span></div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">24</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: <span class="keyword">Database</span> was <span class="keyword">not</span> shutdown normally!  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">24</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: <span class="keyword">Starting</span> crash recovery.  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">24</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: Reading <span class="keyword">tablespace</span> information <span class="keyword">from</span> the .ibd files...  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">24</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: Restoring possible half-written <span class="keyword">data</span> pages  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">24</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: <span class="keyword">from</span> the doublewrite buffer...  </div><div class="line"><span class="keyword">InnoDB</span>: <span class="keyword">Last</span> MySQL <span class="keyword">binlog</span> file <span class="keyword">position</span> <span class="number">0</span> <span class="number">506</span>, file name tjtx-<span class="number">101</span>-<span class="number">141.000018</span>  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">25</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: <span class="number">128</span> <span class="keyword">rollback</span> segment(s) <span class="keyword">are</span> active.  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">25</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: Waiting <span class="keyword">for</span> <span class="keyword">purge</span> <span class="keyword">to</span> <span class="keyword">start</span>  </div><div class="line"><span class="number">2016</span>-<span class="number">05</span>-<span class="number">26</span> <span class="number">13</span>:<span class="number">47</span>:<span class="number">26</span> <span class="number">15818</span> [Note] <span class="keyword">InnoDB</span>: <span class="number">5.6</span><span class="number">.27</span> started; log sequence number 2446945  </div><div class="line">2016-05-26 13:47:26 15818 [Note] Recovering after a crash using /data/mysql.bin/tjtx-101-141  </div><div class="line">2016-05-26 13:47:26 15818 [Note] Starting crash recovery...  </div><div class="line">2016-05-26 13:47:26 15818 [Note] Crash recovery finished.</div></pre></td></tr></table></figure>

<p>当你看到Crash recovery finished完成后，基本也就ok了。  </p>
<p>好了，这里还有一个疑问我不太清楚，就是到底有多少个LSN  </p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Log sequence <span class="built_in">number</span> <span class="number">2446945</span>  <span class="comment">-- redo log buffer 中的lsn，内存中记录</span></div><div class="line">Log flushed up <span class="built_in">to</span>   <span class="number">2446945</span>  <span class="comment">-- redo log file 的lsn，redo的每个lock block都会记录</span></div><div class="line">Pages flushed up <span class="built_in">to</span> <span class="number">2446945</span>  <span class="comment">-- flush list中最后一个指针对应的page's newest modification(lsn)【last checkpoint newest modification】, 每个page的头部都会记录</span></div><div class="line">Last checkpoint <span class="keyword">at</span>  <span class="number">2446945</span>  <span class="comment">-- flush list中最后一个指针对应的page's oldest modification(lsn)【last checkpoint oldest modification】, 第一个redo的头部固定位置，存在头部的两个地方</span></div></pre></td></tr></table></figure>

<p>那么错误日志中的The log sequence numbers xx in ibdata files ，又是啥呢？  </p>
<p>经过测试：kill -9 mysqld<br>得到的结论是： 只要是非正常关闭的MySQL，都会出现这样的报错，即便是没有任何数据的MySQL<br>所以，我猜测，ibdata files中记录的lsn，从MySQL一启动，里面的lsn就会比redo中的lsn小，是专用于检测是否正常关闭MySQL的吗？<br>anyway，这都不影响我们innoDB在线拷贝的大局了。  </p>
<p>好了，通过以上测试，我们已经明白，stop slave后，等一会会，当脏页刷新完的时候，就可以认为数据全部刷新到磁盘了，这样就和Myisam没有任何区别  </p>
<p>ok，这里又引入了一个值得思考的问题，那就是： 怎么判断脏页已经刷完了呢？  </p>
<blockquote>
<p>检查4个lsn，当四个lsn都相等的时候，肯定刷完了。</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">Log sequence <span class="keyword">number</span> <span class="number">2446945</span></div><div class="line">Log flushed <span class="keyword">up</span> <span class="keyword">to</span>   <span class="number">2446945</span></div><div class="line">Pages flushed <span class="keyword">up</span> <span class="keyword">to</span> <span class="number">2446945</span></div><div class="line">Last checkpoint at  <span class="number">2446945</span></div><div class="line"></div><div class="line">没错，当<span class="number">4</span>个lsn都相等的时候，的确可以表示脏页已经刷完。</div><div class="line"></div><div class="line">但是，当<span class="number">4</span>个lsn不完全相等的时候，也有可能表示脏页刷完了。比如：</div><div class="line"></div><div class="line">Log sequence <span class="keyword">number</span> <span class="number">2446945</span></div><div class="line">Log flushed <span class="keyword">up</span> <span class="keyword">to</span>   <span class="number">2446945</span></div><div class="line">Pages flushed <span class="keyword">up</span> <span class="keyword">to</span> <span class="number">2446945</span></div><div class="line">Last checkpoint at  <span class="number">2446747</span> --不一样</div><div class="line"></div><div class="line">我来解读一下：</div><div class="line">Last checkpoint 指的是最后一个脏页的oldest modification</div><div class="line">Pages flushed <span class="keyword">up</span> <span class="keyword">to</span> 指的是最后一个脏页的newest modification</div><div class="line"></div><div class="line">当我们再刷最后一个脏页的时候，这个脏页被多次更新，那么就表示该脏页的newest modification &gt; oldest modification .</div><div class="line">所以就不相等了，但是的确脏页也都刷新完了。</div></pre></td></tr></table></figure>

<blockquote>
<p> 检查Modified db pages的值，这个值就表示flush list中还有多少个page没有被刷新，如果全为0，表示flush list中脏页全部刷新。</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">假设一个实例有<span class="number">2</span>个<span class="keyword">BUFFER</span> POOL instance，那么就要检查两个Modified db pages 是否都为<span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment">---BUFFER POOL 0</span></div><div class="line"><span class="keyword">Buffer</span> pool size   <span class="number">655359</span></div><div class="line">Free buffers       <span class="number">1000</span></div><div class="line">Database pages     <span class="number">636541</span></div><div class="line">Old database pages <span class="number">234953</span></div><div class="line">Modified db pages  <span class="number">0</span>  <span class="comment">-- 表示这个buffer pool中的脏页已经刷新完</span></div><div class="line">Pending reads <span class="number">0</span></div><div class="line"></div><div class="line"><span class="comment">---BUFFER POOL 1</span></div><div class="line"><span class="keyword">Buffer</span> pool size   <span class="number">655359</span></div><div class="line">Free buffers       <span class="number">1000</span></div><div class="line">Database pages     <span class="number">636426</span></div><div class="line">Old database pages <span class="number">234910</span></div><div class="line">Modified db pages  <span class="number">0</span> <span class="comment">-- 表示这个buffer pool中的脏页已经刷新完</span></div><div class="line">Pending reads <span class="number">0</span></div><div class="line"></div><div class="line">两个都刷新完，表示flush list中已经没有脏页了。</div></pre></td></tr></table></figure>

<ul>
<li>第二种方式</li>
</ul>
<p>stop slave后，如果脏页没有刷新完呢？不相等，我们还能拷贝吗？<br>答案是：当然可以。<br>lsn不相等，意味着，我们crash-recover的时候需要通过redo来恢复数据，稍微慢点而已，不影响大局。  </p>
<h3 id="重要">重要</h3>
<p>所以，不管以上两种方式的哪一种，如果你想通过stop slave的方式，直接拷贝文件的话，最好执行下  </p>
<p>FLUSH NO_WRITE_TO_BINLOG TABLES<br>FLUSH NO_WRITE_TO_BINLOG ENGINE LOGS  </p>
<p>这样，就跟xtrabackup没什么区别了  </p>
<h3 id="最后的几个关键问题">最后的几个关键问题</h3>
<ul>
<li>Xtrabackup 在什么版本恢复的时候，可能会丢失最后一个事务</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">Xtrabackup <span class="number">2.2</span><span class="number">.3</span>版本修复了此问题</div><div class="line"></div><div class="line"><span class="keyword">https</span>://launchpad.net/percona-xtrabackup/<span class="number">2.2</span>/<span class="number">2.2</span><span class="number">.3</span>-ga</div><div class="line"></div><div class="line">Bugs Fixed</div><div class="line"></div><div class="line">Fixed <span class="operator">the</span> InnoDB redo <span class="built_in">log</span> incompatibility <span class="operator">with</span> <span class="number">5.1</span>/<span class="number">5.5</span> server <span class="operator">and</span> compressed tables which was introduced <span class="keyword">by</span> <span class="operator">the</span> upstream fix <span class="operator">in</span> MySQL <span class="number">5.6</span><span class="number">.11</span> that could make InnoDB crash <span class="command"><span class="keyword">on</span> <span class="title">recovery</span> <span class="title">when</span> <span class="title">replaying</span> <span class="title">redo</span> <span class="title">logs</span> <span class="title">created</span> <span class="title">on</span> <span class="title">earlier</span> <span class="title">versions</span>. <span class="title">Bug</span> <span class="title">fixed</span> #<span class="title">1255476</span>.</span></div><div class="line"></div><div class="line">Percona XtraBackup did <span class="operator">not</span> flush <span class="operator">the</span> InnoDB REDO <span class="built_in">log</span> buffer <span class="keyword">before</span> finalizing <span class="operator">the</span> <span class="built_in">log</span> copy. This would only become <span class="operator">a</span> problem when <span class="operator">the</span> binary <span class="built_in">log</span> coordinates were used <span class="keyword">after</span> restoring <span class="built_in">from</span> <span class="operator">a</span> backup: <span class="operator">the</span> actual data <span class="built_in">files</span> state <span class="keyword">after</span> recovery could be inconsistent <span class="operator">with</span> <span class="operator">the</span> binary <span class="built_in">log</span> coordinates. Bug fixed <span class="comment">#1320685.</span></div><div class="line"></div><div class="line">innobackupex now sets wsrep_causal_reads <span class="built_in">to</span> <span class="number">0</span> <span class="keyword">before</span> executing FLUSH TABLES WITH READ LOCK <span class="keyword">if</span> <span class="operator">the</span> server is <span class="operator">a</span> member <span class="operator">of</span> <span class="operator">the</span> Galera cluster. Bug fixed <span class="comment">#1320441.</span></div><div class="line"></div><div class="line">storage/innobase/xtrabackup/CMakeLists.txt now honors <span class="operator">the</span> XB_DISTRIBUTION environment <span class="built_in">variable</span> when configuring innobackupex.pl <span class="built_in">to</span> innobackupex. Bug fixed <span class="comment">#1320856.</span></div><div class="line"></div><div class="line">When backup locks are used, xtrabackup_slave_info should be written under BINLOG lock instead <span class="operator">of</span> TABLE lock. Bug fixed <span class="comment">#1328532.</span></div><div class="line"></div><div class="line">Other bugs fixed: <span class="comment">#1318540.</span></div></pre></td></tr></table></figure>

<ul>
<li>innodb 文件  和 非innodb 文件的备份，都是通过拷贝文件的方式来做的，其中有什么不同吗？</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">InnoDB的文件，是以page为粒度做的，xtrabackup 在读取每个page时会校验 <span class="operator"><span class="keyword">checksum</span> 值，保证数据块是一致的</span></div><div class="line">非<span class="keyword">InnoDB</span>文件，是在cp MyISAM 文件时已经做了<span class="keyword">flush</span>（FTWRL），磁盘上的文件也是完整和静止的，所以最终备份集里的数据文件都是写入完整的。</div></pre></td></tr></table></figure>

<ul>
<li>数据恢复的原理的是什么</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">恢复的目的是把备份结果集 中的 数据恢复到一个一致性位点，所谓一致就是指原数据库某一时间点各引擎数据的状态</div><div class="line">比如 MyISAM 中的数据对应的是 <span class="number">15</span>:<span class="number">00</span> 时间点的，InnoDB 中的数据对应的是 <span class="number">15</span>:<span class="number">20</span> 的，这种状态的数据就是不一致的。</div><div class="line">PXB 备份集对应的一致点，就是备份时FTWRL的时间点，恢复出来的数据，就对应原数据库FTWRL时的状态。</div><div class="line"></div><div class="line">因为备份时 FTWRL 后，数据库是处于只读的</div><div class="line">非 InnoDB 数据是在持有全局读锁情况下拷贝的，所以非 InnoDB 数据本身就对应 FTWRL 时间点；</div><div class="line">InnoDB 的 ibd 文件拷贝是在 FTWRL 前做的  ， 拷贝出来的不同 ibd 文件最后更新时间点是不一样的，这种状态的 ibd 文件是不能直接用的</div><div class="line">但是 <span class="keyword">redo</span> <span class="keyword">log</span> 是从备份开始一直持续拷贝的，最后的 <span class="keyword">redo</span> 日志点是在持有 FTWRL 后取得的，所以最终通过 <span class="keyword">redo</span> 应用后的 ibd 数据时间点也是和 FTWRL 一致的。</div><div class="line"></div><div class="line">所以恢复过程只涉及 InnoDB 文件的恢复，非 InnoDB 数据是不动的。备份恢复完成后，就可以把数据文件拷贝到对应的目录，然后通过mysqld来启动了。</div><div class="line"></div><div class="line">还原的流程：</div><div class="line"></div><div class="line">* 准备（prepare）一个完全备份</div><div class="line">innobackupex --apply-<span class="keyword">log</span> /path/to/BACKUP-DIR ： 将<span class="keyword">redo</span>日志apply到数据文件,让数据恢复到FTWRL的时间点</div><div class="line"></div><div class="line">* 从一个完全备份中恢复数据</div><div class="line">innobackupex --copy-back/<span class="keyword">move</span>-back /path/to/BACKUP-DIR ： 拷贝数据文件到MySQL目录</div></pre></td></tr></table></figure>

<ul>
<li>最后的详细备份流程细化</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">1、先获取innodb最后一次checkpoint对应的redo log lsn；</div><div class="line"></div><div class="line">2、xtrabackup主线程从checkpoint lsn开始将之后新产生的redo都拷贝到xtrabackup_logfile上；</div><div class="line"></div><div class="line">3、只有拷完所有的redo日志后，才会开启redo拷贝线程和ibd拷贝线程。并行执行redo和ibd数据拷贝；</div><div class="line"></div><div class="line">4、ibd拷贝线程完成所有数据拷贝；</div><div class="line"></div><div class="line">5、xtrabackup执行<span class="operator"><span class="keyword">flush</span> <span class="keyword">table</span> <span class="keyword">with</span> <span class="keyword">read</span> <span class="keyword">lock</span>，拷贝MyISAM表等非事务表数据；</span></div><div class="line"></div><div class="line"><span class="number">6</span>、获取<span class="keyword">Binlog</span>文件及偏移位置，获取gtid_executed等信息；</div><div class="line"></div><div class="line"><span class="number">7</span>、执行<span class="keyword">FLUSH</span> <span class="keyword">NO_WRITE_TO_BINLOG</span> <span class="keyword">ENGINE</span> <span class="keyword">LOGS</span>；</div><div class="line"></div><div class="line"><span class="number">8</span>、等待redo拷贝进程退出；</div><div class="line"></div><div class="line"><span class="number">9</span>、执行<span class="keyword">unlock</span> <span class="keyword">tables</span>；</div><div class="line"></div><div class="line"><span class="number">10</span>、执行备份所需其他操作后退出；</div></pre></td></tr></table></figure>

<h3 id="相关参考">相关参考</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">http:<span class="regexp">//mysql</span>.taobao.org/monthly/<span class="number">2016</span>/<span class="number">03</span>/<span class="number">07</span>/</div><div class="line">https:<span class="regexp">//zhuanlan</span>.zhihu.com/p/<span class="number">43913304</span></div><div class="line">http:<span class="regexp">//www</span>.innomysql.com/xtrabackup<span class="variable">%E5</span><span class="variable">%A4</span><span class="variable">%87</span><span class="variable">%E4</span><span class="variable">%BB</span><span class="variable">%BD</span><span class="variable">%E5</span><span class="variable">%8E</span><span class="variable">%9F</span><span class="variable">%E7</span><span class="variable">%90</span><span class="variable">%86</span><span class="variable">%E5</span><span class="variable">%AE</span><span class="variable">%9E</span><span class="variable">%E7</span><span class="variable">%8E</span><span class="variable">%B0</span><span class="variable">%E7</span><span class="variable">%BB</span><span class="variable">%86</span><span class="variable">%E8</span><span class="variable">%8A</span><span class="variable">%82</span>-<span class="variable">%E5</span><span class="variable">%AF</span><span class="variable">%B9</span><span class="variable">%E6</span><span class="variable">%B7</span><span class="variable">%98</span><span class="variable">%E5</span><span class="variable">%AE</span><span class="variable">%9D</span><span class="variable">%E6</span><span class="variable">%95</span><span class="variable">%B0</span><span class="variable">%E6</span><span class="variable">%8D</span><span class="variable">%AE</span><span class="variable">%E5</span><span class="variable">%BA</span><span class="variable">%93</span><span class="variable">%E5</span><span class="variable">%86</span><span class="variable">%85</span><span class="variable">%E6</span><span class="variable">%A0</span><span class="variable">%B8</span><span class="variable">%E6</span><span class="variable">%9C</span><span class="variable">%88</span><span class="variable">%E6</span><span class="variable">%8A</span><span class="variable">%A5</span><span class="variable">%E8</span><span class="variable">%A1</span><span class="variable">%A5</span>/</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/MySQL-tools/">MySQL tools</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2016/04/20/xtrabackup_inside/" data-title="Xtrabackup 的秘密 | Focus on MySQL,Focus on Life" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2016/04/21/transportable/" title="InnoDB可传输表空间">
  <strong>PREVIOUS:</strong><br/>
  <span>
  InnoDB可传输表空间</span>
</a>
</div>


<div class="next">
<a href="/2016/04/19/xtrabackup_doc/"  title="Percona XtraBackup 核心文档">
 <strong>NEXT:</strong><br/> 
 <span>Percona XtraBackup 核心文档
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2016/04/20/xtrabackup_inside/" data-title="Xtrabackup 的秘密" data-url="https://Keithlan.github.io/2016/04/20/xtrabackup_inside/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#xtrabackup原理深入浅出"><span class="toc-number">1.</span> <span class="toc-text">xtrabackup原理深入浅出</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#为什么要使用xtrabackup"><span class="toc-number">1.1.</span> <span class="toc-text">为什么要使用xtrabackup</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#什么是一致性备份"><span class="toc-number">1.2.</span> <span class="toc-text">什么是一致性备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#percona_xtrabackup基本概念"><span class="toc-number">1.3.</span> <span class="toc-text">percona xtrabackup基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xtrabackup_for_5-6_备份原理"><span class="toc-number">1.4.</span> <span class="toc-text">xtrabackup for 5.6 备份原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#生产环境如何备份"><span class="toc-number">2.</span> <span class="toc-text">生产环境如何备份</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#问题1，如何传输到其他服务器呢？"><span class="toc-number">2.1.</span> <span class="toc-text">问题1，如何传输到其他服务器呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#你所不知道的秘密"><span class="toc-number">2.2.</span> <span class="toc-text">你所不知道的秘密</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#直接copy_innoDB的方式备份"><span class="toc-number">2.3.</span> <span class="toc-text">直接copy innoDB的方式备份</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#重要"><span class="toc-number">2.4.</span> <span class="toc-text">重要</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#最后的几个关键问题"><span class="toc-number">2.5.</span> <span class="toc-text">最后的几个关键问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#相关参考"><span class="toc-number">2.6.</span> <span class="toc-text">相关参考</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>50</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>37</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Error/" title="Error">Error<sup>2</sup></a></li>
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>9</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MHA/" title="MHA">MHA<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>46</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>6</sup></a></li>
		
			<li><a href="/tags/MySQL-实战/" title="MySQL 实战">MySQL 实战<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
