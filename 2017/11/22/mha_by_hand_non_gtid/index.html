
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>MHA failover NON-GTID 专题 | Focus on MySQL,Focus on Life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" content="MHA failover NON-GTID 专题

这里以masterha_master_switch为背景详解各种可能遇到的场景

假定环境(经典三节点)
123host_1(host_1:3306) (current master) +--host_2(host_2:3306 slave[can">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Life">Focus on MySQL,Focus on Life</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/22/mha_by_hand_non_gtid/" title="MHA failover NON-GTID 专题" itemprop="url">MHA failover NON-GTID 专题</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2017-11-22T07:32:24.000Z" itemprop="datePublished">Nov 22 2017</time>
    Updated:<time datetime="2017-11-22T09:35:11.000Z" itemprop="dateModified">Nov 22 2017</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MHA_failover_NON-GTID_专题"><span class="toc-number">1.</span> <span class="toc-text">MHA failover NON-GTID 专题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#假定环境(经典三节点)"><span class="toc-number">1.1.</span> <span class="toc-text">假定环境(经典三节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Master_:_MySQL_down"><span class="toc-number">1.2.</span> <span class="toc-text">一、Master : MySQL down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1_etl_延迟8小时"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2_slave(候选master)比etl还要落后更多"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4_slave(候选master）上面有大事务在跑"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.5 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7_Master：MySQL_down小结"><span class="toc-number">1.2.6.</span> <span class="toc-text">1.7 Master：MySQL down小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Master_:_Server_down"><span class="toc-number">1.3.</span> <span class="toc-text">二、Master : Server down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_etl_延迟8小时"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_slave(候选master)比etl还要落后更多"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4_slave(候选master）上面有大事务在跑"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、遇到的坑"><span class="toc-number">1.4.</span> <span class="toc-text">三、遇到的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1_交互模式下，如果没有及时敲’YES’，则终止切换"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 交互模式下，如果没有及时敲’YES’，则终止切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2_如果在non-gtid模式的机器上，配置了binlog_server，会有什么影响呢？"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 如果在non-gtid模式的机器上，配置了binlog server，会有什么影响呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3_不要在relay-log的地方伪造日志"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 不要在relay-log的地方伪造日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4_flush_tables_with_read_lock_会阻塞"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4  flush tables with read lock 会阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5_binlog伪造"><span class="toc-number">1.4.5.</span> <span class="toc-text">3.5 binlog伪造</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、总结"><span class="toc-number">1.5.</span> <span class="toc-text">四、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、_流程简介"><span class="toc-number">1.6.</span> <span class="toc-text">五、 流程简介</span></a></li></ol></li></ol>
		</div>
		
		<h1 id="MHA_failover_NON-GTID_专题">MHA failover NON-GTID 专题</h1>
<blockquote>
<p>这里以masterha_master_switch为背景详解各种可能遇到的场景</p>
</blockquote>
<h2 id="假定环境(经典三节点)">假定环境(经典三节点)</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">host_1</span><span class="params">(host_1:<span class="number">3306</span>)</span> <span class="params">(current master)</span></span></div><div class="line"> +--<span class="title">host_2</span><span class="params">(host_2:<span class="number">3306</span> slave[candidate master])</span></div><div class="line"> +--<span class="title">host_3</span><span class="params">(host_3:<span class="number">3306</span> etl)</span></div></pre></td></tr></table></figure>

<h2 id="一、Master_:_MySQL_down">一、Master : MySQL down</h2>
<h3 id="1-1_etl_延迟8小时">1.1 etl 延迟8小时</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">配置文件中加上no_check_delay</span>=<span class="string">0 即可忽略报错</span></div></pre></td></tr></table></figure>

<h3 id="1-2_slave(候选master)比etl还要落后更多">1.2 slave(候选master)比etl还要落后更多</h3>
<ul>
<li>1.2.1 当master的部分日志还没传递两个slave，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 模拟现场，现场的3台DB binlog状态</span></div><div class="line"></div><div class="line">* master host_2</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| host_2<span class="number">.000002</span> |     <span class="number">1920</span> |              |                  |                   |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave (candidate master) host_1</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000002</span></div><div class="line">          Read_Master_Log_Pos: <span class="number">150</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">150</span></div><div class="line"></div><div class="line"></div><div class="line">* etl (other slave)</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000002</span></div><div class="line">          Read_Master_Log_Pos: <span class="number">1035</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">1035</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host=host_2  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">03</span> <span class="number">2017</span> - [info] Binlog server host_2 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Binlog server host_3 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>) ..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Starting Non-GTID based failover.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">06</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span> host_2 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-13 16:24:07--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [<span class="type">text</span>/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">11.2</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> (<span class="number">11.2</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_2<span class="number">.000002</span>:<span class="number">1035</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_2<span class="number">.000002</span>:<span class="number">150</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Fetching dead master's binary logs..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Executing command <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> dead master host_2(host_2:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_2.000002  --start_pos=1035 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /var/<span class="command">log</span>/masterha/mha_test <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_2<span class="number">.000002</span> pos <span class="number">1035</span> <span class="keyword">to</span> host_2<span class="number">.000002</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog ..</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">150.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql.bin/host_2<span class="number">.000002</span> position <span class="number">1035</span> <span class="keyword">to</span> tail(<span class="number">1939</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">12</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@host_2:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog <span class="keyword">to</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">12</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">12</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Finding <span class="keyword">the</span> latest slave <span class="keyword">that</span> has all relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Checking whether host_3 has relay logs <span class="keyword">from</span> <span class="keyword">the</span> oldest position..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_2.000002 --latest_rmlp=1035 --target_mlf=host_2.000002 --target_rmlp=150 --server_id=1261261666 --workdir=/var/log/masterha/mha_test --timestamp=20171113162403 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3-relay-bin.000005  :</span></div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_3-relay-bin<span class="number">.000005</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_3-relay-bin<span class="number">.000005</span>, start_pos:<span class="number">269.</span></div><div class="line">Target relay <span class="command">log</span> FOUND!</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] OK. host_3 has all relay logs.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_1(host_1:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Server host_1 received relay logs up <span class="keyword">to</span>: host_2<span class="number">.000002</span>:<span class="number">150</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Need <span class="keyword">to</span> <span class="keyword">get</span> diffs <span class="keyword">from</span> <span class="keyword">the</span> latest slave(host_3) up <span class="keyword">to</span>: host_2<span class="number">.000002</span>:<span class="number">1035</span> (using <span class="keyword">the</span> latest slave's relay logs)</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> latest slave host host_3, generating diff relay <span class="command">log</span> files..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=generate_and_send --scp_user=root --scp_host=host_1 --latest_mlf=host_2.000002 --latest_rmlp=1035 --target_mlf=host_2.000002 --target_rmlp=150 --server_id=1261261666 --diff_file_readtolatest=/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog --workdir=/var/log/masterha/mha_test --timestamp=20171113162403 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3-relay-bin.000005</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">15</span> <span class="number">2017</span> - [info]</div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_3-relay-bin<span class="number">.000005</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_3-relay-bin<span class="number">.000005</span>, start_pos:<span class="number">269.</span></div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_3-relay-bin<span class="number">.000005</span> pos <span class="number">269</span> <span class="keyword">to</span> host_3-relay-bin<span class="number">.000005</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog ..</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">269.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql_data/host_3-relay-bin<span class="number">.000005</span> position <span class="number">269</span> <span class="keyword">to</span> tail(<span class="number">1154</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay <span class="command">log</span> succeeded. Saved <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog .</div><div class="line"> scp host_3<span class="number">.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog <span class="keyword">to</span> root@host_1(<span class="number">22</span>) succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">15</span> <span class="number">2017</span> - [info]  Generating diff files succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">15</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog <span class="keyword">to</span> root@host_1:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] *NOTICE: If any <span class="keyword">error</span> happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] This slave(host_1)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000002</span>:<span class="number">150</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_1, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_1 --slave_ip=host_1  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog,/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171113162403 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line"> Concat all apply files <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_1_3306<span class="number">.20171113162403</span>.binlog ..</div><div class="line"> Copying <span class="keyword">the</span> <span class="keyword">first</span> binlog <span class="type">file</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_1_3306<span class="number">.20171113162403</span>.binlog.. ok.</div><div class="line">  Dumping binlog head events (rotate events), skipping format description events <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog.. dumped up <span class="keyword">to</span> pos <span class="number">150.</span> ok.</div><div class="line"> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog has effective binlog events <span class="keyword">from</span> pos <span class="number">150.</span></div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog position <span class="number">150</span> <span class="keyword">to</span> tail(<span class="number">1054</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">All apply target binary logs are concatinated <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_1_3306<span class="number">.20171113162403</span>.binlog .</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171113162403.binlog,/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog <span class="function_start"><span class="keyword">on</span></span> host_1:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  host_1<span class="number">.000001</span>:<span class="number">3232</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_1', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='host_1<span class="number">.000001</span>', MASTER_LOG_POS=<span class="number">3232</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">16</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --new_master_host=host_1 --new_master_ip=host_1 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span> host_1  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 104955. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171113162403.log if it takes time..</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- host_3(host_3:3306) has the latest relay log events.</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 104966. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171113162403.log if it takes time..</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog <span class="keyword">to</span> root@host_3:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] This slave(host_3)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000002</span>:<span class="number">1035</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_3, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_3 --slave_ip=host_3  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171113162403 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171113162403.binlog <span class="function_start"><span class="keyword">on</span></span> host_3:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  host_1: Resetting slave info succeeded.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover host_2(host_2:<span class="number">3306</span>) <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_2(host_2:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/mha_test.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">The latest slave host_3(host_3:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_1(host_1:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has <span class="keyword">the</span> latest relay <span class="command">log</span> events.</div><div class="line">Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">host_1(host_1:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Mon Nov <span class="number">13</span> <span class="number">16</span>:<span class="number">24</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Sending mail..</div></pre></td></tr></table></figure>

<ul>
<li>1.2.2 当master的所有日志已经传递到1个etl，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">### 模拟现场，现场的3台DB binlog状态</span></div><div class="line"></div><div class="line">* master host_2</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| host_2<span class="number">.000010</span> |     <span class="number">1694</span> |              |                  |                   |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">164</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">165</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">166</span> | <span class="number">3</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">* slave (candidate master) host_1</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000010</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">806</span></div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">Empty <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* etl (other slave) host_3</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000010</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">1694</span></div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">164</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">165</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">166</span> | <span class="number">3</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>) ..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Starting Non-GTID based failover.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">50</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">51</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span> host_2 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-15 10:25:51--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [<span class="type">text</span>/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">11.1</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> (<span class="number">11.1</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_2<span class="number">.000010</span>:<span class="number">1694</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_2<span class="number">.000010</span>:<span class="number">806</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Fetching dead master's binary logs..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Executing command <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> dead master host_2(host_2:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_2.000010  --start_pos=1694 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /var/<span class="command">log</span>/masterha/mha_test <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_2<span class="number">.000010</span> pos <span class="number">1694</span> <span class="keyword">to</span> host_2<span class="number">.000010</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog ..</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">150.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql.bin/host_2<span class="number">.000010</span> position <span class="number">1694</span> <span class="keyword">to</span> tail(<span class="number">1713</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">53</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@host_2:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog <span class="keyword">to</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Finding <span class="keyword">the</span> latest slave <span class="keyword">that</span> has all relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Checking whether host_3 has relay logs <span class="keyword">from</span> <span class="keyword">the</span> oldest position..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_2.000010 --latest_rmlp=1694 --target_mlf=host_2.000010 --target_rmlp=806 --server_id=1261261666 --workdir=/var/log/masterha/mha_test --timestamp=20171115102550 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3-relay-bin.000004  :</span></div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_3-relay-bin<span class="number">.000004</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_3-relay-bin<span class="number">.000004</span>, start_pos:<span class="number">1017.</span></div><div class="line">Target relay <span class="command">log</span> FOUND!</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] OK. host_3 has all relay logs.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_1(host_1:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Server host_1 received relay logs up <span class="keyword">to</span>: host_2<span class="number">.000010</span>:<span class="number">806</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Need <span class="keyword">to</span> <span class="keyword">get</span> diffs <span class="keyword">from</span> <span class="keyword">the</span> latest slave(host_3) up <span class="keyword">to</span>: host_2<span class="number">.000010</span>:<span class="number">1694</span> (using <span class="keyword">the</span> latest slave's relay logs)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> latest slave host host_3, generating diff relay <span class="command">log</span> files..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=generate_and_send --scp_user=root --scp_host=host_1 --latest_mlf=host_2.000010 --latest_rmlp=1694 --target_mlf=host_2.000010 --target_rmlp=806 --server_id=1261261666 --diff_file_readtolatest=/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog --workdir=/var/log/masterha/mha_test --timestamp=20171115102550 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3-relay-bin.000004</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_3-relay-bin<span class="number">.000004</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_3-relay-bin<span class="number">.000004</span>, start_pos:<span class="number">1017.</span></div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_3-relay-bin<span class="number">.000004</span> pos <span class="number">1017</span> <span class="keyword">to</span> host_3-relay-bin<span class="number">.000004</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog ..</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">361.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql_data/host_3-relay-bin<span class="number">.000004</span> position <span class="number">1017</span> <span class="keyword">to</span> tail(<span class="number">1905</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay <span class="command">log</span> succeeded. Saved <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog .</div><div class="line"> scp host_3<span class="number">.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog <span class="keyword">to</span> root@host_1(<span class="number">22</span>) succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">55</span> <span class="number">2017</span> - [info]  Generating diff files succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog <span class="keyword">to</span> root@host_1:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] *NOTICE: If any <span class="keyword">error</span> happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] This slave(host_1)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000010</span>:<span class="number">806</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_1, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_1 --slave_ip=host_1  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog,/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171115102550 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line"> Concat all apply files <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_1_3306<span class="number">.20171115102550</span>.binlog ..</div><div class="line"> Copying <span class="keyword">the</span> <span class="keyword">first</span> binlog <span class="type">file</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_1_3306<span class="number">.20171115102550</span>.binlog.. ok.</div><div class="line">  Dumping binlog head events (rotate events), skipping format description events <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog.. dumped up <span class="keyword">to</span> pos <span class="number">150.</span> ok.</div><div class="line"> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog has effective binlog events <span class="keyword">from</span> pos <span class="number">150.</span></div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog position <span class="number">150</span> <span class="keyword">to</span> tail(<span class="number">169</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">All apply target binary logs are concatinated <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_1_3306<span class="number">.20171115102550</span>.binlog .</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171115102550.binlog,/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog <span class="function_start"><span class="keyword">on</span></span> host_1:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  host_1<span class="number">.000010</span>:<span class="number">2060</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_1', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='host_1<span class="number">.000010</span>', MASTER_LOG_POS=<span class="number">2060</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">56</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --new_master_host=host_1 --new_master_ip=host_1 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span> host_1  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 125962. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171115102550.log if it takes time..</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="comment">-- host_3(host_3:3306) has the latest relay log events.</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 125967. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171115102550.log if it takes time..</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog <span class="keyword">to</span> root@host_3:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] This slave(host_3)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000010</span>:<span class="number">1694</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_3, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_3 --slave_ip=host_3  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171115102550 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171115102550.binlog <span class="function_start"><span class="keyword">on</span></span> host_3:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  host_1: Resetting slave info succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover host_2(host_2:<span class="number">3306</span>) <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_2(host_2:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/mha_test.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">The latest slave host_3(host_3:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_1(host_1:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has <span class="keyword">the</span> latest relay <span class="command">log</span> events.</div><div class="line">Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">host_1(host_1:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">25</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Sending mail..</div><div class="line"></div><div class="line"><span class="comment">### 切换后的结果</span></div><div class="line"></div><div class="line">* new master 和 new etl  数据一致</div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">164</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">165</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">166</span> | <span class="number">3</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<h3 id="1-3_slave(候选master)的日志是最新的，比etl要多">1.3 slave(候选master)的日志是最新的，比etl要多</h3>
<ul>
<li>1.3.1 当master的部分日志还没传递两个slave，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">### 模拟现场，现场的3台DB binlog状态</span></div><div class="line"></div><div class="line">* master host_2</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| host_2<span class="number">.000004</span> |     <span class="number">4577</span> |              |                  |                   |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">114</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">115</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">116</span> | <span class="number">3</span>    |</div><div class="line">| <span class="number">117</span> | <span class="number">4</span>    |</div><div class="line">| <span class="number">118</span> | <span class="number">5</span>    |</div><div class="line">| <span class="number">119</span> | <span class="number">6</span>    |</div><div class="line">| <span class="number">120</span> | <span class="number">7</span>    |</div><div class="line">| <span class="number">121</span> | <span class="number">8</span>    |</div><div class="line">| <span class="number">122</span> | <span class="number">10</span>   |</div><div class="line">| <span class="number">123</span> | <span class="number">11</span>   |</div><div class="line">| <span class="number">124</span> | <span class="number">12</span>   |</div><div class="line">| <span class="number">125</span> | <span class="number">13</span>   |</div><div class="line">| <span class="number">126</span> | <span class="number">14</span>   |</div><div class="line">| <span class="number">127</span> | <span class="number">15</span>   |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">14</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave (candidate master) host_1</div><div class="line"></div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000004</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">3683</span></div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">114</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">115</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">116</span> | <span class="number">3</span>    |</div><div class="line">| <span class="number">117</span> | <span class="number">4</span>    |</div><div class="line">| <span class="number">118</span> | <span class="number">5</span>    |</div><div class="line">| <span class="number">119</span> | <span class="number">6</span>    |</div><div class="line">| <span class="number">120</span> | <span class="number">7</span>    |</div><div class="line">| <span class="number">121</span> | <span class="number">8</span>    |</div><div class="line">| <span class="number">122</span> | <span class="number">10</span>   |</div><div class="line">| <span class="number">123</span> | <span class="number">11</span>   |</div><div class="line">| <span class="number">124</span> | <span class="number">12</span>   |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">11</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">* etl (other slave) host_3</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000004</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">2789</span></div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">114</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">115</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">116</span> | <span class="number">3</span>    |</div><div class="line">| <span class="number">117</span> | <span class="number">4</span>    |</div><div class="line">| <span class="number">118</span> | <span class="number">5</span>    |</div><div class="line">| <span class="number">119</span> | <span class="number">6</span>    |</div><div class="line">| <span class="number">120</span> | <span class="number">7</span>    |</div><div class="line">| <span class="number">121</span> | <span class="number">8</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">8</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line"></div><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host=host_2  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>) ..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] Starting Non-GTID based failover.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">08</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">09</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">09</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">09</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span> host_2 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-14 17:13:09--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [<span class="type">text</span>/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">7.19</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> (<span class="number">7.19</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_2<span class="number">.000004</span>:<span class="number">3683</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_2<span class="number">.000004</span>:<span class="number">2789</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Fetching dead master's binary logs..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">11</span> <span class="number">2017</span> - [info] Executing command <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> dead master host_2(host_2:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_2.000004  --start_pos=3683 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /var/<span class="command">log</span>/masterha/mha_test <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_2<span class="number">.000004</span> pos <span class="number">3683</span> <span class="keyword">to</span> host_2<span class="number">.000004</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog ..</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">150.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql.bin/host_2<span class="number">.000004</span> position <span class="number">3683</span> <span class="keyword">to</span> tail(<span class="number">4596</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@host_2:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog <span class="keyword">to</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] Finding <span class="keyword">the</span> latest slave <span class="keyword">that</span> has all relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] Checking whether host_1 has relay logs <span class="keyword">from</span> <span class="keyword">the</span> oldest position..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">12</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_2.000004 --latest_rmlp=3683 --target_mlf=host_2.000004 --target_rmlp=2789 --server_id=1261261646 --workdir=/var/log/masterha/mha_test --timestamp=20171114171308 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_1-relay-bin.000003  :</span></div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_1-relay-bin<span class="number">.000003</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_1-relay-bin<span class="number">.000003</span>, start_pos:<span class="number">269.</span></div><div class="line">Target relay <span class="command">log</span> FOUND!</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] OK. host_1 has all relay logs.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_1(host_1:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog <span class="keyword">to</span> root@host_1:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] *NOTICE: If any <span class="keyword">error</span> happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] This slave(host_1)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000004</span>:<span class="number">3683</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_1, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_1 --slave_ip=host_1  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171114171308 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog <span class="function_start"><span class="keyword">on</span></span> host_1:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  host_1<span class="number">.000003</span>:<span class="number">2347</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_1', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='host_1<span class="number">.000003</span>', MASTER_LOG_POS=<span class="number">2347</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --new_master_host=host_1 --new_master_ip=host_1 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span> host_1  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 29885. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171114171308.log if it takes time..</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Server host_3 received relay logs up <span class="keyword">to</span>: host_2<span class="number">.000004</span>:<span class="number">2789</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Need <span class="keyword">to</span> <span class="keyword">get</span> diffs <span class="keyword">from</span> <span class="keyword">the</span> latest slave(host_1) up <span class="keyword">to</span>: host_2<span class="number">.000004</span>:<span class="number">3683</span> (using <span class="keyword">the</span> latest slave's relay logs)</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> latest slave host host_1, generating diff relay <span class="command">log</span> files..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=generate_and_send --scp_user=root --scp_host=host_3 --latest_mlf=host_2.000004 --latest_rmlp=3683 --target_mlf=host_2.000004 --target_rmlp=2789 --server_id=1261261646 --diff_file_readtolatest=/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog --workdir=/var/log/masterha/mha_test --timestamp=20171114171308 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_1-relay-bin.000003</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_1-relay-bin<span class="number">.000003</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_1-relay-bin<span class="number">.000003</span>, start_pos:<span class="number">269.</span></div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_1-relay-bin<span class="number">.000003</span> pos <span class="number">269</span> <span class="keyword">to</span> host_1-relay-bin<span class="number">.000003</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog ..</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">269.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql_data/host_1-relay-bin<span class="number">.000003</span> position <span class="number">269</span> <span class="keyword">to</span> tail(<span class="number">1163</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay <span class="command">log</span> succeeded. Saved <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog .</div><div class="line"> scp host_1<span class="number">.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog <span class="keyword">to</span> root@host_3(<span class="number">22</span>) succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Generating diff files succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff log generation on host host_3(host_3:3306) succeeded.</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 31393. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171114171308.log if it takes time..</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog <span class="keyword">to</span> root@host_3:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] This slave(host_3)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000004</span>:<span class="number">2789</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_3, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_3 --slave_ip=host_3  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog,/var/log/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171114171308 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line"> Concat all apply files <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_3_3306<span class="number">.20171114171308</span>.binlog ..</div><div class="line"> Copying <span class="keyword">the</span> <span class="keyword">first</span> binlog <span class="type">file</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_3_3306<span class="number">.20171114171308</span>.binlog.. ok.</div><div class="line">  Dumping binlog head events (rotate events), skipping format description events <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog.. dumped up <span class="keyword">to</span> pos <span class="number">150.</span> ok.</div><div class="line"> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog has effective binlog events <span class="keyword">from</span> pos <span class="number">150.</span></div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog position <span class="number">150</span> <span class="keyword">to</span> tail(<span class="number">1063</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">All apply target binary logs are concatinated <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_3_3306<span class="number">.20171114171308</span>.binlog .</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171114171308.binlog,/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_2_3306_20171114171308.binlog <span class="function_start"><span class="keyword">on</span></span> host_3:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  host_1: Resetting slave info succeeded.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover host_2(host_2:<span class="number">3306</span>) <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_2(host_2:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/mha_test.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">The latest slave host_1(host_1:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_1(host_1:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): Generating differential relay logs up <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>)succeeded.</div><div class="line">Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">host_1(host_1:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">13</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Sending mail..</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">## 切换结果</span></div><div class="line"></div><div class="line">new master 和 new etl</div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">114</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">115</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">116</span> | <span class="number">3</span>    |</div><div class="line">| <span class="number">117</span> | <span class="number">4</span>    |</div><div class="line">| <span class="number">118</span> | <span class="number">5</span>    |</div><div class="line">| <span class="number">119</span> | <span class="number">6</span>    |</div><div class="line">| <span class="number">120</span> | <span class="number">7</span>    |</div><div class="line">| <span class="number">121</span> | <span class="number">8</span>    |</div><div class="line">| <span class="number">122</span> | <span class="number">10</span>   |</div><div class="line">| <span class="number">123</span> | <span class="number">11</span>   |</div><div class="line">| <span class="number">124</span> | <span class="number">12</span>   |</div><div class="line">| <span class="number">125</span> | <span class="number">13</span>   |</div><div class="line">| <span class="number">126</span> | <span class="number">14</span>   |</div><div class="line">| <span class="number">127</span> | <span class="number">15</span>   |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">14</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div></pre></td></tr></table></figure>

<ul>
<li>1.3.2 当master的所有日志已经传递slave，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 模拟现场，现场的3台DB binlog状态</span></div><div class="line"></div><div class="line">* master host_1</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| host_1<span class="number">.000010</span> |     <span class="number">3341</span> |              |                  |                   |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">167</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">168</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">169</span> | <span class="number">3</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">* slave host_2</div><div class="line"></div><div class="line">              Master_Log_File: host_1<span class="number">.000010</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">3341</span></div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">167</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">168</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">169</span> | <span class="number">3</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">3</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* etl host_3</div><div class="line"></div><div class="line">              Master_Log_File: host_1<span class="number">.000010</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">2381</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Starting Non-GTID based failover.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">36</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">37</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span> host_1 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-15 10:39:37--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [<span class="type">text</span>/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">11.4</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> (<span class="number">11.4</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_1<span class="number">.000010</span>:<span class="number">3341</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span> host_1<span class="number">.000010</span>:<span class="number">2381</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] Fetching dead master's binary logs..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] Executing command <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> dead master host_1(host_1:<span class="number">3306</span>): save_binary_logs <span class="comment">--command=save --start_file=host_1.000010  --start_pos=3341 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /var/<span class="command">log</span>/masterha/mha_test <span class="keyword">if</span> <span class="keyword">not</span> exists..    ok.</div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_1<span class="number">.000010</span> pos <span class="number">3341</span> <span class="keyword">to</span> host_1<span class="number">.000010</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog ..</div><div class="line"> Binlog Checksum enabled</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">154.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql.bin/host_1<span class="number">.000010</span> position <span class="number">3341</span> <span class="keyword">to</span> tail(<span class="number">3364</span>).. ok.</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Concat succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">39</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@host_1:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog <span class="keyword">to</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Finding <span class="keyword">the</span> latest slave <span class="keyword">that</span> has all relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Checking whether host_2 has relay logs <span class="keyword">from</span> <span class="keyword">the</span> oldest position..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_1.000010 --latest_rmlp=3341 --target_mlf=host_1.000010 --target_rmlp=2381 --server_id=1261261656 --workdir=/var/log/masterha/mha_test --timestamp=20171115103936 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_2-relay-bin.000002  :</span></div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_2-relay-bin<span class="number">.000002</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_2-relay-bin<span class="number">.000002</span>, start_pos:<span class="number">636.</span></div><div class="line">Target relay <span class="command">log</span> FOUND!</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] OK. host_2 has all relay logs.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info]  This server has all relay logs. No need <span class="keyword">to</span> generate diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog <span class="keyword">to</span> root@host_2:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] *NOTICE: If any <span class="keyword">error</span> happens <span class="keyword">from</span> this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] This slave(host_2)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_1<span class="number">.000010</span>:<span class="number">3341</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_2, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_2 --slave_ip=host_2  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171115103936 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog <span class="function_start"><span class="keyword">on</span></span> host_2:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  host_2<span class="number">.000011</span>:<span class="number">1307</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST='host_2', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE='host_2<span class="number">.000011</span>', MASTER_LOG_POS=<span class="number">1307</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span> host_2  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 11760. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171115103936.log if it takes time..</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Server host_3 received relay logs up <span class="keyword">to</span>: host_1<span class="number">.000010</span>:<span class="number">2381</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Need <span class="keyword">to</span> <span class="keyword">get</span> diffs <span class="keyword">from</span> <span class="keyword">the</span> latest slave(host_2) up <span class="keyword">to</span>: host_1<span class="number">.000010</span>:<span class="number">3341</span> (using <span class="keyword">the</span> latest slave's relay logs)</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> latest slave host host_2, generating diff relay <span class="command">log</span> files..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=generate_and_send --scp_user=root --scp_host=host_3 --latest_mlf=host_1.000010 --latest_rmlp=3341 --target_mlf=host_1.000010 --target_rmlp=2381 --server_id=1261261656 --diff_file_readtolatest=/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog --workdir=/var/log/masterha/mha_test --timestamp=20171115103936 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_2-relay-bin.000002</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">    Relay <span class="command">log</span> found <span class="keyword">at</span> /data/mysql_data, up <span class="keyword">to</span> host_2-relay-bin<span class="number">.000002</span></div><div class="line"> Fast relay <span class="command">log</span> position search succeeded.</div><div class="line"> Target relay <span class="command">log</span> <span class="type">file</span>/position found. start_file:host_2-relay-bin<span class="number">.000002</span>, start_pos:<span class="number">636.</span></div><div class="line"> Concat binary/relay logs <span class="keyword">from</span> host_2-relay-bin<span class="number">.000002</span> pos <span class="number">636</span> <span class="keyword">to</span> host_2-relay-bin<span class="number">.000002</span> EOF <span class="keyword">into</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog ..</div><div class="line"> Binlog Checksum enabled</div><div class="line">  Dumping binlog format description event, <span class="keyword">from</span> position <span class="number">0</span> <span class="keyword">to</span> <span class="number">315.</span>. ok.</div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /data/mysql_data/host_2-relay-bin<span class="number">.000002</span> position <span class="number">636</span> <span class="keyword">to</span> tail(<span class="number">1596</span>).. ok.</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay <span class="command">log</span> succeeded. Saved <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog .</div><div class="line"> scp host_2<span class="number">.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog <span class="keyword">to</span> root@host_3(<span class="number">22</span>) succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Generating diff files succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff log generation on host host_3(host_3:3306) succeeded.</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 12881. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171115103936.log if it takes time..</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span> host_3 ...</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Sending binlog..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog <span class="keyword">to</span> root@host_3:/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Starting recovery <span class="function_start"><span class="keyword">on</span></span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> all relay logs are applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] This slave(host_3)'s Exec_Master_Log_Pos <span class="keyword">equals</span> <span class="keyword">to</span> Read_Master_Log_Pos(host_1<span class="number">.000010</span>:<span class="number">2381</span>). No need <span class="keyword">to</span> recover <span class="keyword">from</span> Exec_Master_Log_Pos.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> <span class="keyword">the</span> target slave host host_3, <span class="property">running</span> recover <span class="keyword">script</span>..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">39</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_3 --slave_ip=host_3  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog,/var/log/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171115103936 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line"> Concat all apply files <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_3_3306<span class="number">.20171115103936</span>.binlog ..</div><div class="line"> Copying <span class="keyword">the</span> <span class="keyword">first</span> binlog <span class="type">file</span> /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog <span class="keyword">to</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_3_3306<span class="number">.20171115103936</span>.binlog.. ok.</div><div class="line">  Dumping binlog head events (rotate events), skipping format description events <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog..  Binlog Checksum enabled</div><div class="line">dumped up <span class="keyword">to</span> pos <span class="number">154.</span> ok.</div><div class="line"> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog has effective binlog events <span class="keyword">from</span> pos <span class="number">154.</span></div><div class="line">  Dumping effective binlog data <span class="keyword">from</span> /var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog position <span class="number">154</span> <span class="keyword">to</span> tail(<span class="number">177</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line">All apply target binary logs are concatinated <span class="keyword">at</span> /var/<span class="command">log</span>/masterha/mha_test/total_binlog_for_host_3_3306<span class="number">.20171115103936</span>.binlog .</div><div class="line">MySQL client <span class="property">version</span> <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay <span class="command">log</span> files /var/<span class="command">log</span>/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171115103936.binlog,/var/<span class="command">log</span>/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171115103936.binlog <span class="function_start"><span class="keyword">on</span></span> host_3:<span class="number">3306.</span> This may take long <span class="property">time</span>...</div><div class="line">Applying <span class="command">log</span> files succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  All relay logs were successfully applied.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span> host_3.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  host_2: Resetting slave info succeeded.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/mha_test.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest slave host_2(host_2:<span class="number">3306</span>) has all relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): Generating differential relay logs up <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>)succeeded.</div><div class="line">Generating relay diff files <span class="keyword">from</span> <span class="keyword">the</span> latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying all logs succeeded. Slave started, replicating <span class="keyword">from</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Wed Nov <span class="number">15</span> <span class="number">10</span>:<span class="number">40</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Sending mail..</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换结果</span></div><div class="line"></div><div class="line">new master & new etl 数据一致</div><div class="line"></div><div class="line">dba:lc&gt; select * <span class="keyword">from</span> t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="property">id</span>  | <span class="property">name</span> |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">167</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">168</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">169</span> | <span class="number">3</span>    |</div></pre></td></tr></table></figure>

<h3 id="1-4_slave(候选master）上面有大事务在跑">1.4 slave(候选master）上面有大事务在跑</h3>
<ul>
<li>1000s的大查询</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">无影响，正常切换</div></pre></td></tr></table></figure>

<h3 id="1-5_如果MHA过程中失败，是否可以重新执行MHA的failover呢？">1.5 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</h3>
<ul>
<li><p>90%的场景都是可以重新执行的</p>
</li>
<li><p>5%的场景不能执行</p>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">* NO。1</div><div class="line">	问题： dead master上面的vip已经<span class="operator"><span class="keyword">delete</span>，再次failover 这一步会报错</span></div><div class="line">	方案： a）将dead <span class="keyword">master</span>上的vip再重新<span class="keyword">add</span>上去  或者 b）直接过滤掉 <span class="keyword">delete</span> dead <span class="keyword">master</span> vip这一步</div></pre></td></tr></table></figure>

<ul>
<li>5%的场景不能再次执行，执行会报错</li>
</ul>
<blockquote>
<p>一般这种场景就是：已经failover到最后的change master阶段，这样主从结构已经变更( candidate slave &lt;==rep==  etl     )，MHA无法重新走一遍。<br>好在，change master的语句已经生成，其余slave再次执行一遍日志里面的change master即可</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Thu Nov  9 16:49:39 2017 - [info] GTID failover mode = 0</div><div class="line">Thu Nov  9 16:49:39 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln169</span>] Detected dead master host<span class="emphasis">_1(host_</span>1:3306) does not match with specified dead master host<span class="emphasis">_2(host_</span>2:3306)!</div><div class="line">Thu Nov  9 16:49:39 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177</span>] Got ERROR:  at /usr/bin/masterha<span class="emphasis">_master_</span>switch line 53</div></pre></td></tr></table></figure>

<h3 id="1-7_Master：MySQL_down小结">1.7 Master：MySQL down小结</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="comment">1</span><span class="string">.</span> <span class="comment">failover最终命令</span></div><div class="line"></div><div class="line"><span class="comment">masterha_master_switch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">global_conf=/data/online/agent/MHA/conf/masterha_default</span><span class="string">.</span><span class="comment">cnf</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf=/data/online/agent/MHA/conf/bak_mha_test</span><span class="string">.</span><span class="comment">cnf</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_host=$dead_master_ip</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_port=3306</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master_state=dead</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">interactive=0</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_last_failover</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_binlog_server_error</span></div></pre></td></tr></table></figure>

<h2 id="二、Master_:_Server_down">二、Master : Server down</h2>
<h3 id="2-1_etl_延迟8小时">2.1 etl 延迟8小时</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">同1.1 结论</div></pre></td></tr></table></figure>

<h3 id="2-2_slave(候选master)比etl还要落后更多">2.2 slave(候选master)比etl还要落后更多</h3>
<ul>
<li>2.2.1 当master的部分日志还没传递两个slave，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div></pre></td><td class="code"><pre><div class="line">### <span class="number">3</span>台DB的binlog状态</div><div class="line"></div><div class="line">* master</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| <span class="keyword">File</span>                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| host_2<span class="number">.000012</span> |     <span class="number">1651</span> |              |                  |                   |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc&gt;</div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| id  | name |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">172</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">173</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">174</span> | <span class="number">3</span>    |</div><div class="line">| <span class="number">175</span> | <span class="number">4</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">4</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000012</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">467</span></div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">Empty set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">* etl</div><div class="line"></div><div class="line">              Master_Log_File: host_2<span class="number">.000012</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">1059</span></div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| id  | name |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">172</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">173</span> | <span class="number">2</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">### 模拟故障场景</div><div class="line"></div><div class="line">* 隔离master的网络，让其等同于down机</div><div class="line"></div><div class="line">master&gt; iptables -A INPUT -p tcp -s other_ip <span class="comment">--dport 22 -j ACCEPT</span></div><div class="line">master&gt; iptables -A INPUT -p tcp -s <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span> -j DROP</div><div class="line"></div><div class="line">### 切换日志</div><div class="line"></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info] MHA::MasterFailover version <span class="number">0.56</span>.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: <span class="keyword">Configuration</span> Check Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no error) <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no error) <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">40</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (no_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>) ..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Starting Non-GTID based failover.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: <span class="keyword">Configuration</span> Check Phase completed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">54</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">31</span> <span class="number">2017</span> - [warning] HealthCheck: Got timeout <span class="keyword">on</span> checking SSH connection <span class="keyword">to</span> host_2! at /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">31</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never connect <span class="keyword">to</span> the current master..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">31</span> <span class="number">2017</span> - [info] Executing master IP deactivation script:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">55</span>:<span class="number">31</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --command=stop</span></div><div class="line">ssh: connect <span class="keyword">to</span> host host_2 <span class="keyword">port</span> <span class="number">22</span>: Connection timed <span class="keyword">out</span></div><div class="line">===================    swift vip :  tgw_vip from host_2 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-16 16:55:38--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [text/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">12.1</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> (<span class="number">12.1</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> set. Skipping explicit shutting down <span class="keyword">of</span> the dead master.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] The latest binary log <span class="keyword">file</span>/position <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_2<span class="number">.000012</span>:<span class="number">1059</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay log files <span class="keyword">to</span> the latest):</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (no_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] The oldest binary log <span class="keyword">file</span>/position <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_2<span class="number">.000012</span>:<span class="number">467</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master<span class="attribute">'s</span> Binlog Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [warning] Dead Master <span class="keyword">is</span> <span class="keyword">not</span> SSH reachable. Could <span class="keyword">not</span> save it<span class="attribute">'s</span> binlogs. Transactions that were <span class="keyword">not</span> sent <span class="keyword">to</span> the latest slave (Read_Master_Log_Pos <span class="keyword">to</span> the tail <span class="keyword">of</span> the dead master<span class="attribute">'s</span> binlog) were lost.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> Master Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">36</span> <span class="number">2017</span> - [info] Finding the latest slave that has <span class="keyword">all</span> relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Checking whether host_3 has relay logs from the oldest position..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_2.000012 --latest_rmlp=1059 --target_mlf=host_2.000012 --target_rmlp=467 --server_id=1261261666 --workdir=/var/log/masterha/mha_test --timestamp=20171116165440 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3-relay-bin.000004  :</span></div><div class="line">    Relay log found at /data/mysql_data, up <span class="keyword">to</span> host_3-relay-bin<span class="number">.000004</span></div><div class="line"> Fast relay log position search succeeded.</div><div class="line"> Target relay log <span class="keyword">file</span>/position found. start_file:host_3-relay-bin<span class="number">.000004</span>, start_pos:<span class="number">678.</span></div><div class="line">Target relay log FOUND!</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] OK. host_3 has <span class="keyword">all</span> relay logs.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Searching <span class="keyword">new</span> master from slaves..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]  Candidate masters from the <span class="keyword">configuration</span> <span class="keyword">file</span>:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]     Replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]     Replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (no_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay log events..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]   <span class="keyword">Not</span> found.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]  Searching from <span class="keyword">all</span> candidate_master slaves..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] <span class="keyword">New</span> master <span class="keyword">is</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_1(host_1:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (<span class="keyword">new</span> master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> Master Diff Log Generation Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Server host_1 received relay logs up <span class="keyword">to</span>: host_2<span class="number">.000012</span>:<span class="number">467</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">37</span> <span class="number">2017</span> - [info] Need <span class="keyword">to</span> get diffs from the latest slave(host_3) up <span class="keyword">to</span>: host_2<span class="number">.000012</span>:<span class="number">1059</span> (using the latest slave<span class="attribute">'s</span> relay logs)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> the latest slave host host_3, generating diff relay log files..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=generate_and_send --scp_user=root --scp_host=host_1 --latest_mlf=host_2.000012 --latest_rmlp=1059 --target_mlf=host_2.000012 --target_rmlp=467 --server_id=1261261666 --diff_file_readtolatest=/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171116165440.binlog --workdir=/var/log/masterha/mha_test --timestamp=20171116165440 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_3-relay-bin.000004</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info]</div><div class="line">    Relay log found at /data/mysql_data, up <span class="keyword">to</span> host_3-relay-bin<span class="number">.000004</span></div><div class="line"> Fast relay log position search succeeded.</div><div class="line"> Target relay log <span class="keyword">file</span>/position found. start_file:host_3-relay-bin<span class="number">.000004</span>, start_pos:<span class="number">678.</span></div><div class="line"> Concat binary/relay logs from host_3-relay-bin<span class="number">.000004</span> pos <span class="number">678</span> <span class="keyword">to</span> host_3-relay-bin<span class="number">.000004</span> EOF into /var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171116165440.binlog ..</div><div class="line">  Dumping binlog format description event, from position <span class="number">0</span> <span class="keyword">to</span> <span class="number">361.</span>. ok.</div><div class="line">  Dumping effective binlog data from /data/mysql_data/host_3-relay-bin<span class="number">.000004</span> position <span class="number">678</span> <span class="keyword">to</span> tail(<span class="number">1270</span>).. ok.</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay log succeeded. Saved at /var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171116165440.binlog .</div><div class="line"> scp host_3<span class="number">.58</span>os.org:/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171116165440.binlog <span class="keyword">to</span> root@host_1(<span class="number">22</span>) succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info]  Generating diff files succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] *NOTICE: <span class="keyword">If</span> any error happens from this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Starting recovery <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> <span class="keyword">all</span> relay logs are applied.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] This slave(host_1)<span class="attribute">'s</span> Exec_Master_Log_Pos equals <span class="keyword">to</span> Read_Master_Log_Pos(host_2<span class="number">.000012</span>:<span class="number">467</span>). No need <span class="keyword">to</span> recover from Exec_Master_Log_Pos.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> the target slave host host_1, running recover script..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">38</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_1 --slave_ip=host_1  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171116165440.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171116165440 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info]</div><div class="line">MySQL client version <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay log files /var/log/masterha/mha_test/relay_from_read_to_latest_host_1_3306_20171116165440.binlog <span class="keyword">on</span> host_1:<span class="number">3306.</span> This may take long <span class="typename">time</span>...</div><div class="line">Applying log files succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info]  <span class="keyword">All</span> relay logs were successfully applied.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info] Getting <span class="keyword">new</span> master<span class="attribute">'s</span> binlog name <span class="keyword">and</span> position..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info]  host_1<span class="number">.000012</span>:<span class="number">1310</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info]  <span class="keyword">All</span> other slaves should start replication from here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST=<span class="attribute">'host_1</span>', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE=<span class="attribute">'host_1</span><span class="number">.000012</span>', MASTER_LOG_POS=<span class="number">1310</span>, MASTER_USER=<span class="attribute">'repl</span>', MASTER_PASSWORD=<span class="attribute">'xxx</span>';</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info] Executing master IP activate script:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">39</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host=host_2 --orig_master_ip=host_2 --orig_master_port=3306 --new_master_host=host_1 --new_master_ip=host_1 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span> host_1  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 123011. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171116165440.log if it takes time..</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Log messages from host_3 ...</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  This server has <span class="keyword">all</span> relay logs. No need <span class="keyword">to</span> <span class="keyword">generate</span> diff files from the latest slave.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> log messages from host_3.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="comment">-- host_3(host_3:3306) has the latest relay log events.</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Generating relay diff files from the latest slave succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 123044. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171116165440.log if it takes time..</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Log messages from host_3 ...</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Starting recovery <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  This server has <span class="keyword">all</span> relay logs. Waiting <span class="keyword">all</span> logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  <span class="keyword">All</span> relay logs were successfully applied.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication from the <span class="keyword">new</span> master host_1(host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> log messages from host_3.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> slave servers recovered successfully.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> master cleanup phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Resetting slave info <span class="keyword">on</span> the <span class="keyword">new</span> master..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  host_1: Resetting slave info succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">16</span>:<span class="number">57</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover host_2(host_2:<span class="number">3306</span>) <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_2(host_2:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs at tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/log/masterha/mha_test/mha_test.log <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="keyword">on</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">The latest slave host_3(host_3:<span class="number">3306</span>) has <span class="keyword">all</span> relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_1(host_1:<span class="number">3306</span>) as a <span class="keyword">new</span> master.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> logs succeeded.</div><div class="line">host_1(host_1:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): This host has the latest relay log events.</div><div class="line">Generating relay diff files from the latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> logs succeeded. Slave started, replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">host_1(host_1:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_1(host_1:<span class="number">3306</span>) completed successfully.</div><div class="line"></div><div class="line">### 切换后的结果</div><div class="line"></div><div class="line">new_master & new_etl 结果一致，由于master上面未传过来的binlog彻底丢失，所以相应的新集群也缺失这些数据。</div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| id  | name |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">172</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">173</span> | <span class="number">2</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">### 最后一步很重要</div><div class="line"></div><div class="line">如果dead master之后又活过来了，那么这一步要做</div><div class="line"></div><div class="line">dead_master&gt; /usr/local/realserver/RS_TUNL0/etc/setup_rs.sh -c</div><div class="line"></div><div class="line">http://gitlab.corp.anjuke.com/_dba/<span class="keyword">architecture</span>/blob/master/personal/Keithlan/other/share/tools/always_used_command.md  ==》 tgw章节详细描述</div></pre></td></tr></table></figure>

<ul>
<li>2.2.2 当master的所有日志已经传递到1个etl，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">测试省略，和2.2.1基本一样</div></pre></td></tr></table></figure>

<p>结论：由于master上的所有日志全部传递到etl，所以最后是不会丢失master上任何数据的。</p>
<h3 id="2-3_slave(候选master)的日志是最新的，比etl要多">2.3 slave(候选master)的日志是最新的，比etl要多</h3>
<ul>
<li>2.3.1 当master的部分日志还没传递两个slave，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div></pre></td><td class="code"><pre><div class="line">### <span class="number">3</span>台DB的binlog状态</div><div class="line"></div><div class="line">* master</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| <span class="keyword">File</span>                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line">| host_1<span class="number">.000012</span> |     <span class="number">3860</span> |              |                  |                   |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+-------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| id  | name |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">176</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">177</span> | <span class="number">2</span>    |</div><div class="line">| <span class="number">178</span> | <span class="number">10</span>   |</div><div class="line">| <span class="number">179</span> | <span class="number">20</span>   |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">4</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave</div><div class="line"></div><div class="line">              Master_Log_File: host_1<span class="number">.000012</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">3216</span></div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| id  | name |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">176</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">177</span> | <span class="number">2</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* etl</div><div class="line"></div><div class="line">              Master_Log_File: host_1<span class="number">.000012</span></div><div class="line">          Exec_Master_Log_Pos: <span class="number">2576</span></div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">Empty set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">### 模拟故障场景</div><div class="line"></div><div class="line">* 隔离master的网络，让其等同于down机</div><div class="line"></div><div class="line">master&gt; iptables -A INPUT -p tcp -s other_ip <span class="comment">--dport 22 -j ACCEPT</span></div><div class="line">master&gt; iptables -A INPUT -p tcp -s <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span> -j DROP</div><div class="line"></div><div class="line">### 切换日志</div><div class="line"></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info] MHA::MasterFailover version <span class="number">0.56</span>.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: <span class="keyword">Configuration</span> Check Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no error) <span class="keyword">on</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no error) <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">0</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info]   host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">17</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     Replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (no_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="keyword">on</span> host_2(host_2:<span class="number">3306</span>) ..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>) ..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Starting Non-GTID based failover.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: <span class="keyword">Configuration</span> Check Phase completed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">50</span> <span class="number">2017</span> - [warning] HealthCheck: Got timeout <span class="keyword">on</span> checking SSH connection <span class="keyword">to</span> host_1! at /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never connect <span class="keyword">to</span> the current master..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Executing master IP deactivation script:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">18</span>:<span class="number">50</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --command=stop</span></div><div class="line">ssh: connect <span class="keyword">to</span> host host_1 <span class="keyword">port</span> <span class="number">22</span>: Connection timed <span class="keyword">out</span></div><div class="line">===================    swift vip :  tgw_vip from host_1 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-16 17:18:57--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [text/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">8.61</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> (<span class="number">8.61</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> set. Skipping explicit shutting down <span class="keyword">of</span> the dead master.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] The latest binary log <span class="keyword">file</span>/position <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1<span class="number">.000012</span>:<span class="number">3216</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay log files <span class="keyword">to</span> the latest):</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]     Replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] The oldest binary log <span class="keyword">file</span>/position <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span> host_1<span class="number">.000012</span>:<span class="number">2576</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]     Replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (no_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.2</span>: Saving Dead Master<span class="attribute">'s</span> Binlog Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [warning] Dead Master <span class="keyword">is</span> <span class="keyword">not</span> SSH reachable. Could <span class="keyword">not</span> save it<span class="attribute">'s</span> binlogs. Transactions that were <span class="keyword">not</span> sent <span class="keyword">to</span> the latest slave (Read_Master_Log_Pos <span class="keyword">to</span> the tail <span class="keyword">of</span> the dead master<span class="attribute">'s</span> binlog) were lost.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining <span class="keyword">New</span> Master Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Finding the latest slave that has <span class="keyword">all</span> relay logs <span class="keyword">for</span> recovering other slaves..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Checking whether host_2 has relay logs from the oldest position..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=find --latest_mlf=host_1.000012 --latest_rmlp=3216 --target_mlf=host_1.000012 --target_rmlp=2576 --server_id=1261261656 --workdir=/var/log/masterha/mha_test --timestamp=20171116171759 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_2-relay-bin.000002  :</span></div><div class="line">    Relay log found at /data/mysql_data, up <span class="keyword">to</span> host_2-relay-bin<span class="number">.000002</span></div><div class="line"> Fast relay log position search succeeded.</div><div class="line"> Target relay log <span class="keyword">file</span>/position found. start_file:host_2-relay-bin<span class="number">.000002</span>, start_pos:<span class="number">1581.</span></div><div class="line">Target relay log FOUND!</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] OK. host_2 has <span class="keyword">all</span> relay logs.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span> host_3 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Searching <span class="keyword">new</span> master from slaves..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  Candidate masters from the <span class="keyword">configuration</span> <span class="keyword">file</span>:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]   host_2(host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]     Replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (candidate_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]   host_3(host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]     Replicating from host_1(host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the <span class="keyword">new</span> Master (no_master <span class="keyword">is</span> set)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  Searching from candidate_master slaves which have received the latest relay log events..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] <span class="keyword">New</span> master <span class="keyword">is</span> host_2(host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line">host_1(host_1:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">--host_2(host_2:3306)</span></div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line"></div><div class="line"><span class="keyword">To</span>:</div><div class="line">host_2(host_2:<span class="number">3306</span>) (<span class="keyword">new</span> master)</div><div class="line"> +<span class="comment">--host_3(host_3:3306)</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: <span class="keyword">New</span> Master Diff Log Generation Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  This server has <span class="keyword">all</span> relay logs. No need <span class="keyword">to</span> <span class="keyword">generate</span> diff files from the latest slave.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] *NOTICE: <span class="keyword">If</span> any error happens from this phase, manual recovery <span class="keyword">is</span> needed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Starting recovery <span class="keyword">on</span> host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  This server has <span class="keyword">all</span> relay logs. Waiting <span class="keyword">all</span> logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  <span class="keyword">All</span> relay logs were successfully applied.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Getting <span class="keyword">new</span> master<span class="attribute">'s</span> binlog name <span class="keyword">and</span> position..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  host_2<span class="number">.000012</span>:<span class="number">3959</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]  <span class="keyword">All</span> other slaves should start replication from here. Statement should be: CHANGE MASTER <span class="keyword">TO</span> MASTER_HOST=<span class="attribute">'host_2</span>', MASTER_PORT=<span class="number">3306</span>, MASTER_LOG_FILE=<span class="attribute">'host_2</span><span class="number">.000012</span>', MASTER_LOG_POS=<span class="number">3959</span>, MASTER_USER=<span class="attribute">'repl</span>', MASTER_PASSWORD=<span class="attribute">'xxx</span>';</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info] Executing master IP activate script:</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">56</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host=host_1 --orig_master_ip=host_1 --orig_master_port=3306 --new_master_host=host_2 --new_master_ip=host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span> host_2  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff file generation on host host_3(host_3:3306) started, pid: 77007. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171116171759.log if it takes time..</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Log messages from host_3 ...</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Server host_3 received relay logs up <span class="keyword">to</span>: host_1<span class="number">.000012</span>:<span class="number">2576</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Need <span class="keyword">to</span> get diffs from the latest slave(host_2) up <span class="keyword">to</span>: host_1<span class="number">.000012</span>:<span class="number">3216</span> (using the latest slave<span class="attribute">'s</span> relay logs)</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> the latest slave host host_2, generating diff relay log files..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">20</span>:<span class="number">59</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=generate_and_send --scp_user=root --scp_host=host_3 --latest_mlf=host_1.000012 --latest_rmlp=3216 --target_mlf=host_1.000012 --target_rmlp=2576 --server_id=1261261656 --diff_file_readtolatest=/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171116171759.binlog --workdir=/var/log/masterha/mha_test --timestamp=20171116171759 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --relay_dir=/data/mysql_data --current_relay_log=host_2-relay-bin.000002</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">    Relay log found at /data/mysql_data, up <span class="keyword">to</span> host_2-relay-bin<span class="number">.000002</span></div><div class="line"> Fast relay log position search succeeded.</div><div class="line"> Target relay log <span class="keyword">file</span>/position found. start_file:host_2-relay-bin<span class="number">.000002</span>, start_pos:<span class="number">1581.</span></div><div class="line"> Concat binary/relay logs from host_2-relay-bin<span class="number">.000002</span> pos <span class="number">1581</span> <span class="keyword">to</span> host_2-relay-bin<span class="number">.000002</span> EOF into /var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171116171759.binlog ..</div><div class="line"> Binlog Checksum enabled</div><div class="line">  Dumping binlog format description event, from position <span class="number">0</span> <span class="keyword">to</span> <span class="number">315.</span>. ok.</div><div class="line">  Dumping effective binlog data from /data/mysql_data/host_2-relay-bin<span class="number">.000002</span> position <span class="number">1581</span> <span class="keyword">to</span> tail(<span class="number">2221</span>).. ok.</div><div class="line"> Binlog Checksum enabled</div><div class="line"> Concat succeeded.</div><div class="line"> Generating diff relay log succeeded. Saved at /var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171116171759.binlog .</div><div class="line"> scp host_2<span class="number">.58</span>os.org:/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171116171759.binlog <span class="keyword">to</span> root@host_3(<span class="number">22</span>) succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Generating diff files succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> log messages from host_3.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave diff log generation on host host_3(host_3:3306) succeeded.</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Generating relay diff files from the latest slave succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) started, pid: 78627. Check tmp log /var/log/masterha/mha_test/host_3_3306_20171116171759.log if it takes time..</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Log messages from host_3 ...</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Starting recovery <span class="keyword">on</span> host_3(host_3:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Generating diffs succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Waiting <span class="keyword">until</span> <span class="keyword">all</span> relay logs are applied.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Getting slave status..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] This slave(host_3)<span class="attribute">'s</span> Exec_Master_Log_Pos equals <span class="keyword">to</span> Read_Master_Log_Pos(host_1<span class="number">.000012</span>:<span class="number">2576</span>). No need <span class="keyword">to</span> recover from Exec_Master_Log_Pos.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Connecting <span class="keyword">to</span> the target slave host host_3, running recover script..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Executing command: apply_diff_relay_logs <span class="comment">--command=apply --slave_user='dba' --slave_host=host_3 --slave_ip=host_3  --slave_port=3306 --apply_files=/var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171116171759.binlog --workdir=/var/log/masterha/mha_test --target_version=5.7.13-log --timestamp=20171116171759 --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56 --slave_pass=xxx</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">MySQL client version <span class="keyword">is</span> <span class="number">5.7</span><span class="number">.13</span>. Using <span class="comment">--binary-mode.</span></div><div class="line">Applying differential binary/relay log files /var/log/masterha/mha_test/relay_from_read_to_latest_host_3_3306_20171116171759.binlog <span class="keyword">on</span> host_3:<span class="number">3306.</span> This may take long <span class="typename">time</span>...</div><div class="line">Applying log files succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  <span class="keyword">All</span> relay logs were successfully applied.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Resetting slave host_3(host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication from the <span class="keyword">new</span> master host_2(host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> log messages from host_3.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host host_3(host_3:3306) succeeded.</span></div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] <span class="keyword">All</span> <span class="keyword">new</span> slave servers recovered successfully.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: <span class="keyword">New</span> master cleanup phase..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Resetting slave info <span class="keyword">on</span> the <span class="keyword">new</span> master..</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]  host_2: Resetting slave info succeeded.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Nov <span class="number">16</span> <span class="number">17</span>:<span class="number">21</span>:<span class="number">00</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover host_1(host_1:<span class="number">3306</span>) <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master host_1(host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs at tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/log/masterha/mha_test/mha_test.log <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="keyword">on</span> host_1(host_1:<span class="number">3306</span>)</div><div class="line">The latest slave host_2(host_2:<span class="number">3306</span>) has <span class="keyword">all</span> relay logs <span class="keyword">for</span> recovery.</div><div class="line">Selected host_2(host_2:<span class="number">3306</span>) as a <span class="keyword">new</span> master.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> logs succeeded.</div><div class="line">host_2(host_2:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line">host_3(host_3:<span class="number">3306</span>): Generating differential relay logs up <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>)succeeded.</div><div class="line">Generating relay diff files from the latest slave succeeded.</div><div class="line">host_3(host_3:<span class="number">3306</span>): OK: Applying <span class="keyword">all</span> logs succeeded. Slave started, replicating from host_2(host_2:<span class="number">3306</span>)</div><div class="line">host_2(host_2:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span> host_2(host_2:<span class="number">3306</span>) completed successfully.</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### 切换后的结果</div><div class="line"></div><div class="line">new_master & new_etl 结果一致，由于master上面未传过来的binlog彻底丢失，所以相应的新集群也缺失这些数据。</div><div class="line"></div><div class="line">dba:lc&gt; <span class="keyword">select</span> * from t_char_2;</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| id  | name |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line">| <span class="number">176</span> | <span class="number">1</span>    |</div><div class="line">| <span class="number">177</span> | <span class="number">2</span>    |</div><div class="line">+<span class="comment">-----+------+</span></div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">### 最后一步很重要</div><div class="line"></div><div class="line">如果dead master之后又活过来了，那么这一步要做</div><div class="line"></div><div class="line">dead_master&gt; /usr/local/realserver/RS_TUNL0/etc/setup_rs.sh -c</div><div class="line"></div><div class="line">http://gitlab.corp.anjuke.com/_dba/<span class="keyword">architecture</span>/blob/master/personal/Keithlan/other/share/tools/always_used_command.md  ==》 tgw章节详细描述</div></pre></td></tr></table></figure>

<p>结论： 由于master 已挂，然而最后的日志没有传递到其他服务器，所以会丢失master没有传递过来的事务日志</p>
<ul>
<li>2.3.2 当master的所有日志已经传递slave，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">测试省略，和2.3.1基本一样</div></pre></td></tr></table></figure>

<p>结论：由于master上的所有日志全部传递到slave，所以最后是不会丢失master上任何数据的。</p>
<h3 id="2-4_slave(候选master）上面有大事务在跑">2.4 slave(候选master）上面有大事务在跑</h3>
<ul>
<li>1000s的大查询</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">同1.4结论</div></pre></td></tr></table></figure>

<ul>
<li>flush tables  with readlock</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">同1.4结论</div></pre></td></tr></table></figure>

<h3 id="2-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？">2.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">同1.6结论</div></pre></td></tr></table></figure>

<h2 id="三、遇到的坑">三、遇到的坑</h2>
<h3 id="3-1_交互模式下，如果没有及时敲’YES’，则终止切换">3.1 交互模式下，如果没有及时敲’YES’，则终止切换</h3>
<h3 id="3-2_如果在non-gtid模式的机器上，配置了binlog_server，会有什么影响呢？">3.2 如果在non-gtid模式的机器上，配置了binlog server，会有什么影响呢？</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">无影响</div></pre></td></tr></table></figure>

<h3 id="3-3_不要在relay-log的地方伪造日志">3.3 不要在relay-log的地方伪造日志</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">xx-relay-bin.000001</div><div class="line">xx-relay-bin.000002</div><div class="line">xx-relay-bin.000002.lc   --这个是伪造的，当时这个日志是自己解析的 mysqlbinlog -vv xx-relay-bin.000002 &gt; xx-relay-bin.000002.lc</div><div class="line"></div><div class="line">MHA在切换的时候报错如下：</div><div class="line"></div><div class="line">Reading xx-relay-bin.000002.lc</div><div class="line">Event too large: pos: 4, event<span class="emphasis">_length: 1163083840, event_</span>type: 32</div><div class="line"> at /usr/share/perl5/vendor_perl/MHA/BinlogPosFindManager.pm line 103</div><div class="line">Tue Nov 14 10:39:08 2017 - [warning] xx doesn't have all relay logs. Maybe some logs were purged.</div><div class="line">Tue Nov 14 10:39:08 2017 - [warning] None of latest servers have enough relay logs from oldest position. We can't recover oldest slaves.</div><div class="line">Tue Nov 14 10:39:08 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln947</span>] None of the latest slaves has enough relay logs for recovery.</div><div class="line">Tue Nov 14 10:39:08 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177</span>] Got ERROR:  at /usr/bin/masterha<span class="emphasis">_master_</span>switch line 53</div></pre></td></tr></table></figure>

<h3 id="3-4_flush_tables_with_read_lock_会阻塞">3.4  flush tables with read lock 会阻塞</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="header">dba:(none)&gt; show processlist;</span></div><div class="line">+----+------+----------------------+------+---------+------+------------------------------+------------------------------------------------------------------------------------------------------+</div><div class="line"><span class="header">| Id | User | Host                 | db   | Command | Time | State                        | Info                                                                                                 |</span></div><div class="line">+----+------+----------------------+------+---------+------+------------------------------+------------------------------------------------------------------------------------------------------+</div><div class="line">| 63 | dba  | localhost            | NULL | Query   |    0 | starting                     | show processlist                                                                                     |</div><div class="line">| 65 | dba  | xx:11164   | NULL | Sleep   |  121 |                              | NULL                                                                                                 |</div><div class="line">| 83 | dba  | new master:49022 | NULL | Query   |  176 | Waiting for global read lock | BINLOG '</div><div class="line">GpAKWhNYUy1LMAAAAGYHAAAAAG0AAAAAAAEAAmxjAAh0X2NoYXJfMgACAw8CLAEC</div><div class="line"><span class="header">GpAKWh5YUy1LJwAAAI0HAAAAAG |</span></div><div class="line">+----+------+----------------------+------+---------+------+------------------------------+------------------------------------------------------------------------------------------------------+</div><div class="line">3 rows in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">会卡在这一步</div><div class="line"><span class="code">    Tue Nov 14 15:16:23 2017 - [info] * Phase 4.2: Starting Parallel Slave Log Apply Phase..</span></div><div class="line"><span class="code">    --------------Waiting for global read lock-----------------</span></div><div class="line"></div><div class="line"></div><div class="line">那么后面的步骤都会卡住</div><div class="line"></div><div class="line"><span class="code">    * Phase 4.2: Starting Parallel Slave Log Apply Phase..</span></div><div class="line"><span class="code">        --将 当前需要恢复的slave 和 latest slave之间的diff日志 传送给 需要恢复的 slave</span></div><div class="line"><span class="code">        --将 latest slave 和 dead master之间的diff日志 传送给 需要恢复的 slave</span></div><div class="line"><span class="code">        --将 刚刚的差异日志依次apply 到需要恢复的slave</span></div><div class="line"><span class="code">        --Resetting slave ， Executed CHANGE MASTER to  new_master</span></div><div class="line"></div><div class="line"><span class="bullet">* </span>Phase 5: New master cleanup phase..</div><div class="line"><span class="code">    Resetting slave info on the new master.</span></div></pre></td></tr></table></figure>

<h3 id="3-5_binlog伪造">3.5 binlog伪造</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">Tue Nov 14 17:23:10 2017 - [info] Executing command on the dead master host_1(host_1:3306): save_binary_logs <span class="comment">--command=save --start_file=host_1.000003  --start_pos=4042 --binlog_dir=/data/mysql.bin --output_file=/var/log/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171114172304.binlog --handle_raw_binlog=1 --disable_log_bin=0 --manager_version=0.56</span></div><div class="line">  Creating /var/log/masterha/mha_test if not exists..    ok.</div><div class="line"> Concat binary/relay logs from host_1.000003 pos 4042 to host_1.000050 EOF into /var/log/masterha/mha_test/saved_master_binlog_from_host_1_3306_20171114172304.binlog ..</div><div class="line"> Binlog <span class="operator"><span class="keyword">Checksum</span> enabled</span></div><div class="line">  Dumping <span class="keyword">binlog</span> <span class="keyword">format</span> description <span class="keyword">event</span>, <span class="keyword">from</span> <span class="keyword">position</span> <span class="number">0</span> <span class="keyword">to</span> <span class="number">154.</span>. ok.</div><div class="line">  Dumping effective <span class="keyword">binlog</span> <span class="keyword">data</span> <span class="keyword">from</span> /<span class="keyword">data</span>/mysql.<span class="keyword">bin</span>/host_1<span class="number">.000003</span> <span class="keyword">position</span> <span class="number">4042</span> <span class="keyword">to</span> tail(<span class="number">4065</span>).. ok.</div><div class="line">Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span>: Target file /<span class="keyword">data</span>/mysql.<span class="keyword">bin</span>/host_1<span class="number">.000004</span> <span class="keyword">not</span> <span class="keyword">found</span>!</div><div class="line"> <span class="keyword">at</span> /usr/<span class="keyword">bin</span>/save_binary_logs line <span class="number">176</span></div><div class="line">Tue Nov <span class="number">14</span> <span class="number">17</span>:<span class="number">23</span>:<span class="number">10</span> <span class="number">2017</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterFailover.pm, ln760] Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">events</span> <span class="keyword">from</span> the orig <span class="keyword">master</span>. Maybe disks <span class="keyword">on</span> <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> <span class="keyword">not</span> accessible <span class="keyword">or</span> <span class="built_in">binary</span> <span class="keyword">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line"></div><div class="line">测试：</div><div class="line"></div><div class="line">有<span class="keyword">flush</span> + 无<span class="keyword">binlog</span>.xx + <span class="number">1</span>伪造  =  save <span class="keyword">binlog</span> <span class="comment">--成功</span></div><div class="line">有<span class="keyword">flush</span> + 有<span class="keyword">binlog</span>.xx + <span class="number">1</span>伪造  =  save <span class="keyword">binlog</span> <span class="comment">--失败</span></div><div class="line">无<span class="keyword">flush</span> + 无<span class="keyword">binlog</span>.xx + <span class="number">1</span>伪造  =  save <span class="keyword">binlog</span> <span class="comment">--成功</span></div><div class="line">无<span class="keyword">flush</span> + 有<span class="keyword">binlog</span>.xx + <span class="number">1</span>伪造  =  save <span class="keyword">binlog</span> <span class="comment">--失败</span></div><div class="line"></div><div class="line">说明，如果有伪造的<span class="keyword">binlog</span>，且后缀比之前的大，那么就会告警</div><div class="line"></div><div class="line">解析：</div><div class="line"></div><div class="line">/usr/<span class="keyword">bin</span>/save_binary_logs ==》</div><div class="line">        generate_diff_binary_log =&gt;</div><div class="line">            /usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/BinlogManager.pm ==》</div><div class="line">                concat_all_binlogs_from():: =&gt;</div><div class="line">                    start_num , end_num(如果出现伪造的<span class="keyword">binlog</span>，则会报错)</div></pre></td></tr></table></figure>

<h2 id="四、总结">四、总结</h2>
<p>MHA + NON-GTID 模式，重点配置和用法如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>. command</div><div class="line">masterha_master_switch --global_conf=<span class="regexp">/data/</span>online<span class="regexp">/agent/</span>MHA<span class="regexp">/conf/m</span>asterha_default.cnf --conf=<span class="regexp">/data/</span>online<span class="regexp">/agent/</span>MHA<span class="regexp">/conf/</span>bak_mha_test.cnf  --dead_master_host=$dead_master_ip  --dead_master_port=<span class="number">3306</span> --master_state=dead --interactive=<span class="number">0</span> --ignore_last_failover --ignore_binlog_server_error</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="number">2</span>. tgw 清理</div><div class="line"></div><div class="line">dead master 如果还可以起来，那么必须在上面执行： <span class="regexp">/usr/</span>local<span class="regexp">/realserver/</span>RS_TUNL0<span class="regexp">/etc/</span>setup_rs.sh -c</div><div class="line"></div><div class="line">原因可参看：http:<span class="comment">//gitlab.corp.anjuke.com/_dba/architecture/blob/master/personal/Keithlan/other/share/tools/always_used_command.md ==&gt; TGW 章节</span></div></pre></td></tr></table></figure>

<h2 id="五、_流程简介">五、 流程简介</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">	HealthCheck: SSH  N台DB是否reachable</div><div class="line">	Binlog server： N台DB 是否reachable</div><div class="line">	GTID failover mode = ？</div><div class="line">	Dead Servers <span class="keyword">is</span> ？</div><div class="line">	Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>) ？</div><div class="line"></div><div class="line">* Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">	Executing master IP deactivation <span class="keyword">script</span>：</div><div class="line">		TGW-vip delete操作</div><div class="line">	shutdown_script： ？</div><div class="line"></div><div class="line">* Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">	* Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">		Latest slaves ，<span class="type">file</span> position ？</div><div class="line">		Oldest slaves ， <span class="type">file</span> position ？</div><div class="line">	* Phase <span class="number">3.2</span>: Saving Dead Master's Binlog Phase..</div><div class="line">		Executing command <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> dead master : save_binary_logs <span class="comment">--command=save</span></div><div class="line">			Concat binary/relay logs <span class="keyword">from</span> latest_slave file_pos <span class="keyword">to</span> master's binlog EOF</div><div class="line">		scp <span class="keyword">from</span> root@master_ip: binlog <span class="keyword">to</span> <span class="keyword">local</span>: xx.binlog <span class="comment">--将master最新的，latest缺失的binlog传递到manager机器</span></div><div class="line"></div><div class="line">	* Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">		选择哪个slave为new master</div><div class="line"></div><div class="line">	* Phase <span class="number">3.3</span>: New Master Diff Log Generation Phase..</div><div class="line">		Need <span class="keyword">to</span> <span class="keyword">get</span> diffs <span class="keyword">from</span> <span class="keyword">the</span> latest slave up <span class="keyword">to</span>: xx (using <span class="keyword">the</span> latest slave's relay logs)  <span class="comment">--生成new master和latest slave之间的diff日志</span></div><div class="line">		scp latest_ip:xx <span class="keyword">to</span> new_master:xx  <span class="comment">--将new master和latest slave之间的diff日志 传送给 new master</span></div><div class="line">		scp <span class="keyword">from</span> <span class="keyword">local</span>: xx  <span class="keyword">to</span>  new_master: xx  <span class="comment">--将latest slave 和 dead master之间的diff日志 传送给 new master</span></div><div class="line"></div><div class="line">	* Phase <span class="number">3.4</span>: Master Log Apply Phase..</div><div class="line">		new master 将之前的两段diff日志合并，然后开始apply</div><div class="line">		All other slaves should start replication <span class="keyword">from</span> here <span class="comment">--开始生成change master语句</span></div><div class="line">		Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:  TGW-vip 激活操作，并且设置readonly=<span class="number">0</span></div><div class="line"></div><div class="line">* Phase <span class="number">4</span>: Slaves Recovery Phase..  (并行操作)</div><div class="line">	* Phase <span class="number">4.1</span>: Starting Parallel Slave Diff Log Generation Phase..  <span class="comment">--开始生成其余slave 和 latest 之间的diff日志</span></div><div class="line">	* Phase <span class="number">4.2</span>: Starting Parallel Slave Log Apply Phase..</div><div class="line">		<span class="comment">--将 当前需要恢复的slave 和 latest slave之间的diff日志 传送给 需要恢复的 slave</span></div><div class="line">		<span class="comment">--将 latest slave 和 dead master之间的diff日志 传送给 需要恢复的 slave</span></div><div class="line">		<span class="comment">--将 刚刚的差异日志依次apply 到需要恢复的slave</span></div><div class="line">		<span class="comment">--Resetting slave ， Executed CHANGE MASTER to  new_master</span></div><div class="line"></div><div class="line">* Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">	Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master.</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/MHA/">MHA</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2017/11/22/mha_by_hand_non_gtid/" data-title="MHA failover NON-GTID 专题 | Focus on MySQL,Focus on Life" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2018/03/27/truncate_drop/" title="truncate table 和 drop table 的一点坑">
  <strong>PREVIOUS:</strong><br/>
  <span>
  truncate table 和 drop table 的一点坑</span>
</a>
</div>


<div class="next">
<a href="/2017/11/10/mha_by_hand/"  title="MHA failover GTID 专题">
 <strong>NEXT:</strong><br/> 
 <span>MHA failover GTID 专题
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2017/11/22/mha_by_hand_non_gtid/" data-title="MHA failover NON-GTID 专题" data-url="https://Keithlan.github.io/2017/11/22/mha_by_hand_non_gtid/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#MHA_failover_NON-GTID_专题"><span class="toc-number">1.</span> <span class="toc-text">MHA failover NON-GTID 专题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#假定环境(经典三节点)"><span class="toc-number">1.1.</span> <span class="toc-text">假定环境(经典三节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Master_:_MySQL_down"><span class="toc-number">1.2.</span> <span class="toc-text">一、Master : MySQL down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1_etl_延迟8小时"><span class="toc-number">1.2.1.</span> <span class="toc-text">1.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2_slave(候选master)比etl还要落后更多"><span class="toc-number">1.2.2.</span> <span class="toc-text">1.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">1.2.3.</span> <span class="toc-text">1.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4_slave(候选master）上面有大事务在跑"><span class="toc-number">1.2.4.</span> <span class="toc-text">1.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">1.2.5.</span> <span class="toc-text">1.5 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7_Master：MySQL_down小结"><span class="toc-number">1.2.6.</span> <span class="toc-text">1.7 Master：MySQL down小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Master_:_Server_down"><span class="toc-number">1.3.</span> <span class="toc-text">二、Master : Server down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_etl_延迟8小时"><span class="toc-number">1.3.1.</span> <span class="toc-text">2.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_slave(候选master)比etl还要落后更多"><span class="toc-number">1.3.2.</span> <span class="toc-text">2.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">1.3.3.</span> <span class="toc-text">2.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4_slave(候选master）上面有大事务在跑"><span class="toc-number">1.3.4.</span> <span class="toc-text">2.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">1.3.5.</span> <span class="toc-text">2.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、遇到的坑"><span class="toc-number">1.4.</span> <span class="toc-text">三、遇到的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1_交互模式下，如果没有及时敲’YES’，则终止切换"><span class="toc-number">1.4.1.</span> <span class="toc-text">3.1 交互模式下，如果没有及时敲’YES’，则终止切换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-2_如果在non-gtid模式的机器上，配置了binlog_server，会有什么影响呢？"><span class="toc-number">1.4.2.</span> <span class="toc-text">3.2 如果在non-gtid模式的机器上，配置了binlog server，会有什么影响呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-3_不要在relay-log的地方伪造日志"><span class="toc-number">1.4.3.</span> <span class="toc-text">3.3 不要在relay-log的地方伪造日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-4_flush_tables_with_read_lock_会阻塞"><span class="toc-number">1.4.4.</span> <span class="toc-text">3.4  flush tables with read lock 会阻塞</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-5_binlog伪造"><span class="toc-number">1.4.5.</span> <span class="toc-text">3.5 binlog伪造</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、总结"><span class="toc-number">1.5.</span> <span class="toc-text">四、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、_流程简介"><span class="toc-number">1.6.</span> <span class="toc-text">五、 流程简介</span></a></li></ol></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>50</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>37</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Error/" title="Error">Error<sup>2</sup></a></li>
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>9</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MHA/" title="MHA">MHA<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>46</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>6</sup></a></li>
		
			<li><a href="/tags/MySQL-实战/" title="MySQL 实战">MySQL 实战<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
