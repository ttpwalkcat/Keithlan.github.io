
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>MHA failover GTID 专题 | Focus on MySQL,Focus on Life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" content="这里以masterha_master_switch为背景详解各种可能遇到的场景

假定环境(经典三节点)
123host_1(host_1:3306) (current master) +--host_2(host_2:3306 slave[candidate master]) +--host_3(">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Life">Focus on MySQL,Focus on Life</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/10/mha_by_hand/" title="MHA failover GTID 专题" itemprop="url">MHA failover GTID 专题</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2017-11-10T07:32:24.000Z" itemprop="datePublished">Nov 10 2017</time>
    Updated:<time datetime="2017-11-22T08:46:37.000Z" itemprop="dateModified">Nov 22 2017</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#假定环境(经典三节点)"><span class="toc-number">1.</span> <span class="toc-text">假定环境(经典三节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Master_:_MySQL_down"><span class="toc-number">2.</span> <span class="toc-text">一、Master : MySQL down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1_etl_延迟8小时"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2_slave(候选master)比etl还要落后更多"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4_slave(候选master）上面有大事务在跑"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5_binlog_server_不同场景的测试"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 binlog server 不同场景的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">2.6.</span> <span class="toc-text">1.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7_Master：MySQL_down小结"><span class="toc-number">2.7.</span> <span class="toc-text">1.7 Master：MySQL down小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Master_:_Server_down"><span class="toc-number">3.</span> <span class="toc-text">二、Master : Server down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_etl_延迟8小时"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_slave(候选master)比etl还要落后更多"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4_slave(候选master）上面有大事务在跑"><span class="toc-number">3.4.</span> <span class="toc-text">2.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5_binlog_server_不同场景的测试"><span class="toc-number">3.5.</span> <span class="toc-text">2.5 binlog server 不同场景的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">3.6.</span> <span class="toc-text">2.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、遇到的坑"><span class="toc-number">4.</span> <span class="toc-text">三、遇到的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1_交互模式下，如果没有及时敲’YES’，则终止切换"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 交互模式下，如果没有及时敲’YES’，则终止切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、总结"><span class="toc-number">5.</span> <span class="toc-text">四、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、流程简介"><span class="toc-number">6.</span> <span class="toc-text">五、流程简介</span></a></li></ol>
		</div>
		
		<blockquote>
<p>这里以masterha_master_switch为背景详解各种可能遇到的场景</p>
</blockquote>
<h2 id="假定环境(经典三节点)">假定环境(经典三节点)</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">host_1</span><span class="params">(host_1:<span class="number">3306</span>)</span> <span class="params">(current master)</span></span></div><div class="line"> +--<span class="title">host_2</span><span class="params">(host_2:<span class="number">3306</span> slave[candidate master])</span></div><div class="line"> +--<span class="title">host_3</span><span class="params">(host_3:<span class="number">3306</span> etl)</span></div></pre></td></tr></table></figure>

<h2 id="一、Master_:_MySQL_down">一、Master : MySQL down</h2>
<h3 id="1-1_etl_延迟8小时">1.1 etl 延迟8小时</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">配置文件中加上no_check_delay</span>=<span class="string">0 即可忽略报错</span></div></pre></td></tr></table></figure>

<h3 id="1-2_slave(候选master)比etl还要落后更多">1.2 slave(候选master)比etl还要落后更多</h3>
<ul>
<li>1.2.1 当master的部分日志还没传递两个slave，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 模拟现场，现场的3台DB gtid状态</span></div><div class="line"></div><div class="line">* master  host_2</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                        |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">|  host_2<span class="number">.000002</span> |     <span class="number">2885</span> |              |                  | <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">16</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446362</span> |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave (candidate master)  host_1</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set: ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446353</span></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">16</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446353</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line">* etl (other slave)  host_3</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">4</span>-<span class="number">16</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446353</span>-<span class="number">446356</span></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">16</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446356</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host= host_2  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">49</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Binlog server  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Binlog server  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Binlog server  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Starting GTID based failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">51</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_2<span class="number">.000002</span>:<span class="number">1115</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Retrieved Gtid Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">4</span>-<span class="number">16</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_2<span class="number">.000002</span>:<span class="number">230</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Retrieved Gtid Set: ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446353</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Replicating <span class="keyword">from</span> <span class="keyword">the</span> latest slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> waiting <span class="keyword">to</span> apply..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> latest slave..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Resetting slave  host_1( host_1:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_3( host_3:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">53</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">to</span> execute all relay logs <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]  master_pos_wait( host_3<span class="number">.000049</span>:<span class="number">18041</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_2 started, pid: 150294</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_1 started, pid: 150295</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_3 started, pid: 150297</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_1 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_1..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000002  --start_pos=1115 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog2_20171109104349.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_1.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_1.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_3..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000002  --start_pos=1115 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog3_20171109104349.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_2..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">54</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000002  --start_pos=1115 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171109104349.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@ host_2:/var/<span class="command">log</span>/masterha/mha_test/saved_binlog_binlog1_20171109104349.binlog <span class="keyword">to</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_binlog_ host_2_binlog1_20171109104349.binlog succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Saved mysqlbinlog size <span class="keyword">from</span>  host_2 <span class="keyword">is</span> <span class="number">6047</span> bytes.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Applying differential binlog /var/<span class="command">log</span>/masterha/mha_test/saved_binlog_ host_2_binlog1_20171109104349.binlog ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Differential <span class="command">log</span> apply <span class="keyword">from</span> binlog server succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info]   host_1<span class="number">.000053</span>:<span class="number">3624</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_1', MASTER_PORT=<span class="number">3306</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_1<span class="number">.000053</span>, <span class="number">3624</span>, <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">16</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">55</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=3306 --new_master_host= host_1 --new_master_ip= host_1 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host  host_3( host_3:3306) started, pid: 155162. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171109104349.log if it takes time..</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  Resetting slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_1( host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">57</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]  gtid_wait(<span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">16</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave on host  host_3( host_3:3306) started.</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]   host_1: Resetting slave info succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span>  host_1( host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">43</span>:<span class="number">58</span> <span class="number">2017</span> - [info] Sending mail..</div></pre></td></tr></table></figure>

<ul>
<li>1.2.2 当master的所有日志已经传递到1个etl，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">### 模拟现场，现场的3台DB gtid状态</span></div><div class="line"></div><div class="line">* master  host_1</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                        |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">|  host_1<span class="number">.000053</span> |     <span class="number">5229</span> |              |                  | <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">21</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446362</span> |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">* slave (candidate master)  host_2</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set:</div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">16</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446362</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line">* etl (other slave)  host_3</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">17</span>-<span class="number">21</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446357</span>-<span class="number">446362</span></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">21</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446362</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host= host_1  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">14</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">14</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">14</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">14</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">14</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">15</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">15</span> <span class="number">2017</span> - [info] Binlog server  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">15</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">15</span> <span class="number">2017</span> - [info] Binlog server  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">15</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Binlog server  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Starting GTID based failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">16</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_1<span class="number">.000053</span>:<span class="number">5229</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] Retrieved Gtid Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">17</span>-<span class="number">21</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_1<span class="number">.000053</span>:<span class="number">3624</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Replicating <span class="keyword">from</span> <span class="keyword">the</span> latest slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> waiting <span class="keyword">to</span> apply..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> latest slave..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Resetting slave  host_2( host_2:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_3( host_3:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">20</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">to</span> execute all relay logs <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]  master_pos_wait( host_3<span class="number">.000049</span>:<span class="number">22035</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_2 started, pid: 184482</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_1 started, pid: 184483</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_3 started, pid: 184487</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_2..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000053  --start_pos=5229 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171109105914.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_2.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_3..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000053  --start_pos=5229 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog3_20171109105914.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_1 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_1..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">21</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000053  --start_pos=5229 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog2_20171109105914.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@ host_1:/var/<span class="command">log</span>/masterha/mha_test/saved_binlog_binlog2_20171109105914.binlog <span class="keyword">to</span> <span class="keyword">local</span>:/var/<span class="command">log</span>/masterha/mha_test/saved_binlog_ host_1_binlog2_20171109105914.binlog succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_1.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Saved mysqlbinlog size <span class="keyword">from</span>  host_1 <span class="keyword">is</span> <span class="number">800</span> bytes.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Applying differential binlog /var/<span class="command">log</span>/masterha/mha_test/saved_binlog_ host_1_binlog2_20171109105914.binlog ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Differential <span class="command">log</span> apply <span class="keyword">from</span> binlog server succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info]   host_2<span class="number">.000003</span>:<span class="number">1680</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_2', MASTER_PORT=<span class="number">3306</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_2<span class="number">.000003</span>, <span class="number">1680</span>, <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">21</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">22</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --new_master_host= host_2 --new_master_ip= host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host  host_3( host_3:3306) started, pid: 189393. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171109105914.log if it takes time..</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]  Resetting slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">24</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]  gtid_wait(<span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">21</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave on host  host_3( host_3:3306) started.</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]   host_2: Resetting slave info succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span>  host_2( host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">10</span>:<span class="number">59</span>:<span class="number">25</span> <span class="number">2017</span> - [info] Sending mail..</div></pre></td></tr></table></figure>

<h3 id="1-3_slave(候选master)的日志是最新的，比etl要多">1.3 slave(候选master)的日志是最新的，比etl要多</h3>
<ul>
<li>1.3.1 当master的部分日志还没传递两个slave，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host= host_1  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line">Tue Nov  7 17:11:29 2017 - [info] MHA::MasterFailover version 0.56.</div><div class="line">Tue Nov  7 17:11:29 2017 - [info] Starting master failover.</div><div class="line">Tue Nov  7 17:11:29 2017 - [info]</div><div class="line">Tue Nov  7 17:11:29 2017 - [info] * Phase 1: Configuration <span class="operator"><span class="keyword">Check</span> Phase..</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="keyword">Binlog</span> <span class="keyword">server</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">29</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] <span class="keyword">Binlog</span> <span class="keyword">server</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] <span class="keyword">Binlog</span> <span class="keyword">server</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span>  host_3( host_3:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">1</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] Checking <span class="keyword">master</span> reachability via MySQL(<span class="keyword">double</span> <span class="keyword">check</span>)...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="keyword">Starting</span> <span class="keyword">SQL</span> thread <span class="keyword">on</span>  host_2( host_2:<span class="number">3306</span>) ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="keyword">Starting</span> <span class="keyword">SQL</span> thread <span class="keyword">on</span>  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] <span class="keyword">Starting</span> GTID based failover.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">30</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> <span class="keyword">master</span>..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2017</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">31</span> <span class="number">2017</span> - [info]   /<span class="keyword">data</span>/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> the dead <span class="keyword">master</span>.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase completed.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span>  host_1<span class="number">.000051</span>:<span class="number">13508</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">3</span>-<span class="number">8</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span>  host_1<span class="number">.000051</span>:<span class="number">11918</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">2</span>-<span class="number">3</span>,</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New <span class="keyword">Master</span> Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Searching new <span class="keyword">master</span> <span class="keyword">from</span> slaves..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration file:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> <span class="keyword">events</span>..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] New <span class="keyword">master</span> <span class="keyword">is</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_2 started, pid: 54677</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_1 started, pid: 54681</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_3 started, pid: 54683</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_3..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000051  --start_pos=13508 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog3_20171107171129.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">events</span> <span class="keyword">from</span> the <span class="keyword">binlog</span> <span class="keyword">server</span>. Maybe disks <span class="keyword">on</span> <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> <span class="keyword">not</span> accessible <span class="keyword">or</span> <span class="built_in">binary</span> <span class="keyword">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [warning] Got error <span class="keyword">from</span>  host_3.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_2..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000051  --start_pos=13508 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171107171129.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">events</span> <span class="keyword">from</span> the <span class="keyword">binlog</span> <span class="keyword">server</span>. Maybe disks <span class="keyword">on</span> <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> <span class="keyword">not</span> accessible <span class="keyword">or</span> <span class="built_in">binary</span> <span class="keyword">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [warning] Got error <span class="keyword">from</span>  host_2.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_1 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_1..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000051  --start_pos=13508 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog2_20171107171129.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@ host_1:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_binlog2_20171107171129.<span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">local</span>:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_ host_1_binlog2_20171107171129.<span class="keyword">binlog</span> succeeded.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_1.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Saved mysqlbinlog <span class="keyword">size</span> <span class="keyword">from</span>  host_1 <span class="keyword">is</span> <span class="number">8578</span> bytes.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Applying differential <span class="keyword">binlog</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_ host_1_binlog2_20171107171129.<span class="keyword">binlog</span> ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Differential <span class="keyword">log</span> apply <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span> succeeded.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">17</span>:<span class="number">11</span>:<span class="number">33</span> <span class="number">2017</span> - [info] Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..</span></div><div class="line">Tue Nov  7 17:11:33 2017 - [info]   host_2.000001:5048</div><div class="line">Tue Nov  7 17:11:33 2017 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_2<span class="string">', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></div><div class="line">Tue Nov  7 17:11:33 2017 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_2.000001, 5048, 0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-16,</div><div class="line">Tue Nov  7 17:11:33 2017 - [info] Executing master IP activate script:</div><div class="line">Tue Nov  7 17:11:33 2017 - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test --command=start --ssh_user=root --orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --new_master_host= host_2 --new_master_ip= host_2 --new_master_port=3306 --new_master_user='dba<span class="string">' --new_master_password='</span>dba<span class="string">'</span></div><div class="line">Tue Nov  7 17:11:36 2017 - [info]  OK.</div><div class="line">Tue Nov  7 17:11:36 2017 - [info] Setting read_only=0 on  host_2( host_2:3306)..</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]  ok.</div><div class="line">Tue Nov  7 17:11:36 2017 - [info] ** Finished master recovery successfully.</div><div class="line">Tue Nov  7 17:11:36 2017 - [info] * Phase 3: Master Recovery Phase completed.</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]</div><div class="line">Tue Nov  7 17:11:36 2017 - [info] * Phase 4: Slaves Recovery Phase..</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]</div><div class="line">Tue Nov  7 17:11:36 2017 - [info] * Phase 4.1: Starting Slaves in parallel..</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]</div><div class="line">Tue Nov  7 17:11:36 2017 - [info] -- Slave recovery on host  host_3( host_3:3306) started, pid: 58422. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171107171129.log if it takes time..</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] Log messages from  host_3 ...</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]  Resetting slave  host_3( host_3:3306) and starting replication from the new master  host_2( host_2:3306)..</div><div class="line">Tue Nov  7 17:11:36 2017 - [info]  Executed CHANGE MASTER.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]  Slave started.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]  gtid_wait(0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-16,</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] End of log messages from  host_3.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] -- Slave on host  host_3( host_3:3306) started.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] All new slave servers recovered successfully.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] * Phase 5: New master cleanup phase..</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] Resetting slave info on the new master..</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]   host_2: Resetting slave info succeeded.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] Master failover to  host_2( host_2:3306) completed successfully.</div><div class="line">Tue Nov  7 17:11:37 2017 - [info]</div><div class="line">Tue Nov  7 17:11:37 2017 - [info] Sending mail..</div></pre></td></tr></table></figure>

<ul>
<li>1.3.2 当master的所有日志已经传递slave，这时候master 上的MySQL挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div></pre></td><td class="code"><pre><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host= host_2  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line">Tue Nov  7 15:56:11 2017 - [info] MHA::MasterFailover version 0.56.</div><div class="line">Tue Nov  7 15:56:11 2017 - [info] Starting master failover.</div><div class="line">Tue Nov  7 15:56:11 2017 - [info]</div><div class="line">Tue Nov  7 15:56:11 2017 - [info] * Phase 1: Configuration <span class="operator"><span class="keyword">Check</span> Phase..</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">11</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">11</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">12</span> <span class="number">2017</span> - [info] <span class="keyword">Binlog</span> <span class="keyword">server</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">12</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">12</span> <span class="number">2017</span> - [info] <span class="keyword">Binlog</span> <span class="keyword">server</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">12</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] <span class="keyword">Binlog</span> <span class="keyword">server</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [warning] <span class="keyword">SQL</span> Thread <span class="keyword">is</span> stopped(<span class="keyword">no</span> error) <span class="keyword">on</span>  host_3( host_3:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] GTID failover <span class="keyword">mode</span> = <span class="number">1</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Checking <span class="keyword">master</span> reachability via MySQL(<span class="keyword">double</span> <span class="keyword">check</span>)...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  <span class="keyword">Starting</span> <span class="keyword">SQL</span> thread <span class="keyword">on</span>  host_1( host_1:<span class="number">3306</span>) ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]  <span class="keyword">Starting</span> <span class="keyword">SQL</span> thread <span class="keyword">on</span>  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] <span class="keyword">Starting</span> GTID based failover.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration <span class="keyword">Check</span> Phase completed.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Forcing shutdown so that applications never <span class="keyword">connect</span> <span class="keyword">to</span> the <span class="keyword">current</span> <span class="keyword">master</span>..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info] Executing <span class="keyword">master</span> IP deactivation script:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">13</span> <span class="number">2017</span> - [info]   /<span class="keyword">data</span>/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> the dead <span class="keyword">master</span>.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase completed.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] The latest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span>  host_2<span class="number">.000049</span>:<span class="number">11291</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">3</span>-<span class="number">446352</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Latest slaves (Slaves that received relay <span class="keyword">log</span> files <span class="keyword">to</span> the latest):</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] The oldest <span class="built_in">binary</span> <span class="keyword">log</span> file/<span class="keyword">position</span> <span class="keyword">on</span> <span class="keyword">all</span> slaves <span class="keyword">is</span>  host_2<span class="number">.000049</span>:<span class="number">10703</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Retrieved Gtid <span class="keyword">Set</span>: ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">3</span>-<span class="number">446350</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New <span class="keyword">Master</span> Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Searching new <span class="keyword">master</span> <span class="keyword">from</span> slaves..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> the configuration file:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     <span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="keyword">Version</span>=<span class="number">5.7</span><span class="number">.13</span>-<span class="keyword">log</span> (oldest major <span class="keyword">version</span> <span class="keyword">between</span> slaves) <span class="keyword">log</span>-<span class="keyword">bin</span>:enabled</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     GTID <span class="keyword">ON</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]     <span class="keyword">Not</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received the latest relay <span class="keyword">log</span> <span class="keyword">events</span>..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] New <span class="keyword">master</span> <span class="keyword">is</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] <span class="keyword">Starting</span> <span class="keyword">master</span> failover..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New <span class="keyword">Master</span> Recovery Phase..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_2 started, pid: 79759</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_1 started, pid: 79768</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_3 started, pid: 79770</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_1 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_1..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000049  --start_pos=11291 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog2_20171107155611.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">events</span> <span class="keyword">from</span> the <span class="keyword">binlog</span> <span class="keyword">server</span>. Maybe disks <span class="keyword">on</span> <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> <span class="keyword">not</span> accessible <span class="keyword">or</span> <span class="built_in">binary</span> <span class="keyword">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_1.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [warning] Got error <span class="keyword">from</span>  host_1.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_3..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000049  --start_pos=11291 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog3_20171107155611.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">events</span> <span class="keyword">from</span> the <span class="keyword">binlog</span> <span class="keyword">server</span>. Maybe disks <span class="keyword">on</span> <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> <span class="keyword">not</span> accessible <span class="keyword">or</span> <span class="built_in">binary</span> <span class="keyword">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [warning] Got error <span class="keyword">from</span>  host_3.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_2..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000049  --start_pos=11291 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171107155611.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@ host_2:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_binlog1_20171107155611.<span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">local</span>:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_ host_2_binlog1_20171107155611.<span class="keyword">binlog</span> succeeded.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Saved mysqlbinlog <span class="keyword">size</span> <span class="keyword">from</span>  host_2 <span class="keyword">is</span> <span class="number">768</span> bytes.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Applying differential <span class="keyword">binlog</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_ host_2_binlog1_20171107155611.<span class="keyword">binlog</span> ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Differential <span class="keyword">log</span> apply <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span> succeeded.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..</span></div><div class="line">Tue Nov  7 15:56:17 2017 - [info]   host_1.000051:11449</div><div class="line">Tue Nov  7 15:56:17 2017 - [info]  All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_1<span class="string">', MASTER_PORT=3306, MASTER_AUTO_POSITION=1, MASTER_USER='</span>repl<span class="string">', MASTER_PASSWORD='</span>xxx<span class="string">';</span></div><div class="line">Tue Nov  7 15:56:17 2017 - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_1.000051, 11449, 0923e916-3c36-11e6-82a5-ecf4bbf1f518:1,</div><div class="line">Tue Nov  7 15:56:17 2017 - [info] Executing master IP activate script:</div><div class="line">Tue Nov  7 15:56:17 2017 - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test --command=start --ssh_user=root --orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=3306 --new_master_host= host_1 --new_master_ip= host_1 --new_master_port=3306 --new_master_user='dba<span class="string">' --new_master_password='</span>dba<span class="string">'</span></div><div class="line">Tue Nov  7 15:56:20 2017 - [info]  OK.</div><div class="line">Tue Nov  7 15:56:20 2017 - [info] Setting read_only=0 on  host_1( host_1:3306)..</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]  ok.</div><div class="line">Tue Nov  7 15:56:20 2017 - [info] ** Finished master recovery successfully.</div><div class="line">Tue Nov  7 15:56:20 2017 - [info] * Phase 3: Master Recovery Phase completed.</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]</div><div class="line">Tue Nov  7 15:56:20 2017 - [info] * Phase 4: Slaves Recovery Phase..</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]</div><div class="line">Tue Nov  7 15:56:20 2017 - [info] * Phase 4.1: Starting Slaves in parallel..</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]</div><div class="line">Tue Nov  7 15:56:20 2017 - [info] -- Slave recovery on host  host_3( host_3:3306) started, pid: 85941. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171107155611.log if it takes time..</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] Log messages from  host_3 ...</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]  Resetting slave  host_3( host_3:3306) and starting replication from the new master  host_1( host_1:3306)..</div><div class="line">Tue Nov  7 15:56:20 2017 - [info]  Executed CHANGE MASTER.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]  Slave started.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]  gtid_wait(0923e916-3c36-11e6-82a5-ecf4bbf1f518:1,</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] End of log messages from  host_3.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] -- Slave on host  host_3( host_3:3306) started.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] All new slave servers recovered successfully.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] * Phase 5: New master cleanup phase..</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] Resetting slave info on the new master..</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]   host_1: Resetting slave info succeeded.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] Master failover to  host_1( host_1:3306) completed successfully.</div><div class="line">Tue Nov  7 15:56:21 2017 - [info]</div><div class="line">Tue Nov  7 15:56:21 2017 - [info] Sending mail..</div></pre></td></tr></table></figure>

<h3 id="1-4_slave(候选master）上面有大事务在跑">1.4 slave(候选master）上面有大事务在跑</h3>
<ul>
<li>1000s的大查询</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">无影响，正常切换</div></pre></td></tr></table></figure>

<ul>
<li>flush tables  with readlock</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="header">dba:(none)&gt; show processlist;</span></div><div class="line">+----+------+----------------------+------+---------+------+------------------------------+------------------------------------------------------------------------------------------------------+</div><div class="line"><span class="header">| Id | User | Host                 | db   | Command | Time | State                        | Info                                                                                                 |</span></div><div class="line">+----+------+----------------------+------+---------+------+------------------------------+------------------------------------------------------------------------------------------------------+</div><div class="line">| 63 | dba  | localhost            | NULL | Query   |    0 | starting                     | show processlist                                                                                     |</div><div class="line">| 65 | dba  | xx:11164   | NULL | Sleep   |  121 |                              | NULL                                                                                                 |</div><div class="line">| 83 | dba  | new master:49022 | NULL | Query   |  176 | Waiting for global read lock | BINLOG '</div><div class="line">GpAKWhNYUy1LMAAAAGYHAAAAAG0AAAAAAAEAAmxjAAh0X2NoYXJfMgACAw8CLAEC</div><div class="line"><span class="header">GpAKWh5YUy1LJwAAAI0HAAAAAG |</span></div><div class="line">+----+------+----------------------+------+---------+------+------------------------------+------------------------------------------------------------------------------------------------------+</div><div class="line">3 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<h3 id="1-5_binlog_server_不同场景的测试">1.5 binlog server 不同场景的测试</h3>
<blockquote>
<p>dead_master上的最后部分日志没有传递到slave和etl的情况, 然而slave的日志也落后etl （这是最严苛的情况）</p>
</blockquote>
<ul>
<li>binlog server 写3台</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host= host_1  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line">Tue Nov  7 15:56:17 2017 - [info] Log messages from  host_1 ...</div><div class="line">Tue Nov  7 15:56:17 2017 - [info]</div><div class="line">Tue Nov  7 15:56:16 2017 - [info] Fetching binary logs from binlog server  host_1..</div><div class="line">Tue Nov  7 15:56:16 2017 - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000049  --start_pos=11291 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog2_20171107155611.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  7 15:56:17 2017 - [error][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed to save binary log events from the binlog server. Maybe disks on binary logs are not accessible or binary log itself is corrupt?</div><div class="line">Tue Nov  7 15:56:17 2017 - [info] <span class="operator"><span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_1.</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [warning] Got error <span class="keyword">from</span>  host_1.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_3..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000049  --start_pos=11291 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog3_20171107155611.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [error][/usr/<span class="keyword">share</span>/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save <span class="built_in">binary</span> <span class="keyword">log</span> <span class="keyword">events</span> <span class="keyword">from</span> the <span class="keyword">binlog</span> <span class="keyword">server</span>. Maybe disks <span class="keyword">on</span> <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">are</span> <span class="keyword">not</span> accessible <span class="keyword">or</span> <span class="built_in">binary</span> <span class="keyword">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [warning] Got error <span class="keyword">from</span>  host_3.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">Log</span> messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Fetching <span class="built_in">binary</span> <span class="keyword">logs</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>  host_2..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">16</span> <span class="number">2017</span> - [info] Executing <span class="keyword">binlog</span> save command: save_binary_logs <span class="comment">--command=save --start_file= host_2.000049  --start_pos=11291 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171107155611.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] scp <span class="keyword">from</span> root@ host_2:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_binlog1_20171107155611.<span class="keyword">binlog</span> <span class="keyword">to</span> <span class="keyword">local</span>:/<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_ host_2_binlog1_20171107155611.<span class="keyword">binlog</span> succeeded.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] <span class="keyword">End</span> <span class="keyword">of</span> <span class="keyword">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Saved mysqlbinlog <span class="keyword">size</span> <span class="keyword">from</span>  host_2 <span class="keyword">is</span> <span class="number">768</span> bytes.</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Applying differential <span class="keyword">binlog</span> /<span class="keyword">var</span>/<span class="keyword">log</span>/masterha/mha_test/saved_binlog_ host_2_binlog1_20171107155611.<span class="keyword">binlog</span> ..</div><div class="line">Tue Nov  <span class="number">7</span> <span class="number">15</span>:<span class="number">56</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Differential <span class="keyword">log</span> apply <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span> succeeded.</div></pre></td></tr></table></figure>

<ul>
<li>binlog server 只写master</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">masterha_master_switch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">global_conf=/data/online/agent/MHA/conf/masterha_default</span><span class="string">.</span><span class="comment">cnf</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf=/data/online/agent/MHA/conf/bak_mha_test</span><span class="string">.</span><span class="comment">cnf</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_host=</span> <span class="comment">host_2</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_port=3306</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master_state=dead</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">interactive=0</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_last_failover</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:04</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="literal">-</span><span class="literal">-</span> <span class="comment">Saving</span> <span class="comment">binlog</span> <span class="comment">from</span> <span class="comment">host</span>  <span class="comment">host_2</span> <span class="comment">started</span><span class="string">,</span> <span class="comment">pid:</span> <span class="comment">117389</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">Log</span> <span class="comment">messages</span> <span class="comment">from</span>  <span class="comment">host_2</span> <span class="string">.</span><span class="string">.</span><span class="string">.</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:04</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">Fetching</span> <span class="comment">binary</span> <span class="comment">logs</span> <span class="comment">from</span> <span class="comment">binlog</span> <span class="comment">server</span>  <span class="comment">host_2</span><span class="string">.</span><span class="string">.</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:04</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">Executing</span> <span class="comment">binlog</span> <span class="comment">save</span> <span class="comment">command:</span> <span class="comment">save_binary_logs</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">command=save</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">start_file=</span> <span class="comment">host_2</span><span class="string">.</span><span class="comment">000004</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">start_pos=1115</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171109111957</span><span class="string">.</span><span class="comment">binlog</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">handle_raw_binlog=0</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">skip_filter=1</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">disable_log_bin=0</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">manager_version=0</span><span class="string">.</span><span class="comment">56</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">oldest_version=5</span><span class="string">.</span><span class="comment">7</span><span class="string">.</span><span class="comment">13</span><span class="literal">-</span><span class="comment">log</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">binlog_dir=/data/mysql</span><span class="string">.</span><span class="comment">bin</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">scp</span> <span class="comment">from</span> <span class="comment">root@</span> <span class="comment">host_2:/var/log/masterha/mha_test/saved_binlog_binlog1_20171109111957</span><span class="string">.</span><span class="comment">binlog</span> <span class="comment">to</span> <span class="comment">local:/var/log/masterha/mha_test/saved_binlog_</span> <span class="comment">host_2_binlog1_20171109111957</span><span class="string">.</span><span class="comment">binlog</span> <span class="comment">succeeded</span><span class="string">.</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">End</span> <span class="comment">of</span> <span class="comment">log</span> <span class="comment">messages</span> <span class="comment">from</span>  <span class="comment">host_2</span><span class="string">.</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">Saved</span> <span class="comment">mysqlbinlog</span> <span class="comment">size</span> <span class="comment">from</span>  <span class="comment">host_2</span> <span class="comment">is</span> <span class="comment">4444</span> <span class="comment">bytes</span><span class="string">.</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">Applying</span> <span class="comment">differential</span> <span class="comment">binlog</span> <span class="comment">/var/log/masterha/mha_test/saved_binlog_</span> <span class="comment">host_2_binlog1_20171109111957</span><span class="string">.</span><span class="comment">binlog</span> <span class="string">.</span><span class="string">.</span></div><div class="line"><span class="comment">Thu</span> <span class="comment">Nov</span>  <span class="comment">9</span> <span class="comment">11:20:05</span> <span class="comment">2017</span> <span class="literal">-</span> <span class="title">[</span><span class="comment">info</span><span class="title">]</span> <span class="comment">Differential</span> <span class="comment">log</span> <span class="comment">apply</span> <span class="comment">from</span> <span class="comment">binlog</span> <span class="comment">server</span> <span class="comment">succeeded</span><span class="string">.</span></div></pre></td></tr></table></figure>

<ul>
<li>binlog server 只写slave</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 3台服务器的GTID状态</span></div><div class="line"></div><div class="line">* master   host_1</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                        |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">|  host_1<span class="number">.000055</span> |     <span class="number">6016</span> |              |                  | <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446369</span> |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">* slave  host_2</div><div class="line"></div><div class="line"></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">21</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446369</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line">* etl  host_3</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">22</span>-<span class="number">25</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446366</span>-<span class="number">446369</span></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">25</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446369</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line">masterha_master_switch <span class="comment">--global_conf=/data/online/agent/MHA/conf/masterha_default.cnf --conf=/data/online/agent/MHA/conf/bak_mha_test.cnf  --dead_master_host= host_1  --dead_master_port=3306 --master_state=dead --interactive=0 --ignore_last_failover --ignore_binlog_server_error</span></div><div class="line"></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">09</span> <span class="number">2017</span> - [info] Binlog server  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Starting GTID based failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_1 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">10</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_1<span class="number">.000055</span>:<span class="number">4090</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Retrieved Gtid Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">22</span>-<span class="number">25</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_1<span class="number">.000055</span>:<span class="number">2806</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Replicating <span class="keyword">from</span> <span class="keyword">the</span> latest slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> waiting <span class="keyword">to</span> apply..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> latest slave..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Resetting slave  host_2( host_2:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_3( host_3:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">17</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">to</span> execute all relay logs <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]  master_pos_wait( host_3<span class="number">.000049</span>:<span class="number">25843</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_2 started, pid: 175683</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_2..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000055  --start_pos=4090 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171109150009.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_2.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]   host_2<span class="number">.000005</span>:<span class="number">1390</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_2', MASTER_PORT=<span class="number">3306</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_2<span class="number">.000005</span>, <span class="number">1390</span>, <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">25</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">18</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --new_master_host= host_2 --new_master_ip= host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host  host_3( host_3:3306) started, pid: 180681. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171109150009.log if it takes time..</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]  Resetting slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">22</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]  gtid_wait(<span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">25</span>,</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave on host  host_3( host_3:3306) started.</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]   host_2: Resetting slave info succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span>  host_2( host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">15</span>:<span class="number">00</span>:<span class="number">23</span> <span class="number">2017</span> - [info] Sending mail..</div></pre></td></tr></table></figure>

<p>结论： 由于binlog server没有配置master，所以会丢失master没有传递过来的事务日志<br>好在，slave和etl之间会互相change master，所以尽管slave（candidate master）的日志落后，最终也还是用etl的日志补齐了slave缺失的日志。</p>
<ul>
<li>binlog server 啥都不写</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 3台DB的GTID状态</span></div><div class="line"></div><div class="line">* master  host_2</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                        |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">|  host_2<span class="number">.000005</span> |     <span class="number">5785</span> |              |                  | <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446378</span> |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave  host_1</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set:</div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446369</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line">* etl  host_3</div><div class="line"></div><div class="line"></div><div class="line">           Retrieved_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">26</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446370</span>-<span class="number">446372</span></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446372</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] Starting GTID based failover.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">41</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">42</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">42</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">42</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">42</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=3306 --command=stopssh --ssh_user=root</span></div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span>  host_2 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-09 16:22:42--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [<span class="type">text</span>/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">9.79</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">09</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> (<span class="number">9.79</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_2<span class="number">.000005</span>:<span class="number">4015</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Retrieved Gtid Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">26</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446370</span>-<span class="number">446372</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_2<span class="number">.000005</span>:<span class="number">3130</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line"> host_2( host_2:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">-- host_1( host_1:3306)</span></div><div class="line"> +<span class="comment">-- host_3( host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line"> host_1( host_1:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">-- host_3( host_3:3306)</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Replicating <span class="keyword">from</span> <span class="keyword">the</span> latest slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> waiting <span class="keyword">to</span> apply..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> latest slave..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Resetting slave  host_1( host_1:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_3( host_3:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">44</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">to</span> execute all relay logs <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  master_pos_wait( host_3<span class="number">.000049</span>:<span class="number">28663</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]   host_1<span class="number">.000056</span>:<span class="number">1170</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_1', MASTER_PORT=<span class="number">3306</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_1<span class="number">.000056</span>, <span class="number">1170</span>, <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446372</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">45</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=3306 --new_master_host= host_1 --new_master_ip= host_1 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span>  host_1  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Setting read_only=<span class="number">0</span> <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host  host_3( host_3:3306) started, pid: 112317. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171109162241.log if it takes time..</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Resetting slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_1( host_1:<span class="number">3306</span>)..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info]  gtid_wait(<span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">31</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446372</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave on host  host_3( host_3:3306) started.</span></div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">49</span> <span class="number">2017</span> - [info]   host_1: Resetting slave info succeeded.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">49</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span>  host_1( host_1:<span class="number">3306</span>) completed successfully.</div><div class="line">Thu Nov  <span class="number">9</span> <span class="number">16</span>:<span class="number">22</span>:<span class="number">49</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover  host_2( host_2:<span class="number">3306</span>) <span class="keyword">to</span>  host_1( host_1:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master  host_2( host_2:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/mha_test.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Selected  host_1( host_1:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line"> host_1( host_1:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line"> host_1( host_1:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line"> host_3( host_3:<span class="number">3306</span>): OK: Slave started, replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line"> host_1( host_1:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span>  host_1( host_1:<span class="number">3306</span>) completed successfully.</div></pre></td></tr></table></figure>

<p>结论： 由于binlog server没有配置master，所以会丢失master没有传递过来的事务日志<br>好在，slave和etl之间会互相change master，所以尽管slave（candidate master）的日志落后，最终也还是用etl的日志补齐了slave缺失的日志。</p>
<h3 id="1-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？">1.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</h3>
<ul>
<li><p>99%的场景都是可以重新执行的</p>
</li>
<li><p>1%的场景不能再次执行，执行会报错</p>
</li>
</ul>
<blockquote>
<p>一般这种场景就是：已经failover到最后的change master阶段，这样主从结构已经变更，MHA无法重新走一遍。<br>不过，即便到这步骤失败了，表示master的日志已经补完，由于是gtid模式，自己再让slave change master到最新的master即可，最后ACTIVE new ip和readonly=1就好了</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">Thu Nov  9 16:49:39 2017 - [info] MHA::MasterFailover version 0.56.</div><div class="line">Thu Nov  9 16:49:39 2017 - [info] Starting master failover.</div><div class="line">Thu Nov  9 16:49:39 2017 - [info]</div><div class="line">Thu Nov  9 16:49:39 2017 - [info] * Phase 1: Configuration Check Phase..</div><div class="line">Thu Nov  9 16:49:39 2017 - [info]</div><div class="line">Thu Nov  9 16:49:39 2017 - [info] GTID failover mode = 1</div><div class="line">Thu Nov  9 16:49:39 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln169</span>] Detected dead master  host<span class="emphasis">_1( host_</span>1:3306) does not match with specified dead master  host<span class="emphasis">_2( host_</span>2:3306)!</div><div class="line">Thu Nov  9 16:49:39 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177</span>] Got ERROR:  at /usr/bin/masterha<span class="emphasis">_master_</span>switch line 53</div></pre></td></tr></table></figure>

<h3 id="1-7_Master：MySQL_down小结">1.7 Master：MySQL down小结</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">1</span><span class="string">.</span> <span class="comment">failover最终命令</span></div><div class="line"></div><div class="line"><span class="comment">masterha_master_switch</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">global_conf=/data/online/agent/MHA/conf/masterha_default</span><span class="string">.</span><span class="comment">cnf</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">conf=/data/online/agent/MHA/conf/bak_mha_test</span><span class="string">.</span><span class="comment">cnf</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_host=</span> <span class="comment">host_2</span>  <span class="literal">-</span><span class="literal">-</span><span class="comment">dead_master_port=3306</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">master_state=dead</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">interactive=0</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_last_failover</span> <span class="literal">-</span><span class="literal">-</span><span class="comment">ignore_binlog_server_error</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">2</span><span class="string">.</span> <span class="comment">binlog</span> <span class="comment">server建议</span></div><div class="line"></div><div class="line"><span class="comment">配置master就可以了</span></div><div class="line"><span class="title">[</span><span class="comment">binlog1</span><span class="title">]</span></div><div class="line"><span class="comment">$master_ip</span></div><div class="line"></div><div class="line"><span class="comment">只配置slave，或者没有配置，会导致丢失部分没有从master传递过来的日志事务</span></div></pre></td></tr></table></figure>

<h2 id="二、Master_:_Server_down">二、Master : Server down</h2>
<h3 id="2-1_etl_延迟8小时">2.1 etl 延迟8小时</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">同1.1 结论</div></pre></td></tr></table></figure>

<h3 id="2-2_slave(候选master)比etl还要落后更多">2.2 slave(候选master)比etl还要落后更多</h3>
<ul>
<li>2.2.1 当master的部分日志还没传递两个slave，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div></pre></td><td class="code"><pre><div class="line"><span class="comment">### 3台DB的GTID状态</span></div><div class="line"></div><div class="line">* master  host_2</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</div><div class="line">| <span class="type">File</span>                | <span class="type">Position</span> | <span class="type">Binlog_Do_DB</span> | <span class="type">Binlog_Ignore_DB</span> | <span class="type">Executed_Gtid_Set</span>                                                                        |</div><div class="line">+---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</div><div class="line">|  host_2.<span class="number">000008</span> |     <span class="number">5445</span> |              |                  | <span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446392</span> |</div><div class="line">+---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="type">set</span> (<span class="number">0</span>.<span class="number">00</span> sec)</div><div class="line"></div><div class="line">* slave  host_1</div><div class="line"></div><div class="line">           <span class="type">Retrieved_Gtid_Set</span>:</div><div class="line">            <span class="type">Executed_Gtid_Set</span>: <span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446385</span></div><div class="line">                <span class="type">Auto_Position</span>: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">* etl  host_3</div><div class="line"></div><div class="line">           <span class="type">Retrieved_Gtid_Set</span>: <span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">46</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">446386</span>-<span class="number">446388</span></div><div class="line">            <span class="type">Executed_Gtid_Set</span>: <span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446388</span></div><div class="line">                <span class="type">Auto_Position</span>: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 模拟故障场景</span></div><div class="line"></div><div class="line">* 隔离master的网络，让其等同于down机</div><div class="line"></div><div class="line">master&gt; iptables -A <span class="type">INPUT</span> -p tcp -s other_host --dport <span class="number">22</span> -j <span class="type">ACCEPT</span></div><div class="line">master&gt; iptables -A <span class="type">INPUT</span> -p tcp -s <span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>.<span class="number">0</span>/<span class="number">0</span> -j <span class="type">DROP</span></div><div class="line"></div><div class="line"><span class="comment">### 切换日志</span></div><div class="line"></div><div class="line"></div><div class="line">masterha_master_switch --global_conf=/data/online/agent/<span class="type">MHA</span>/conf/masterha_default.cnf --conf=/data/online/agent/<span class="type">MHA</span>/conf/bak_mha_test.cnf  --dead_master_host= host_2  --dead_master_port=<span class="number">3306</span> --master_state=dead --interactive=<span class="number">0</span> --ignore_last_failover --ignore_binlog_server_error</div><div class="line"></div><div class="line"></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">38</span> <span class="number">2017</span> - [info] <span class="type">MHA</span>::<span class="type">MasterFailover</span> version <span class="number">0</span>.<span class="number">56</span>.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">38</span> <span class="number">2017</span> - [info] <span class="type">Starting</span> master failover.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">38</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">38</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">1</span>: <span class="type">Configuration</span> <span class="type">Check</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">12</span>:<span class="number">38</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">28</span> <span class="number">2017</span> - [warning] <span class="type">HealthCheck</span>: <span class="type">Got</span> timeout on checking <span class="type">SSH</span> connection to  host_2! at /usr/share/perl5/vendor_perl/<span class="type">MHA</span>/<span class="type">HealthCheck</span>.pm line <span class="number">342</span>.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">28</span> <span class="number">2017</span> - [warning] <span class="type">Failed</span> to <span class="type">SSH</span> to binlog server  host_2</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">HealthCheck</span>: <span class="type">SSH</span> to  host_1 <span class="keyword">is</span> reachable.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">Binlog</span> server  host_1 <span class="keyword">is</span> reachable.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">HealthCheck</span>: <span class="type">SSH</span> to  host_3 <span class="keyword">is</span> reachable.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">Binlog</span> server  host_3 <span class="keyword">is</span> reachable.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [warning] <span class="type">SQL</span> <span class="type">Thread</span> <span class="keyword">is</span> stopped(no error) on  host_1( host_1:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [warning] <span class="type">SQL</span> <span class="type">Thread</span> <span class="keyword">is</span> stopped(no error) on  host_3( host_3:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">GTID</span> failover mode = <span class="number">1</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">Dead</span> <span class="type">Servers</span>:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">29</span> <span class="number">2017</span> - [info] <span class="type">Checking</span> master reachability via <span class="type">MySQL</span>(double check)...</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  ok.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info] <span class="type">Alive</span> <span class="type">Servers</span>:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info] <span class="type">Alive</span> <span class="type">Slaves</span>:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  <span class="type">Version</span>=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="type">GTID</span> <span class="type">ON</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="type">Replicating</span> <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="type">Primary</span> candidate <span class="keyword">for</span> the new <span class="type">Master</span> (candidate_master <span class="keyword">is</span> <span class="type">set</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="type">Version</span>=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="type">GTID</span> <span class="type">ON</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="type">Replicating</span> <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]     <span class="type">Not</span> candidate <span class="keyword">for</span> the new <span class="type">Master</span> (no_master <span class="keyword">is</span> <span class="type">set</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="type">Starting</span> <span class="type">SQL</span> thread on  host_1( host_1:<span class="number">3306</span>) ..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]   done.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="type">Starting</span> <span class="type">SQL</span> thread on  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]   done.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info] <span class="type">Starting</span> <span class="type">GTID</span> based failover.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info] ** <span class="type">Phase</span> <span class="number">1</span>: <span class="type">Configuration</span> <span class="type">Check</span> <span class="type">Phase</span> completed.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">2</span>: <span class="type">Dead</span> <span class="type">Master</span> <span class="type">Shutdown</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">13</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">20</span> <span class="number">2017</span> - [warning] <span class="type">HealthCheck</span>: <span class="type">Got</span> timeout on checking <span class="type">SSH</span> connection to  host_2! at /usr/share/perl5/vendor_perl/<span class="type">MHA</span>/<span class="type">HealthCheck</span>.pm line <span class="number">342</span>.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">20</span> <span class="number">2017</span> - [info] <span class="type">Forcing</span> shutdown so that applications never connect to the current master..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">20</span> <span class="number">2017</span> - [info] <span class="type">Executing</span> master <span class="type">IP</span> deactivation script:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">20</span> <span class="number">2017</span> - [info]   /data/online/agent/<span class="type">MHA</span>/masterha/bak_mha_test/master_ip_failover_mha_test --orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=<span class="number">3306</span> --command=stop</div><div class="line">ssh: connect to host  host_2 port <span class="number">22</span>: <span class="type">Connection</span> timed <span class="keyword">out</span></div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span>  host_2 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line">--<span class="number">2017</span>-<span class="number">11</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">14</span>:<span class="number">27</span>--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</div><div class="line">正在连接 tgw_server:<span class="number">80</span>... 已连接。</div><div class="line">已发出 <span class="type">HTTP</span> 请求，正在等待回应... <span class="number">200</span> <span class="type">OK</span></div><div class="line">长度：未指定 [text/html]</div><div class="line">正在保存至: “<span class="type">STDOUT</span>”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">11</span>.<span class="number">4</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> (<span class="number">11</span>.<span class="number">4</span> <span class="type">MB</span>/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  done.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="type">set</span>. <span class="type">Skipping</span> explicit shutting down <span class="keyword">of</span> the dead master.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">2</span>: <span class="type">Dead</span> <span class="type">Master</span> <span class="type">Shutdown</span> <span class="type">Phase</span> completed.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">3</span>: <span class="type">Master</span> <span class="type">Recovery</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">3</span>.<span class="number">1</span>: <span class="type">Getting</span> <span class="type">Latest</span> <span class="type">Slaves</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">The</span> latest binary log file/position on all slaves <span class="keyword">is</span>  host_2.<span class="number">000008</span>:<span class="number">4265</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">Retrieved</span> <span class="type">Gtid</span> <span class="type">Set</span>: <span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">46</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">446386</span>-<span class="number">446388</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">Latest</span> slaves (<span class="type">Slaves</span> that received relay log files to the latest):</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="type">Version</span>=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">GTID</span> <span class="type">ON</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Replicating</span> <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Not</span> candidate <span class="keyword">for</span> the new <span class="type">Master</span> (no_master <span class="keyword">is</span> <span class="type">set</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">The</span> oldest binary log file/position on all slaves <span class="keyword">is</span>  host_2.<span class="number">000008</span>:<span class="number">3380</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">Oldest</span> slaves:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  <span class="type">Version</span>=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">GTID</span> <span class="type">ON</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Replicating</span> <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Primary</span> candidate <span class="keyword">for</span> the new <span class="type">Master</span> (candidate_master <span class="keyword">is</span> <span class="type">set</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">3</span>.<span class="number">3</span>: <span class="type">Determining</span> <span class="type">New</span> <span class="type">Master</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">Searching</span> new master <span class="keyword">from</span> slaves..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Candidate</span> masters <span class="keyword">from</span> the configuration file:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)  <span class="type">Version</span>=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">GTID</span> <span class="type">ON</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Replicating</span> <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Primary</span> candidate <span class="keyword">for</span> the new <span class="type">Master</span> (candidate_master <span class="keyword">is</span> <span class="type">set</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Non</span>-candidate masters:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  <span class="type">Version</span>=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log (oldest major version between slaves) log-bin:enabled</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">GTID</span> <span class="type">ON</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Replicating</span> <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]     <span class="type">Not</span> candidate <span class="keyword">for</span> the new <span class="type">Master</span> (no_master <span class="keyword">is</span> <span class="type">set</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Searching</span> <span class="keyword">from</span> candidate_master slaves which have received the latest relay log events..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]   <span class="type">Not</span> found.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Searching</span> <span class="keyword">from</span> all candidate_master slaves..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">New</span> master <span class="keyword">is</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] <span class="type">Starting</span> master failover..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">From</span>:</div><div class="line"> host_2( host_2:<span class="number">3306</span>) (current master)</div><div class="line"> +-- host_1( host_1:<span class="number">3306</span>)</div><div class="line"> +-- host_3( host_3:<span class="number">3306</span>)</div><div class="line"></div><div class="line"><span class="type">To</span>:</div><div class="line"> host_1( host_1:<span class="number">3306</span>) (new master)</div><div class="line"> +-- host_3( host_3:<span class="number">3306</span>)</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">3</span>.<span class="number">3</span>: <span class="type">New</span> <span class="type">Master</span> <span class="type">Recovery</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Waiting</span> all logs to be applied..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]   done.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Replicating</span> <span class="keyword">from</span> the latest slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> waiting to apply..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Waiting</span> all logs to be applied on the latest slave..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Resetting</span> slave  host_1( host_1:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> the new master  host_3( host_3:<span class="number">3306</span>)..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">27</span> <span class="number">2017</span> - [info]  <span class="type">Executed</span> <span class="type">CHANGE</span> <span class="type">MASTER</span>.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]  <span class="type">Slave</span> started.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]  <span class="type">Waiting</span> to execute all relay logs on  host_1( host_1:<span class="number">3306</span>)..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]  master_pos_wait( host_3.<span class="number">000049</span>:<span class="number">40136</span>) completed on  host_1( host_1:<span class="number">3306</span>). <span class="type">Executed</span> <span class="number">0</span> events.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]   done.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]   done.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] -- <span class="type">Saving</span> binlog <span class="keyword">from</span> host  host_2 started, pid: <span class="number">43038</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] -- <span class="type">Saving</span> binlog <span class="keyword">from</span> host  host_1 started, pid: <span class="number">43039</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] -- <span class="type">Saving</span> binlog <span class="keyword">from</span> host  host_3 started, pid: <span class="number">43041</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Log</span> messages <span class="keyword">from</span>  host_2 ...</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">End</span> <span class="keyword">of</span> log messages <span class="keyword">from</span>  host_2.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [warning] <span class="type">SSH</span> <span class="keyword">is</span> <span class="keyword">not</span> reachable on  host_2. <span class="type">Skipping</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Log</span> messages <span class="keyword">from</span>  host_1 ...</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Fetching</span> binary logs <span class="keyword">from</span> binlog server  host_1..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Executing</span> binlog save command: save_binary_logs --command=save --start_file= host_2.<span class="number">000008</span>  --start_pos=<span class="number">4265</span> --output_file=/<span class="keyword">var</span>/log/masterha/mha_test/saved_binlog_binlog2_20171110111238.binlog --handle_raw_binlog=<span class="number">0</span> --skip_filter=<span class="number">1</span> --disable_log_bin=<span class="number">0</span> --manager_version=<span class="number">0</span>.<span class="number">56</span> --oldest_version=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log  --binlog_dir=/data/mysql.bin</div><div class="line"><span class="type">Failed</span> to save binary log: <span class="type">Binlog</span> <span class="keyword">not</span> found <span class="keyword">from</span> /data/mysql.bin! <span class="type">If</span> you got this error at <span class="type">MHA</span> <span class="type">Manager</span>, please <span class="type">set</span> <span class="string">"master_binlog_dir=/path/to/binlog_directory_of_the_master"</span> correctly <span class="keyword">in</span> the <span class="type">MHA</span> <span class="type">Manager</span>'s configuration file <span class="keyword">and</span> <span class="keyword">try</span> again.</div><div class="line"> at /usr/bin/save_binary_logs line <span class="number">123</span></div><div class="line">	eval <span class="decorator">{...}</span> called at /usr/bin/save_binary_logs line <span class="number">70</span></div><div class="line">	main::main() called at /usr/bin/save_binary_logs line <span class="number">66</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [error][/usr/share/perl5/vendor_perl/<span class="type">MHA</span>/<span class="type">MasterFailover</span>.pm, ln660] <span class="type">Failed</span> to save binary log events <span class="keyword">from</span> the binlog server. <span class="type">Maybe</span> disks on binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary log itself <span class="keyword">is</span> corrupt?</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">End</span> <span class="keyword">of</span> log messages <span class="keyword">from</span>  host_1.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [warning] <span class="type">Got</span> error <span class="keyword">from</span>  host_1.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Log</span> messages <span class="keyword">from</span>  host_3 ...</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Fetching</span> binary logs <span class="keyword">from</span> binlog server  host_3..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Executing</span> binlog save command: save_binary_logs --command=save --start_file= host_2.<span class="number">000008</span>  --start_pos=<span class="number">4265</span> --output_file=/<span class="keyword">var</span>/log/masterha/mha_test/saved_binlog_binlog3_20171110111238.binlog --handle_raw_binlog=<span class="number">0</span> --skip_filter=<span class="number">1</span> --disable_log_bin=<span class="number">0</span> --manager_version=<span class="number">0</span>.<span class="number">56</span> --oldest_version=<span class="number">5</span>.<span class="number">7</span>.<span class="number">13</span>-log  --binlog_dir=/data/mysql.bin</div><div class="line"><span class="type">Failed</span> to save binary log: <span class="type">Binlog</span> <span class="keyword">not</span> found <span class="keyword">from</span> /data/mysql.bin! <span class="type">If</span> you got this error at <span class="type">MHA</span> <span class="type">Manager</span>, please <span class="type">set</span> <span class="string">"master_binlog_dir=/path/to/binlog_directory_of_the_master"</span> correctly <span class="keyword">in</span> the <span class="type">MHA</span> <span class="type">Manager</span>'s configuration file <span class="keyword">and</span> <span class="keyword">try</span> again.</div><div class="line"> at /usr/bin/save_binary_logs line <span class="number">123</span></div><div class="line">	eval <span class="decorator">{...}</span> called at /usr/bin/save_binary_logs line <span class="number">70</span></div><div class="line">	main::main() called at /usr/bin/save_binary_logs line <span class="number">66</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [error][/usr/share/perl5/vendor_perl/<span class="type">MHA</span>/<span class="type">MasterFailover</span>.pm, ln660] <span class="type">Failed</span> to save binary log events <span class="keyword">from</span> the binlog server. <span class="type">Maybe</span> disks on binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary log itself <span class="keyword">is</span> corrupt?</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">End</span> <span class="keyword">of</span> log messages <span class="keyword">from</span>  host_3.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [warning] <span class="type">Got</span> error <span class="keyword">from</span>  host_3.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Getting</span> new master's binlog name <span class="keyword">and</span> position..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]   host_1.<span class="number">000058</span>:<span class="number">4059</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]  <span class="type">All</span> other slaves should start replication <span class="keyword">from</span> here. <span class="type">Statement</span> should be: <span class="type">CHANGE</span> <span class="type">MASTER</span> <span class="type">TO</span> <span class="type">MASTER_HOST</span>=' host_1', <span class="type">MASTER_PORT</span>=<span class="number">3306</span>, <span class="type">MASTER_AUTO_POSITION</span>=<span class="number">1</span>, <span class="type">MASTER_USER</span>='repl', <span class="type">MASTER_PASSWORD</span>='xxx';</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Master</span> <span class="type">Recovery</span> succeeded. <span class="type">File</span>:<span class="type">Pos</span>:<span class="type">Exec_Gtid_Set</span>:  host_1.<span class="number">000058</span>, <span class="number">4059</span>, <span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446388</span></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info] <span class="type">Executing</span> master <span class="type">IP</span> activate script:</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">28</span> <span class="number">2017</span> - [info]   /data/online/agent/<span class="type">MHA</span>/masterha/bak_mha_test/master_ip_failover_mha_test --command=start --ssh_user=root --orig_master_host= host_2 --orig_master_ip= host_2 --orig_master_port=<span class="number">3306</span> --new_master_host= host_1 --new_master_ip= host_1 --new_master_port=<span class="number">3306</span> --new_master_user='dba' --new_master_password='dba'</div><div class="line"><span class="type">Unknown</span> option: new_master_user</div><div class="line"><span class="type">Unknown</span> option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip to  host_1  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="type">OK</span>.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info] ** <span class="type">Finished</span> master recovery successfully.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">3</span>: <span class="type">Master</span> <span class="type">Recovery</span> <span class="type">Phase</span> completed.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">4</span>: <span class="type">Slaves</span> <span class="type">Recovery</span> <span class="type">Phase</span>..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">4</span>.<span class="number">1</span>: <span class="type">Starting</span> <span class="type">Slaves</span> <span class="keyword">in</span> parallel..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info] -- <span class="type">Slave</span> recovery on host  host_3( host_3:<span class="number">3306</span>) started, pid: <span class="number">46878</span>. <span class="type">Check</span> tmp log /<span class="keyword">var</span>/log/masterha/mha_test/ host_3_3306_20171110111238.log <span class="keyword">if</span> it takes time..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] <span class="type">Log</span> messages <span class="keyword">from</span>  host_3 ...</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="type">Resetting</span> slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> the new master  host_1( host_1:<span class="number">3306</span>)..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">30</span> <span class="number">2017</span> - [info]  <span class="type">Executed</span> <span class="type">CHANGE</span> <span class="type">MASTER</span>.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]  <span class="type">Slave</span> started.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]  gtid_wait(<span class="number">0923</span>e916-<span class="number">3</span>c36-<span class="number">11</span>e6-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11</span>e6-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446388</span>) completed on  host_3( host_3:<span class="number">3306</span>). <span class="type">Executed</span> <span class="number">0</span> events.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] <span class="type">End</span> <span class="keyword">of</span> log messages <span class="keyword">from</span>  host_3.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] -- <span class="type">Slave</span> on host  host_3( host_3:<span class="number">3306</span>) started.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] <span class="type">All</span> new slave servers recovered successfully.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] * <span class="type">Phase</span> <span class="number">5</span>: <span class="type">New</span> master cleanup phase..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] <span class="type">Resetting</span> slave info on the new master..</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]   host_1: <span class="type">Resetting</span> slave info succeeded.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] <span class="type">Master</span> failover to  host_1( host_1:<span class="number">3306</span>) completed successfully.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line">----- <span class="type">Failover</span> <span class="type">Report</span> -----</div><div class="line"></div><div class="line">bak_mha_test: <span class="type">MySQL</span> <span class="type">Master</span> failover  host_2( host_2:<span class="number">3306</span>) to  host_1( host_1:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line"><span class="type">Master</span>  host_2( host_2:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line"><span class="type">Check</span> <span class="type">MHA</span> <span class="type">Manager</span> logs at tjtx135-<span class="number">2</span>-<span class="number">217</span>.<span class="number">58</span>os.org:/<span class="keyword">var</span>/log/masterha/mha_test/mha_test.log <span class="keyword">for</span> details.</div><div class="line"></div><div class="line"><span class="type">Started</span> automated(non-interactive) failover.</div><div class="line"><span class="type">Invalidated</span> master <span class="type">IP</span> address on  host_2( host_2:<span class="number">3306</span>)</div><div class="line"><span class="type">Selected</span>  host_1( host_1:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line"> host_1( host_1:<span class="number">3306</span>): <span class="type">OK</span>: <span class="type">Applying</span> all logs succeeded.</div><div class="line"> host_1( host_1:<span class="number">3306</span>): <span class="type">OK</span>: <span class="type">Activated</span> master <span class="type">IP</span> address.</div><div class="line"> host_3( host_3:<span class="number">3306</span>): <span class="type">OK</span>: <span class="type">Slave</span> started, replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line"> host_1( host_1:<span class="number">3306</span>): <span class="type">Resetting</span> slave info succeeded.</div><div class="line"><span class="type">Master</span> failover to  host_1( host_1:<span class="number">3306</span>) completed successfully.</div><div class="line"><span class="type">Fri</span> <span class="type">Nov</span> <span class="number">10</span> <span class="number">11</span>:<span class="number">16</span>:<span class="number">31</span> <span class="number">2017</span> - [info] <span class="type">Sending</span> mail..</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 最后一步很重要</span></div><div class="line"></div><div class="line">如果dead master之后又活过来了，那么这一步要做</div><div class="line"></div><div class="line">dead_master&gt; /usr/local/realserver/<span class="type">RS_TUNL0</span>/etc/setup_rs.sh -c</div><div class="line"></div><div class="line">http://gitlab.corp.anjuke.com/_dba/architecture/blob/master/personal/<span class="type">Keithlan</span>/other/share/tools/always_used_command.md  ==》 tgw章节详细描述</div></pre></td></tr></table></figure>

<p>结论： 由于master 已挂，然而最后的日志没有传递到其他服务器，所以会丢失master没有传递过来的事务日志<br>好在，slave和etl之间会互相change master，所以尽管slave（candidate master）的日志落后，最终也还是用etl的日志补齐了slave缺失的日志。</p>
<ul>
<li>2.2.2 当master的所有日志已经传递到1个etl，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">测试省略，和2.2.1基本一样</div></pre></td></tr></table></figure>

<p>结论：由于master上的所有日志全部传递到etl，所以最后是不会丢失master上任何数据的。</p>
<h3 id="2-3_slave(候选master)的日志是最新的，比etl要多">2.3 slave(候选master)的日志是最新的，比etl要多</h3>
<ul>
<li>2.3.1 当master的部分日志还没传递两个slave，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">测试省略，和2.2.1基本一样</div></pre></td></tr></table></figure>

<p>结论： 由于master 已挂，然而最后的日志没有传递到其他服务器，所以会丢失master没有传递过来的事务日志<br>好在，slave和etl之间会互相change master，所以尽管slave（candidate master）的日志落后，最终也还是用etl的日志补齐了slave缺失的日志。</p>
<ul>
<li>2.3.2 当master的所有日志已经传递slave，这时候master server挂了</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">测试省略，和2.2.1基本一样</div></pre></td></tr></table></figure>

<p>结论：由于master上的所有日志全部传递到slave，所以最后是不会丢失master上任何数据的。</p>
<h3 id="2-4_slave(候选master）上面有大事务在跑">2.4 slave(候选master）上面有大事务在跑</h3>
<ul>
<li>1000s的大查询</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">同1.4结论</div></pre></td></tr></table></figure>

<ul>
<li>flush tables  with readlock</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">同1.4结论</div></pre></td></tr></table></figure>

<h3 id="2-5_binlog_server_不同场景的测试">2.5 binlog server 不同场景的测试</h3>
<blockquote>
<p>dead_master上的最后部分日志没有传递到slave和etl的情况, 然而slave的日志也落后etl （这是最严苛的情况）</p>
</blockquote>
<ul>
<li>binlog server 写3台</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2.2.1 测试的就是这种情况，详细日志切换请看2.2.1</div></pre></td></tr></table></figure>

<p>结论： 由于binlog server配置了3台，但是由于master server已经挂掉，无法从master的binlog server上获取日志，所以会丢失master上没有传递的日志事务</p>
<ul>
<li>binlog server 只写master</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="header">### 3台DB的gtid 状态</span></div><div class="line"></div><div class="line"><span class="bullet">* </span>master  host_1</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</div><div class="line">| File                | Position | Binlog<span class="emphasis">_Do_</span>DB | Binlog<span class="emphasis">_Ignore_</span>DB | Executed<span class="emphasis">_Gtid_</span>Set                                                                        |</div><div class="line">+---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</div><div class="line">|  host_1.000058 |     8517 |              |                  | 0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-60,</div><div class="line">ebd9ff93-c5b2-11e6-b21d-ecf4bbf1f42c:1-446392 |</div><div class="line">+---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="bullet">* </span>slave  host_2</div><div class="line"></div><div class="line"><span class="code">           Retrieved_Gtid_Set:</span></div><div class="line"><span class="code">            Executed_Gtid_Set: 0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-50,</span></div><div class="line">ebd9ff93-c5b2-11e6-b21d-ecf4bbf1f42c:1-446392</div><div class="line"><span class="code">                Auto_Position: 1</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="bullet">* </span>etl  host_3</div><div class="line"></div><div class="line"><span class="code">           Retrieved_Gtid_Set: 0923e916-3c36-11e6-82a5-ecf4bbf1f518:51-55,</span></div><div class="line">ebd9ff93-c5b2-11e6-b21d-ecf4bbf1f42c:446389-446392</div><div class="line"><span class="code">            Executed_Gtid_Set: 0923e916-3c36-11e6-82a5-ecf4bbf1f518:1-55,</span></div><div class="line">ebd9ff93-c5b2-11e6-b21d-ecf4bbf1f42c:1-446392</div><div class="line"><span class="code">                Auto_Position: 1</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="header">### 模拟故障</span></div><div class="line"></div><div class="line">master&gt; iptables -A INPUT -p tcp -s other_host --dport 22 -j ACCEPT</div><div class="line">master&gt; iptables -A INPUT -p tcp -s 0.0.0.0/0 -j DROP</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">### 故障切换</span></div><div class="line"></div><div class="line">masterha<span class="emphasis">_master_</span>switch --global<span class="emphasis">_conf=/data/online/agent/MHA/conf/masterha_</span>default.cnf --conf=/data/online/agent/MHA/conf/bak<span class="emphasis">_mha_</span>test.cnf  --dead<span class="emphasis">_master_</span>host= host<span class="emphasis">_1  --dead_</span>master<span class="emphasis">_port=3306 --master_</span>state=dead --interactive=0 --ignore<span class="emphasis">_last_</span>failover --ignore<span class="emphasis">_binlog_</span>server_error</div><div class="line"></div><div class="line">Fri Nov 10 14:15:51 2017 - [info] MHA::MasterFailover version 0.56.</div><div class="line">Fri Nov 10 14:15:51 2017 - [info] Starting master failover.</div><div class="line">Fri Nov 10 14:15:51 2017 - [info]</div><div class="line">Fri Nov 10 14:15:51 2017 - [info] * Phase 1: Configuration Check Phase..</div><div class="line">Fri Nov 10 14:15:51 2017 - [info]</div><div class="line">Fri Nov 10 14:16:41 2017 - [warning] HealthCheck: Got timeout on checking SSH connection to  host<span class="emphasis">_1! at /usr/share/perl5/vendor_</span>perl/MHA/HealthCheck.pm line 342.</div><div class="line">Fri Nov 10 14:16:41 2017 - [warning] Failed to SSH to binlog server  host_1</div><div class="line">Fri Nov 10 14:16:41 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/ServerManager.pm, ln239</span>] Binlog Server is defined but there is no alive server.</div><div class="line">Fri Nov 10 14:16:41 2017 - [<span class="link_label">error</span>][<span class="link_reference">/usr/share/perl5/vendor_perl/MHA/ManagerUtil.pm, ln177</span>] Got ERROR:  at /usr/share/perl5/vendor_perl/MHA/MasterFailover.pm line 2082</div></pre></td></tr></table></figure>

<p>结论： binlog server 必须要配置一个活的 server，如果只配置master，如果master挂了，那么就等于一个都没有，MHA不会切换</p>
<ul>
<li>binlog server 只写slave</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">### 3台DB的gtid 状态</span></div><div class="line"></div><div class="line">* master  host_1</div><div class="line"></div><div class="line">dba:lc&gt; show master status;</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">| File                | Position | Binlog_Do_DB | Binlog_Ignore_DB | Executed_Gtid_Set                                                                        |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line">|  host_1<span class="number">.000058</span> |     <span class="number">8517</span> |              |                  | <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">60</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446392</span> |</div><div class="line">+<span class="comment">---------------------+----------+--------------+------------------+------------------------------------------------------------------------------------------+</span></div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">* slave  host_2</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set:</div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">50</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446392</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line">* etl  host_3</div><div class="line"></div><div class="line">           Retrieved_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">51</span>-<span class="number">55</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446389</span>-<span class="number">446392</span></div><div class="line">            Executed_Gtid_Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">55</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446392</span></div><div class="line">                Auto_Position: <span class="number">1</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 模拟故障</span></div><div class="line"></div><div class="line">master&gt; iptables -A INPUT -p tcp -s other_host <span class="comment">--dport 22 -j ACCEPT</span></div><div class="line">master&gt; iptables -A INPUT -p tcp -s <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>/<span class="number">0</span> -j DROP</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">### 故障切换</span></div><div class="line"></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] MHA::MasterFailover <span class="property">version</span> <span class="number">0.56</span>.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Starting master failover.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] * Phase <span class="number">1</span>: Configuration Check Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Binlog server  host_2 <span class="keyword">is</span> reachable.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] HealthCheck: SSH <span class="keyword">to</span>  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Binlog server  host_3 <span class="keyword">is</span> reachable.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [warning] SQL Thread <span class="keyword">is</span> stopped(no <span class="keyword">error</span>) <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] GTID failover mode = <span class="number">1</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Dead Servers:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info]    host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">50</span> <span class="number">2017</span> - [info] Checking master reachability via MySQL(double check)...</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  ok.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Alive Servers:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info] Alive Slaves:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>) ..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  Starting SQL thread <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>) ..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info] Starting GTID based failover.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info] ** Phase <span class="number">1</span>: Configuration Check Phase completed.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">29</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">42</span> <span class="number">2017</span> - [warning] HealthCheck: Got <span class="keyword">timeout</span> <span class="function_start"><span class="keyword">on</span></span> checking SSH connection <span class="keyword">to</span>  host_1! <span class="keyword">at</span> /usr/share/perl5/vendor_perl/MHA/HealthCheck.pm line <span class="number">342.</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">42</span> <span class="number">2017</span> - [info] Forcing shutdown so <span class="keyword">that</span> applications never connect <span class="keyword">to</span> <span class="keyword">the</span> current master..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">42</span> <span class="number">2017</span> - [info] Executing master IP deactivation <span class="keyword">script</span>:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">30</span>:<span class="number">42</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --command=stop</span></div><div class="line">ssh: connect <span class="keyword">to</span> host  host_1 port <span class="number">22</span>: Connection timed out</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">from</span>  host_1 <span class="keyword">is</span> deleted  ==============================</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">--2017-11-10 14:30:49--  http://tgw_server/cgi-bin/fun_logic/bin/public_api/op_rs.cgi</span></div><div class="line">正在连接 tgw_server:<span class="number">80.</span>.. 已连接。</div><div class="line">已发出 HTTP 请求，正在等待回应... <span class="number">200</span> OK</div><div class="line">长度：未指定 [<span class="type">text</span>/html]</div><div class="line">正在保存至: “STDOUT”</div><div class="line"></div><div class="line">     <span class="number">0</span>K                                                        <span class="number">12.1</span>M=<span class="number">0</span>s</div><div class="line"></div><div class="line"><span class="number">2017</span>-<span class="number">11</span>-<span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> (<span class="number">12.1</span> MB/s) - 已写入标准输出 [<span class="number">38</span>]</div><div class="line"></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  done.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [warning] shutdown_script <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">set</span>. Skipping explicit shutting down <span class="keyword">of</span> <span class="keyword">the</span> dead master.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">2</span>: Dead Master Shutdown Phase completed.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] The latest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_1<span class="number">.000058</span>:<span class="number">6912</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Retrieved Gtid Set: <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">51</span>-<span class="number">55</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">446389</span>-<span class="number">446392</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Latest slaves (Slaves <span class="keyword">that</span> received relay <span class="command">log</span> files <span class="keyword">to</span> <span class="keyword">the</span> latest):</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] The oldest binary <span class="command">log</span> <span class="type">file</span>/position <span class="function_start"><span class="keyword">on</span></span> all slaves <span class="keyword">is</span>  host_1<span class="number">.000058</span>:<span class="number">5307</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Oldest slaves:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: Determining New Master Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Searching new master <span class="keyword">from</span> slaves..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Candidate masters <span class="keyword">from</span> <span class="keyword">the</span> configuration <span class="type">file</span>:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]    host_2( host_2:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Primary candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Non-candidate masters:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]    host_3( host_3:<span class="number">3306</span>)  Version=<span class="number">5.7</span><span class="number">.13</span>-<span class="command">log</span> (oldest major <span class="property">version</span> <span class="keyword">between</span> slaves) <span class="command">log</span>-bin:enabled</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     GTID ON</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Replicating <span class="keyword">from</span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]     Not candidate <span class="keyword">for</span> <span class="keyword">the</span> new Master (no_master <span class="keyword">is</span> <span class="keyword">set</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> candidate_master slaves which have received <span class="keyword">the</span> latest relay <span class="command">log</span> events..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]   Not found.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Searching <span class="keyword">from</span> all candidate_master slaves..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] New master <span class="keyword">is</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] Starting master failover..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">From:</div><div class="line"> host_1( host_1:<span class="number">3306</span>) (current master)</div><div class="line"> +<span class="comment">-- host_2( host_2:3306)</span></div><div class="line"> +<span class="comment">-- host_3( host_3:3306)</span></div><div class="line"></div><div class="line">To:</div><div class="line"> host_2( host_2:<span class="number">3306</span>) (new master)</div><div class="line"> +<span class="comment">-- host_3( host_3:3306)</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info] * Phase <span class="number">3.3</span>: New Master Recovery Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Replicating <span class="keyword">from</span> <span class="keyword">the</span> latest slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> waiting <span class="keyword">to</span> apply..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Waiting all logs <span class="keyword">to</span> be applied <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> latest slave..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Resetting slave  host_2( host_2:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_3( host_3:<span class="number">3306</span>)..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">47</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]  Waiting <span class="keyword">to</span> execute all relay logs <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]  master_pos_wait( host_3<span class="number">.000049</span>:<span class="number">42954</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_2( host_2:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]   done.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_2 started, pid: 76664</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] <span class="comment">-- Saving binlog from host  host_3 started, pid: 76665</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_2 ...</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_2..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000058  --start_pos=6912 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog1_20171110142950.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Failed <span class="keyword">to</span> save binary <span class="command">log</span>: Binlog <span class="keyword">not</span> found <span class="keyword">from</span> /data/mysql.bin! If you got this <span class="keyword">error</span> <span class="keyword">at</span> MHA Manager, please <span class="keyword">set</span> <span class="string">"master_binlog_dir=/path/to/binlog_directory_of_the_master"</span> correctly <span class="keyword">in</span> <span class="keyword">the</span> MHA Manager's configuration <span class="type">file</span> <span class="keyword">and</span> <span class="keyword">try</span> again.</div><div class="line"> <span class="keyword">at</span> /usr/bin/save_binary_logs line <span class="number">123</span></div><div class="line">	eval {...} called <span class="keyword">at</span> /usr/bin/save_binary_logs line <span class="number">70</span></div><div class="line">	main::main() called <span class="keyword">at</span> /usr/bin/save_binary_logs line <span class="number">66</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_2.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_2.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Fetching binary logs <span class="keyword">from</span> binlog server  host_3..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Executing binlog save command: save_binary_logs <span class="comment">--command=save --start_file= host_1.000058  --start_pos=6912 --output_file=/var/log/masterha/mha_test/saved_binlog_binlog3_20171110142950.binlog --handle_raw_binlog=0 --skip_filter=1 --disable_log_bin=0 --manager_version=0.56 --oldest_version=5.7.13-log  --binlog_dir=/data/mysql.bin</span></div><div class="line">Failed <span class="keyword">to</span> save binary <span class="command">log</span>: Binlog <span class="keyword">not</span> found <span class="keyword">from</span> /data/mysql.bin! If you got this <span class="keyword">error</span> <span class="keyword">at</span> MHA Manager, please <span class="keyword">set</span> <span class="string">"master_binlog_dir=/path/to/binlog_directory_of_the_master"</span> correctly <span class="keyword">in</span> <span class="keyword">the</span> MHA Manager's configuration <span class="type">file</span> <span class="keyword">and</span> <span class="keyword">try</span> again.</div><div class="line"> <span class="keyword">at</span> /usr/bin/save_binary_logs line <span class="number">123</span></div><div class="line">	eval {...} called <span class="keyword">at</span> /usr/bin/save_binary_logs line <span class="number">70</span></div><div class="line">	main::main() called <span class="keyword">at</span> /usr/bin/save_binary_logs line <span class="number">66</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [<span class="keyword">error</span>][/usr/share/perl5/vendor_perl/MHA/MasterFailover.pm, ln660] Failed <span class="keyword">to</span> save binary <span class="command">log</span> events <span class="keyword">from</span> <span class="keyword">the</span> binlog server. Maybe disks <span class="function_start"><span class="keyword">on</span></span> binary logs are <span class="keyword">not</span> accessible <span class="keyword">or</span> binary <span class="command">log</span> itself <span class="keyword">is</span> corrupt?</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [warning] Got <span class="keyword">error</span> <span class="keyword">from</span>  host_3.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Getting new master's binlog <span class="property">name</span> <span class="keyword">and</span> position..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]   host_2<span class="number">.000008</span>:<span class="number">6895</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]  All other slaves should start replication <span class="keyword">from</span> here. Statement should be: CHANGE MASTER TO MASTER_HOST=' host_2', MASTER_PORT=<span class="number">3306</span>, MASTER_AUTO_POSITION=<span class="number">1</span>, MASTER_USER='repl', MASTER_PASSWORD='xxx';</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Master Recovery succeeded. File:Pos:Exec_Gtid_Set:  host_2<span class="number">.000008</span>, <span class="number">6895</span>, <span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">55</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446392</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info] Executing master IP <span class="command">activate</span> <span class="keyword">script</span>:</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">48</span> <span class="number">2017</span> - [info]   /data/online/agent/MHA/masterha/bak_mha_test/master_ip_failover_mha_test <span class="comment">--command=start --ssh_user=root --orig_master_host= host_1 --orig_master_ip= host_1 --orig_master_port=3306 --new_master_host= host_2 --new_master_ip= host_2 --new_master_port=3306 --new_master_user='dba' --new_master_password='dba'</span></div><div class="line">Unknown option: new_master_user</div><div class="line">Unknown option: new_master_password</div><div class="line">===================    swift vip :  tgw_vip <span class="keyword">to</span>  host_2  <span class="keyword">is</span> added  ==============================</div><div class="line"></div><div class="line"></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  OK.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info] ** Finished master recovery successfully.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info] * Phase <span class="number">3</span>: Master Recovery Phase completed.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info] * Phase <span class="number">4</span>: Slaves Recovery Phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info] * Phase <span class="number">4.1</span>: Starting Slaves <span class="keyword">in</span> parallel..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave recovery on host  host_3( host_3:3306) started, pid: 80398. Check tmp log /var/log/masterha/mha_test/ host_3_3306_20171110142950.log if it takes time..</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] Log messages <span class="keyword">from</span>  host_3 ...</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  Resetting slave  host_3( host_3:<span class="number">3306</span>) <span class="keyword">and</span> starting replication <span class="keyword">from</span> <span class="keyword">the</span> new master  host_2( host_2:<span class="number">3306</span>)..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">51</span> <span class="number">2017</span> - [info]  Executed CHANGE MASTER.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]  Slave started.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]  gtid_wait(<span class="number">0923e916</span>-<span class="number">3</span>c36-<span class="number">11e6</span>-<span class="number">82</span>a5-ecf4bbf1f518:<span class="number">1</span>-<span class="number">55</span>,</div><div class="line">ebd9ff93-c5b2-<span class="number">11e6</span>-b21d-ecf4bbf1f42c:<span class="number">1</span>-<span class="number">446392</span>) completed <span class="function_start"><span class="keyword">on</span></span>  host_3( host_3:<span class="number">3306</span>). Executed <span class="number">0</span> events.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] End <span class="keyword">of</span> <span class="command">log</span> messages <span class="keyword">from</span>  host_3.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] <span class="comment">-- Slave on host  host_3( host_3:3306) started.</span></div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] All new slave servers recovered successfully.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] * Phase <span class="number">5</span>: New master cleanup phase..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] Resetting slave info <span class="function_start"><span class="keyword">on</span></span> <span class="keyword">the</span> new master..</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]   host_2: Resetting slave info succeeded.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] Master failover <span class="keyword">to</span>  host_2( host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info]</div><div class="line"></div><div class="line"><span class="comment">----- Failover Report -----</span></div><div class="line"></div><div class="line">bak_mha_test: MySQL Master failover  host_1( host_1:<span class="number">3306</span>) <span class="keyword">to</span>  host_2( host_2:<span class="number">3306</span>) succeeded</div><div class="line"></div><div class="line">Master  host_1( host_1:<span class="number">3306</span>) <span class="keyword">is</span> down!</div><div class="line"></div><div class="line">Check MHA Manager logs <span class="keyword">at</span> tjtx135-<span class="number">2</span>-<span class="number">217.58</span>os.org:/var/<span class="command">log</span>/masterha/mha_test/mha_test.<span class="command">log</span> <span class="keyword">for</span> details.</div><div class="line"></div><div class="line">Started automated(non-interactive) failover.</div><div class="line">Invalidated master IP address <span class="function_start"><span class="keyword">on</span></span>  host_1( host_1:<span class="number">3306</span>)</div><div class="line">Selected  host_2( host_2:<span class="number">3306</span>) <span class="keyword">as</span> a new master.</div><div class="line"> host_2( host_2:<span class="number">3306</span>): OK: Applying all logs succeeded.</div><div class="line"> host_2( host_2:<span class="number">3306</span>): OK: Activated master IP address.</div><div class="line"> host_3( host_3:<span class="number">3306</span>): OK: Slave started, replicating <span class="keyword">from</span>  host_2( host_2:<span class="number">3306</span>)</div><div class="line"> host_2( host_2:<span class="number">3306</span>): Resetting slave info succeeded.</div><div class="line">Master failover <span class="keyword">to</span>  host_2( host_2:<span class="number">3306</span>) completed successfully.</div><div class="line">Fri Nov <span class="number">10</span> <span class="number">14</span>:<span class="number">32</span>:<span class="number">52</span> <span class="number">2017</span> - [info] Sending mail..</div></pre></td></tr></table></figure>

<p>结论： binlog server 配置成多台slave，这是正确的方案。 由于master 挂了，master没有传递过来的binlog会丢失，这是没办法的. 好在，其余slave自动补齐现有日志</p>
<ul>
<li>binlog server 啥都不写</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">会切换成功，由于master 挂了，master没有传递过来的binlog会丢失</div><div class="line"></div><div class="line">好在，其余slave自动补齐现有日志</div></pre></td></tr></table></figure>

<h3 id="2-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？">2.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</h3>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">同1.6结论</div></pre></td></tr></table></figure>

<h2 id="三、遇到的坑">三、遇到的坑</h2>
<h3 id="3-1_交互模式下，如果没有及时敲’YES’，则终止切换">3.1 交互模式下，如果没有及时敲’YES’，则终止切换</h3>
<h2 id="四、总结">四、总结</h2>
<p>MHA + GTID 模式，重点配置和用法如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="number">1</span>. command</div><div class="line">masterha_master_switch --global_conf=<span class="regexp">/data/</span>online<span class="regexp">/agent/</span>MHA<span class="regexp">/conf/m</span>asterha_default.cnf --conf=<span class="regexp">/data/</span>online<span class="regexp">/agent/</span>MHA<span class="regexp">/conf/</span>bak_mha_test.cnf  --dead_master_host= host_1  --dead_master_port=<span class="number">3306</span> --master_state=dead --interactive=<span class="number">0</span> --ignore_last_failover --ignore_binlog_server_error</div><div class="line"></div><div class="line"></div><div class="line"><span class="number">2</span>. binlog server</div><div class="line"></div><div class="line">在配置文件中对 master，slave，etl 都写在binlog server中。对MySQL down 和 DB server down  综合考虑下，建议这样配置。</div><div class="line"></div><div class="line"></div><div class="line"><span class="number">3</span>. tgw 清理</div><div class="line"></div><div class="line">dead master 如果还可以起来，那么必须在上面执行： <span class="regexp">/usr/</span>local<span class="regexp">/realserver/</span>RS_TUNL0<span class="regexp">/etc/</span>setup_rs.sh -c</div><div class="line"></div><div class="line">原因可参看：http:<span class="comment">//gitlab.corp.anjuke.com/_dba/architecture/blob/master/personal/Keithlan/other/share/tools/always_used_command.md ==&gt; TGW 章节</span></div></pre></td></tr></table></figure>

<h2 id="五、流程简介">五、流程简介</h2>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* Phase 1: Configuration <span class="operator"><span class="keyword">Check</span> Phase..</span></div><div class="line">	HealthCheck: SSH  N台DB是否reachable</div><div class="line">	<span class="keyword">Binlog</span> <span class="keyword">server</span>： N台DB 是否reachable</div><div class="line">	GTID failover <span class="keyword">mode</span> = ？</div><div class="line">	Dead Servers <span class="keyword">is</span> ？</div><div class="line">	<span class="keyword">Primary</span> candidate <span class="keyword">for</span> the new <span class="keyword">Master</span> (candidate_master <span class="keyword">is</span> <span class="keyword">set</span>) ？</div><div class="line"></div><div class="line">* Phase <span class="number">2</span>: Dead <span class="keyword">Master</span> Shutdown Phase..</div><div class="line">	Executing <span class="keyword">master</span> IP deactivation script：</div><div class="line">		TGW-vip <span class="keyword">delete</span>操作</div><div class="line">	shutdown_script： ？</div><div class="line"></div><div class="line">* Phase <span class="number">3</span>: <span class="keyword">Master</span> Recovery Phase..</div><div class="line">	* Phase <span class="number">3.1</span>: Getting Latest Slaves Phase..</div><div class="line">		Latest slaves ，file <span class="keyword">position</span> ？</div><div class="line">		Oldest slaves ， file <span class="keyword">position</span> ？</div><div class="line"></div><div class="line">	* Phase <span class="number">3.3</span>: Determining New <span class="keyword">Master</span> Phase..</div><div class="line">		选择哪个<span class="keyword">slave</span>为new <span class="keyword">master</span></div><div class="line"></div><div class="line">	* Phase <span class="number">3.3</span>: New <span class="keyword">Master</span> Recovery Phase..</div><div class="line">		Replicating <span class="keyword">from</span> the latest <span class="keyword">slave</span> <span class="keyword">and</span> waiting <span class="keyword">to</span> apply..  <span class="comment">--让new master change master 到 latest slave</span></div><div class="line">		Waiting <span class="keyword">all</span> <span class="keyword">logs</span> <span class="keyword">to</span> be applied <span class="keyword">on</span> the latest <span class="keyword">slave</span>..  <span class="comment">--让new master跟 latest slave的日志保持一致</span></div><div class="line">		Saving <span class="keyword">binlog</span> <span class="keyword">from</span> <span class="keyword">binlog</span> <span class="keyword">server</span>。。。  <span class="comment">--根据配置的binlog server，开始生成latest slave和dead master之间的diff日志</span></div><div class="line">		Applying differential <span class="keyword">binlog</span>  <span class="comment">--apply这些差异日志到new master，让new master执行完所有缺失的日志</span></div><div class="line">		Getting new <span class="keyword">master</span><span class="string">'s binlog name and position..  --获取new master现在的binlog file pos</span></div><div class="line">			All other slaves should start replication from here. Statement should be: CHANGE MASTER TO MASTER_HOST, MASTER_PORT=3306, MASTER_AUTO_POSITION=1</div><div class="line">		Executing master IP activate script:  --TGW-vip 激活操作，并且设置readonly=0</div><div class="line"></div><div class="line"></div><div class="line">* Phase 4: Slaves Recovery Phase..  (并行操作)</div><div class="line">		Resetting slave  and starting replication from the new master</div><div class="line"></div><div class="line"></div><div class="line">* Phase 5: New master cleanup phase..</div><div class="line">	Resetting slave info on the new master.</div></pre></td></tr></table></figure>

  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/MHA/">MHA</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2017/11/10/mha_by_hand/" data-title="MHA failover GTID 专题 | Focus on MySQL,Focus on Life" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/11/22/mha_by_hand_non_gtid/" title="MHA failover NON-GTID 专题">
  <strong>PREVIOUS:</strong><br/>
  <span>
  MHA failover NON-GTID 专题</span>
</a>
</div>


<div class="next">
<a href="/2017/10/25/too_many_connection_1/"  title="MySQL运维实战（三）之 too many connection">
 <strong>NEXT:</strong><br/> 
 <span>MySQL运维实战（三）之 too many connection
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2017/11/10/mha_by_hand/" data-title="MHA failover GTID 专题" data-url="https://Keithlan.github.io/2017/11/10/mha_by_hand/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#假定环境(经典三节点)"><span class="toc-number">1.</span> <span class="toc-text">假定环境(经典三节点)</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#一、Master_:_MySQL_down"><span class="toc-number">2.</span> <span class="toc-text">一、Master : MySQL down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-1_etl_延迟8小时"><span class="toc-number">2.1.</span> <span class="toc-text">1.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-2_slave(候选master)比etl还要落后更多"><span class="toc-number">2.2.</span> <span class="toc-text">1.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">2.3.</span> <span class="toc-text">1.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-4_slave(候选master）上面有大事务在跑"><span class="toc-number">2.4.</span> <span class="toc-text">1.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-5_binlog_server_不同场景的测试"><span class="toc-number">2.5.</span> <span class="toc-text">1.5 binlog server 不同场景的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">2.6.</span> <span class="toc-text">1.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#1-7_Master：MySQL_down小结"><span class="toc-number">2.7.</span> <span class="toc-text">1.7 Master：MySQL down小结</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#二、Master_:_Server_down"><span class="toc-number">3.</span> <span class="toc-text">二、Master : Server down</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#2-1_etl_延迟8小时"><span class="toc-number">3.1.</span> <span class="toc-text">2.1 etl 延迟8小时</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-2_slave(候选master)比etl还要落后更多"><span class="toc-number">3.2.</span> <span class="toc-text">2.2 slave(候选master)比etl还要落后更多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-3_slave(候选master)的日志是最新的，比etl要多"><span class="toc-number">3.3.</span> <span class="toc-text">2.3 slave(候选master)的日志是最新的，比etl要多</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-4_slave(候选master）上面有大事务在跑"><span class="toc-number">3.4.</span> <span class="toc-text">2.4 slave(候选master）上面有大事务在跑</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-5_binlog_server_不同场景的测试"><span class="toc-number">3.5.</span> <span class="toc-text">2.5 binlog server 不同场景的测试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-6_如果MHA过程中失败，是否可以重新执行MHA的failover呢？"><span class="toc-number">3.6.</span> <span class="toc-text">2.6 如果MHA过程中失败，是否可以重新执行MHA的failover呢？</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#三、遇到的坑"><span class="toc-number">4.</span> <span class="toc-text">三、遇到的坑</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#3-1_交互模式下，如果没有及时敲’YES’，则终止切换"><span class="toc-number">4.1.</span> <span class="toc-text">3.1 交互模式下，如果没有及时敲’YES’，则终止切换</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#四、总结"><span class="toc-number">5.</span> <span class="toc-text">四、总结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#五、流程简介"><span class="toc-number">6.</span> <span class="toc-text">五、流程简介</span></a></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>50</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>37</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Error/" title="Error">Error<sup>2</sup></a></li>
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>9</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MHA/" title="MHA">MHA<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>46</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>6</sup></a></li>
		
			<li><a href="/tags/MySQL-实战/" title="MySQL 实战">MySQL 实战<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
