
 <!DOCTYPE HTML>
<html >
<head>
  <meta charset="UTF-8">
  
    <title>MySQL锁系列（七）之 锁算法详解 | Focus on MySQL,Focus on Life</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="兰春">
    
    <meta name="description" content="能学到什么

隔离级别和锁的关系    
重点讲解在RR隔离级别下的加锁算法逻辑   
重点罗列了比较典型的几种加锁逻辑案例  
对insert的加锁逻辑进行了深度剖析  
实战中剖析加锁的全过程  
InnoDB为什么要这样加锁  

隔离级别和算法

repeatable-read

121. ">
    
    
    
    
    
    <link rel="icon" href="/img/lanchun.jpg">
    
    
    <link rel="apple-touch-icon" href="/img/lanchun.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/lanchun.jpg">
    

	
	<link href="http://cdn.bootcss.com/highlight.js/8.2/styles/railscasts.min.css" rel="stylesheet">
	<script src="http://cdn.bootcss.com/highlight.js/8.2/highlight.min.js"></script>
	<script>hljs.initHighlightingOnLoad();</script>
	

    <link rel="stylesheet" href="/css/style.css" type="text/css">


</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Focus on MySQL,Focus on Life">Focus on MySQL,Focus on Life</a></h1>
				<h2 class="blog-motto"></h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="Menu">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="http://Keithlan.github.io/">Page</a></li>
					
					<li>
					
					</li>
                <li><div class="closeaside"><a class="closebutton" href="#" title="Hide Sidebar"></a></div></li>

				</ul>
			</nav>	
</div>

    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/06/21/innodb_locks_algorithms/" title="MySQL锁系列（七）之 锁算法详解" itemprop="url">MySQL锁系列（七）之 锁算法详解</a>
  </h1>
  <p class="article-author">By
    
      <a href="https://Keithlan.github.io" title="兰春">兰春</a>
    </p>
  <p class="article-time">
    <time datetime="2017-06-21T07:32:24.000Z" itemprop="datePublished">Jun 21 2017</time>
    Updated:<time datetime="2017-06-21T08:04:56.000Z" itemprop="dateModified">Jun 21 2017</time>
    
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title">Contents</strong>
		<ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#能学到什么"><span class="toc-number">1.</span> <span class="toc-text">能学到什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#隔离级别和算法"><span class="toc-number">2.</span> <span class="toc-text">隔离级别和算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#锁算法的案例剖析"><span class="toc-number">3.</span> <span class="toc-text">锁算法的案例剖析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#insert_操作的加锁逻辑"><span class="toc-number">4.</span> <span class="toc-text">insert 操作的加锁逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战案例"><span class="toc-number">5.</span> <span class="toc-text">实战案例</span></a></li></ol>
		</div>
		
		<h2 id="能学到什么">能学到什么</h2>
<ol>
<li>隔离级别和锁的关系    </li>
<li>重点讲解在RR隔离级别下的加锁算法逻辑   </li>
<li>重点罗列了比较典型的几种加锁逻辑案例  </li>
<li>对insert的加锁逻辑进行了深度剖析  </li>
<li>实战中剖析加锁的全过程  </li>
<li>InnoDB为什么要这样加锁  </li>
</ol>
<h2 id="隔离级别和算法">隔离级别和算法</h2>
<ul>
<li>repeatable-read</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span> 使用的是<span class="keyword">next</span>-<span class="keyword">key</span> locking</div><div class="line"><span class="number">2.</span> <span class="keyword">next</span>-<span class="keyword">key</span> lock  =  record lock + Gap lock</div></pre></td></tr></table></figure>



<ul>
<li>read-committed</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">1. 使用的是 record <span class="operator"><span class="keyword">lock</span></span></div><div class="line"><span class="number">2.</span> 当然特殊情况下( <span class="keyword">purge</span> + <span class="keyword">unique</span> <span class="keyword">key</span> )，也会有Gap <span class="keyword">lock</span></div></pre></td></tr></table></figure>

<p>我们接下来就以RR隔离级别来阐述，因为RC更加简单  </p>
<ul>
<li>锁的通用算法</li>
</ul>
<blockquote>
<p>RR隔离级别</p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="number">1.</span> 锁是在索引上实现的  </div><div class="line"><span class="number">2.</span> 假设有一个<span class="keyword">key</span>，有<span class="number">5</span>条记录， <span class="number">1</span>，<span class="number">3</span>，<span class="number">5</span>，<span class="number">7</span>，<span class="number">9.</span>  如果<span class="keyword">where</span> id&lt;<span class="number">5</span> ， 那么锁住的区间不是（-∞，<span class="number">5</span>），而是(-∞,<span class="number">1</span>],(<span class="number">1</span>,<span class="number">3</span>],(<span class="number">3</span>,<span class="number">5</span>] 多个区间组合而成  </div><div class="line"><span class="number">3.</span> RR隔离级别使用的是：<span class="keyword">next</span>-<span class="keyword">key</span> lock算法，即：锁住 记录本身+区间</div><div class="line"><span class="number">4.</span> <span class="keyword">next</span>-<span class="keyword">key</span> lock 降级为 record lock的情况</div><div class="line">	如果是唯一索引，且查询条件得到的结果集是<span class="number">1</span>条记录（等值，而不是范围），那么会降级为记录锁  </div><div class="line">	典型的案例：<span class="keyword">where</span> primary_key = <span class="number">1</span> (会降级), 而不是 <span class="keyword">where</span> primary_key &lt; <span class="number">10</span> （由于返回的结果集不仅仅一条，那么不会降级）</div><div class="line"><span class="number">5.</span> 上锁，不仅仅对主键索引加锁，还需要对辅助索引加锁，这一点非常重要</div></pre></td></tr></table></figure>

<h2 id="锁算法的案例剖析">锁算法的案例剖析</h2>
<blockquote>
<p>RR隔离级别</p>
</blockquote>
<ul>
<li>表结构</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="header">dba:lc_3&gt; show create table a;</span></div><div class="line">+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">-------------+</div><div class="line">| Table | Create Table</div><div class="line"><span class="header">             |</span></div><div class="line">+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">-------------+</div><div class="line">| a     | CREATE TABLE <span class="code">`a`</span> (</div><div class="line"><span class="code">  `a` int(11) NOT NULL,</span></div><div class="line"><span class="code">  `b` int(11) DEFAULT NULL,</span></div><div class="line"><span class="code">  `c` int(11) DEFAULT NULL,</span></div><div class="line"><span class="code">  `d` int(11) DEFAULT NULL,</span></div><div class="line"><span class="code">  PRIMARY KEY (`a`),</span></div><div class="line"><span class="code">  UNIQUE KEY `idx_b` (`b`),</span></div><div class="line"><span class="code">  KEY `idx_c` (`c`)</span></div><div class="line"><span class="header">) ENGINE=InnoDB DEFAULT CHARSET=utf8 |</span></div><div class="line">+-------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------</div><div class="line">-------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dba:lc_3&gt; select * from a;</span></div><div class="line">+---+------+------+------+</div><div class="line"><span class="header">| a | b    | c    | d    |</span></div><div class="line">+---+------+------+------+</div><div class="line">| 1 |    3 |    5 |    7 |</div><div class="line">| 3 |    5 |    7 |    9 |</div><div class="line">| 5 |    7 |    9 |   11 |</div><div class="line"><span class="header">| 7 |    9 |   11 |   13 |</span></div><div class="line">+---+------+------+------+</div><div class="line">4 rows in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="bullet">* </span>设置RR隔离级别</div><div class="line">set tx<span class="emphasis">_isolation = 'repeatable-read';</span></div></pre></td></tr></table></figure>

<ul>
<li>等值查询，非唯一索引的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; begin;</div><div class="line">Query OK, <span class="number">0</span> rows affected (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where c=<span class="number">9</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">5</span> |    <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601815</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601815</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601815</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d012a; <span class="built_in">asc</span>    <span class="comment">'  *;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601815</span> lock_mode X locks gap before rec</div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_c： </div><div class="line">	<span class="number">1.</span> 加<span class="keyword">next</span>-key lock，((<span class="number">7</span>,<span class="number">3</span>),(<span class="number">9</span>,<span class="number">5</span>)] , ((<span class="number">9</span>,<span class="number">5</span>),(<span class="number">11</span>,<span class="number">7</span>)]，解读一下：((<span class="number">7</span>,<span class="number">3</span>),(<span class="number">9</span>,<span class="number">5</span>)] 表示：<span class="number">7</span>是二级索引key，<span class="number">3</span>是对应的主键  </div><div class="line">	<span class="number">2.</span>这样写不太好懂，所以以后就暂时忽略掉主键这样写： <span class="keyword">next</span>-key lock = (<span class="number">7</span>,<span class="number">9</span>],(<span class="number">9</span>,<span class="number">11</span>]</div><div class="line"> </div><div class="line">对主键索引primary： 加record lock，[<span class="number">5</span>]</div></pre></td></tr></table></figure>

<ul>
<li>等值查询，唯一键的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where b=<span class="number">9</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |   <span class="number">13</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601816</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">4</span> n bits <span class="number">72</span> index idx_b of table `lc_3`.`a` trx id <span class="number">133601816</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601816</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0137; <span class="built_in">asc</span>    <span class="comment">'  7;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>d; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_b：</div><div class="line">	<span class="number">1.</span> 加record lock，[<span class="number">9</span>]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">	<span class="number">1.</span> 加record lock，[<span class="number">7</span>]</div></pre></td></tr></table></figure>

<ul>
<li><blockquote>
<p>= ，非唯一索引的加锁逻辑</p>
</blockquote>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where c&gt;=<span class="number">9</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">5</span> |    <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |</div><div class="line">| <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |   <span class="number">13</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601817</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601817</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">8</span>; <span class="built_in">hex</span> <span class="number">73757072656</span>d756d; <span class="built_in">asc</span> supremum;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601817</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d012a; <span class="built_in">asc</span>    <span class="comment">'  *;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0137; <span class="built_in">asc</span>    <span class="comment">'  7;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>d; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_c：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (<span class="number">7</span>,<span class="number">9</span>],(<span class="number">9</span>,<span class="number">11</span>],(<span class="number">11</span>,∞]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">5</span>],[<span class="number">7</span>]</div></pre></td></tr></table></figure>

<ul>
<li><blockquote>
<p>= ，唯一索引的加锁逻辑</p>
</blockquote>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where b&gt;=<span class="number">7</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">5</span> |    <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |</div><div class="line">| <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |   <span class="number">13</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601820</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">4</span> n bits <span class="number">72</span> index idx_b of table `lc_3`.`a` trx id <span class="number">133601820</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">8</span>; <span class="built_in">hex</span> <span class="number">73757072656</span>d756d; <span class="built_in">asc</span> supremum;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601820</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d012a; <span class="built_in">asc</span>    <span class="comment">'  *;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0137; <span class="built_in">asc</span>    <span class="comment">'  7;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>d; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_b：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (<span class="number">5</span>,<span class="number">7</span>],(<span class="number">7</span>,<span class="number">9</span>],(<span class="number">9</span>,∞]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">5</span>],[<span class="number">7</span>]</div></pre></td></tr></table></figure>

<ul>
<li>&lt;= , 非唯一索引的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where c&lt;=<span class="number">7</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">1</span> |    <span class="number">3</span> |    <span class="number">5</span> |    <span class="number">7</span> |</div><div class="line">| <span class="number">3</span> |    <span class="number">5</span> |    <span class="number">7</span> |    <span class="number">9</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601822</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601822</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601822</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0110; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d011d; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_c：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (-∞,<span class="number">5</span>],(<span class="number">5</span>,<span class="number">7</span>],(<span class="number">7</span>,<span class="number">9</span>]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">1</span>],[<span class="number">3</span>]</div></pre></td></tr></table></figure>

<ul>
<li>&lt;= , 唯一索引的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where b&lt;=<span class="number">5</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">1</span> |    <span class="number">3</span> |    <span class="number">5</span> |    <span class="number">7</span> |</div><div class="line">| <span class="number">3</span> |    <span class="number">5</span> |    <span class="number">7</span> |    <span class="number">9</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">2</span> rows <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601823</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">4</span> n bits <span class="number">72</span> index idx_b of table `lc_3`.`a` trx id <span class="number">133601823</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601823</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0110; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d011d; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_b：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (-∞,<span class="number">3</span>],(<span class="number">3</span>,<span class="number">5</span>],(<span class="number">5</span>,<span class="number">7</span>]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">1</span>],[<span class="number">3</span>]</div></pre></td></tr></table></figure>

<ul>
<li><blockquote>
<p>, 非唯一索引的加锁逻辑</p>
</blockquote>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where c&gt;<span class="number">9</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |   <span class="number">13</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601825</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">8</span>; <span class="built_in">hex</span> <span class="number">73757072656</span>d756d; <span class="built_in">asc</span> supremum;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601825</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0137; <span class="built_in">asc</span>    <span class="comment">'  7;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>d; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_c：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (<span class="number">9</span>,<span class="number">11</span>],(<span class="number">11</span>,∞]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">7</span>]</div></pre></td></tr></table></figure>

<ul>
<li><blockquote>
<p>, 唯一索引的加锁逻辑</p>
</blockquote>
</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where b&gt;<span class="number">7</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">7</span> |    <span class="number">9</span> |   <span class="number">11</span> |   <span class="number">13</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601826</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">4</span> n bits <span class="number">72</span> index idx_b of table `lc_3`.`a` trx id <span class="number">133601826</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">8</span>; <span class="built_in">hex</span> <span class="number">73757072656</span>d756d; <span class="built_in">asc</span> supremum;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601826</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">5</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0137; <span class="built_in">asc</span>    <span class="comment">'  7;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>b; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000000</span>d; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_b：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (<span class="number">7</span>,<span class="number">9</span>],(<span class="number">9</span>,∞]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">7</span>]</div></pre></td></tr></table></figure>

<ul>
<li>&lt; , 非唯一索引的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where c&lt;<span class="number">7</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">1</span> |    <span class="number">3</span> |    <span class="number">5</span> |    <span class="number">7</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601827</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601827</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601827</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0110; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_c：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (-∞,<span class="number">5</span>],(<span class="number">5</span>,<span class="number">7</span>]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">1</span>]</div></pre></td></tr></table></figure>

<p>`</p>
<ul>
<li>&lt; , 唯一索引的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from a where b&lt;<span class="number">5</span> <span class="keyword">for</span> update;</div><div class="line">+---+------+------+------+</div><div class="line">| a | b    | c    | d    |</div><div class="line">+---+------+------+------+</div><div class="line">| <span class="number">1</span> |    <span class="number">3</span> |    <span class="number">5</span> |    <span class="number">7</span> |</div><div class="line">+---+------+------+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601828</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">4</span> n bits <span class="number">72</span> index idx_b of table `lc_3`.`a` trx id <span class="number">133601828</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601828</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0110; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">锁的结构如下：</div><div class="line"></div><div class="line">对二级索引idx_c：</div><div class="line">    <span class="number">1.</span> 加<span class="keyword">next</span>-key lock， (-∞,<span class="number">3</span>],(<span class="number">3</span>,<span class="number">5</span>]</div><div class="line"></div><div class="line">对主键索引primary：</div><div class="line">    <span class="number">1.</span> 加record lock，[<span class="number">1</span>]</div></pre></td></tr></table></figure>

<ul>
<li>总结之前的加锁逻辑</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div></pre></td><td class="code"><pre><div class="line">* 如果</div><div class="line"><span class="number">1.</span> select * from xx where col &lt;比较运算符&gt; M <span class="keyword">for</span> update  </div><div class="line"><span class="number">2.</span> M-&gt;<span class="keyword">next</span>-rec: 表示M的下一条记录</div><div class="line"><span class="number">3.</span> M-&gt;pre-rec: 表示M的前一条记录 </div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">########第一轮总结########</span></div><div class="line"></div><div class="line"> </div><div class="line">* 等值查询M，非唯一索引的加锁逻辑</div><div class="line"> 	(M-&gt;pre-rec,M],(M,M-&gt;<span class="keyword">next</span>-rec]</div><div class="line"> </div><div class="line">* 等值查询M，唯一键的加锁逻辑</div><div class="line"> 	[M], <span class="keyword">next</span>-lock 降级为 record locks</div><div class="line"> </div><div class="line">* &gt;= ，非唯一索引的加锁逻辑</div><div class="line">	(M-&gt;pre_rec,M],(M,M-&gt;<span class="keyword">next</span>-rec]....(∞]</div><div class="line">	</div><div class="line">* &gt;= ，唯一索引的加锁逻辑</div><div class="line">	(M-&gt;pre_rec,M],(M,M-&gt;<span class="keyword">next</span>-rec]....(∞]</div><div class="line">	</div><div class="line">* &lt;= , 非唯一索引的加锁逻辑</div><div class="line">    (-∞] <span class="keyword">...</span> (M,M-&gt;<span class="keyword">next</span>-rec]</div><div class="line">	</div><div class="line">* &lt;= , 唯一索引的加锁逻辑</div><div class="line">	(-∞] <span class="keyword">...</span> (M,M-&gt;<span class="keyword">next</span>-rec]	</div><div class="line"> </div><div class="line">* &gt; , 非唯一索引的加锁逻辑</div><div class="line">	 (M,M-&gt;<span class="keyword">next</span>-rec] <span class="keyword">...</span> (∞] </div><div class="line">	 </div><div class="line">* &gt; , 唯一索引的加锁逻辑</div><div class="line">	 (M,M-&gt;<span class="keyword">next</span>-rec] <span class="keyword">...</span> (∞] </div><div class="line">	 </div><div class="line">* &lt; , 非唯一索引的加锁逻辑</div><div class="line">     (-∞] <span class="keyword">...</span> (M-&gt;rec,M]</div><div class="line">	 </div><div class="line">* &lt; , 唯一索引的加锁逻辑</div><div class="line">	 (-∞] <span class="keyword">...</span> (M-&gt;rec,M]</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">########第二轮总结合并########</span></div><div class="line"></div><div class="line">* 等值查询M，非唯一索引的加锁逻辑</div><div class="line">    (M-&gt;pre-rec,M],(M,M-&gt;<span class="keyword">next</span>-rec]</div><div class="line"></div><div class="line">* 等值查询M，唯一键的加锁逻辑</div><div class="line">    [M], <span class="keyword">next</span>-lock 降级为 record locks</div><div class="line">    这里大家还记得之前讲过的通用算法吗： </div><div class="line">			<span class="keyword">next</span>-key lock 降级为 record lock的情况：</div><div class="line">				如果是唯一索引，且查询条件得到的结果集是<span class="number">1</span>条记录（等值，而不是范围），那么会降级为记录锁</div><div class="line"></div><div class="line">* &gt;= ，加锁逻辑</div><div class="line">    (M-&gt;pre_rec,M],(M,M-&gt;<span class="keyword">next</span>-rec]....(∞]</div><div class="line"></div><div class="line">* &gt; ,  加锁逻辑</div><div class="line">     (M,M-&gt;<span class="keyword">next</span>-rec] <span class="keyword">...</span> (∞]</div><div class="line"></div><div class="line">* &lt;= , 加锁逻辑</div><div class="line">    (-∞] <span class="keyword">...</span> (M,M-&gt;<span class="keyword">next</span>-rec]</div><div class="line"></div><div class="line">* &lt; , 加锁逻辑</div><div class="line">     (-∞] <span class="keyword">...</span> (M-&gt;rec,M]</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">########最后的疑问和总结########</span></div><div class="line"></div><div class="line"><span class="number">1.</span> 疑问： 为什么要对M-&gt;<span class="keyword">next</span>-rec 或者  M-&gt;pre-rec ？ </div><div class="line"></div><div class="line"><span class="number">1.</span> 回答： 因为为了防止幻读。</div></pre></td></tr></table></figure>

<p><img src="/image/mysql_innodb_arch/lock_update_0.jpg" alt="lock_update_0" title="lock_update_0">  </p>
<h2 id="insert_操作的加锁逻辑">insert 操作的加锁逻辑</h2>
<blockquote>
<p>RR 隔离级别</p>
</blockquote>
<ul>
<li>表结构</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="header">dba:lc_3&gt; show create table tb_non_uk;</span></div><div class="line">+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line"><span class="header">| Table     | Create Table                                                                                                                                                                                           |</span></div><div class="line">+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">| tb<span class="emphasis">_non_</span>uk | CREATE TABLE <span class="code">`tb_non_uk`</span> (</div><div class="line"><span class="code">  `id` int(11) NOT NULL AUTO_INCREMENT,</span></div><div class="line"><span class="code">  `id_2` int(11) DEFAULT NULL,</span></div><div class="line"><span class="code">  PRIMARY KEY (`id`),</span></div><div class="line"><span class="code">  KEY `idx_id2` (`id_2`)</span></div><div class="line"><span class="header">) ENGINE=InnoDB AUTO_INCREMENT=3 DEFAULT CHARSET=utf8 |</span></div><div class="line">+-----------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dba:lc_3&gt; show create table tb_uk;</span></div><div class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line"><span class="header">| Table | Create Table                                                                                                                                                                                                |</span></div><div class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">| tb<span class="emphasis">_uk | CREATE TABLE `tb_</span>uk` (</div><div class="line"><span class="code">  `id` int(11) NOT NULL AUTO_INCREMENT,</span></div><div class="line"><span class="code">  `id_2` int(11) DEFAULT NULL,</span></div><div class="line"><span class="code">  PRIMARY KEY (`id`),</span></div><div class="line"><span class="code">  UNIQUE KEY `uniq_idx` (`id_2`)</span></div><div class="line"><span class="header">) ENGINE=InnoDB AUTO_INCREMENT=36 DEFAULT CHARSET=utf8 |</span></div><div class="line">+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line"><span class="header">dba:lc_3&gt; select * from tb_non_uk;</span></div><div class="line">+----+------+</div><div class="line"><span class="header">| id | id_2 |</span></div><div class="line">+----+------+</div><div class="line">|  1 |  100 |</div><div class="line"><span class="header">|  2 |  200 |</span></div><div class="line">+----+------+</div><div class="line">2 rows in set (0.00 sec)</div><div class="line"></div><div class="line"><span class="header">dba:lc_3&gt; select * from tb_uk;</span></div><div class="line">+----+------+</div><div class="line"><span class="header">| id | id_2 |</span></div><div class="line">+----+------+</div><div class="line">|  1 |   10 |</div><div class="line">|  2 |   20 |</div><div class="line"><span class="header">| 33 |   30 |</span></div><div class="line">+----+------+</div><div class="line">3 rows in set (0.00 sec)</div></pre></td></tr></table></figure>

<ul>
<li>普通的insert,insert之前,其他事务没有对next-record加任何锁  </li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div><div class="line"><span class="vim">db<span class="variable">a:lc_3</span>&gt; <span class="built_in">insert</span> into tb_uk select <span class="number">100</span>,<span class="number">200</span>;</span></div><div class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</div><div class="line">Record<span class="variable">s:</span> <span class="number">1</span>  Duplicate<span class="variable">s:</span> <span class="number">0</span>  Warning<span class="variable">s:</span> <span class="number">0</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">锁的结构：</div><div class="line"></div><div class="line"></div><div class="line">MySQL thread id <span class="number">11888</span>, OS thread handle <span class="number">140000862643968</span>, query id <span class="number">24975</span> localhost dba cleaning <span class="keyword">up</span></div><div class="line">TABLE LOCK table `lc_3`.`tb_uk` trx id <span class="number">133601936</span> lock <span class="built_in">mode</span> IX</div><div class="line"></div><div class="line">没有加任何的锁，除了在表上面加了意向锁之外，这个锁基本上只要访问到表都会加的  </div><div class="line"></div><div class="line">难道<span class="built_in">insert</span>不会加锁吗？显然不是，那是因为加的是隐式类型的锁</div></pre></td></tr></table></figure>

<ul>
<li>有唯一键约束，insert之前，其他事务且对其next-record加了Gap-lock</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">* session <span class="number">1</span>: </div><div class="line"></div><div class="line"><span class="keyword">select</span> * from tb_uk where id_2 &gt;= <span class="number">30</span> <span class="keyword">for</span> update;</div><div class="line"></div><div class="line">TABLE LOCK table <span class="string">`lc_3`</span>.<span class="string">`tb_uk`</span> trx id <span class="number">133601951</span> lock mode IX</div><div class="line">RECORD LOCKS space id <span class="number">301</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">72</span> <span class="keyword">index</span> uniq_idx of table <span class="string">`lc_3`</span>.<span class="string">`tb_uk`</span> trx id <span class="number">133601951</span> lock_mode X</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">8</span>; <span class="keyword">hex</span> <span class="number">73757072656</span>d756d; asc supremum;;</div><div class="line"></div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">8000001</span>e; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000021</span>; asc    !;;</div><div class="line"></div><div class="line">RECORD LOCKS space id <span class="number">301</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> <span class="keyword">index</span> PRIMARY of table <span class="string">`lc_3`</span>.<span class="string">`tb_uk`</span> trx id <span class="number">133601951</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000021</span>; asc    !;;</div><div class="line"> <span class="number">1</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000007</span>f69a77; asc      w;;</div><div class="line"> <span class="number">2</span>: len <span class="number">7</span>; <span class="keyword">hex</span> ad00000d01011<span class="number">0</span>; asc        ;;</div><div class="line"> <span class="number">3</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">8000001</span>e; asc     ;;</div><div class="line"></div><div class="line">锁住： (<span class="number">20</span>,<span class="number">30</span>](<span class="number">30</span>,∞) ， 对<span class="number">30</span>有Gap锁</div><div class="line"></div><div class="line"></div><div class="line">* session <span class="number">2</span>:</div><div class="line"></div><div class="line">dba:lc_3&gt; insert into tb_uk <span class="keyword">select</span> <span class="number">3</span>,<span class="number">25</span>;</div><div class="line">Query OK, <span class="number">1</span> row affected (<span class="number">6.30</span> sec)</div><div class="line">Records: <span class="number">1</span>  Duplicates: <span class="number">0</span>  Warnings: <span class="number">0</span></div><div class="line"></div><div class="line"></div><div class="line">* session <span class="number">1</span>:</div><div class="line"></div><div class="line">rollback;</div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table <span class="string">`lc_3`</span>.<span class="string">`tb_uk`</span> trx id <span class="number">133601952</span> lock mode IX</div><div class="line">RECORD LOCKS space id <span class="number">301</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">72</span> <span class="keyword">index</span> uniq_idx of table <span class="string">`lc_3`</span>.<span class="string">`tb_uk`</span> trx id <span class="number">133601952</span> lock_mode X locks gap before rec insert intention</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">8000001</span>e; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000021</span>; asc    !;;</div><div class="line"></div><div class="line">当session2 插入<span class="number">25</span>的时候，这时候session2 会被卡住。 然后session <span class="number">2</span> 释放gap lock后，session <span class="number">1</span> 就持有插入意向锁 lock_mode X locks gap before rec insert intention</div></pre></td></tr></table></figure>

<ul>
<li>有唯一键约束，insert之前，其他事务且对其next-record加了record lock</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="bullet">* </span>session 1:</div><div class="line"></div><div class="line"><span class="header">dba:lc_3&gt; select * from tb_uk where id_2 = 30 for update;</span></div><div class="line">+----+------+</div><div class="line"><span class="header">| id | id_2 |</span></div><div class="line">+----+------+</div><div class="line"><span class="header">| 33 |   30 |</span></div><div class="line">+----+------+</div><div class="line">1 row in set (0.00 sec)</div><div class="line"></div><div class="line"></div><div class="line">TABLE LOCK table <span class="code">`lc_3`</span>.<span class="code">`tb_uk`</span> trx id 133601943 lock mode IX</div><div class="line">RECORD LOCKS space id 301 page no 4 n bits 72 index uniq<span class="emphasis">_idx of table `lc_</span>3<span class="code">`.`</span>tb<span class="emphasis">_uk` trx id 133601943 lock_</span>mode X locks rec but not gap</div><div class="line">Record lock, heap no 4 PHYSICAL RECORD: n<span class="emphasis">_fields 2; compact format; info bits 0</span></div><div class="line"> 0: len 4; hex 8000001e; asc     ;;</div><div class="line"> 1: len 4; hex 80000021; asc    !;;</div><div class="line"></div><div class="line">RECORD LOCKS space id 301 page no 3 n bits 72 index PRIMARY of table <span class="code">`lc_3`</span>.<span class="code">`tb_uk`</span> trx id 133601943 lock<span class="emphasis">_mode X locks rec but not gap</span></div><div class="line">Record lock, heap no 4 PHYSICAL RECORD: n_fields 4; compact format; info bits 0</div><div class="line"><span class="code"> 0: len 4; hex 80000021; asc    !;;</span></div><div class="line"><span class="code"> 1: len 6; hex 000007f69a77; asc      w;;</span></div><div class="line"><span class="code"> 2: len 7; hex ad00000d010110; asc        ;;</span></div><div class="line"><span class="code"> 3: len 4; hex 8000001e; asc     ;;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="bullet">* </span>session 2:</div><div class="line"></div><div class="line">dba:lc<span class="emphasis">_3&gt; insert into tb_</span>uk select 3,25;</div><div class="line">Query OK, 1 row affected (0.00 sec)</div><div class="line">Records: 1  Duplicates: 0  Warnings: 0</div><div class="line"></div><div class="line"></div><div class="line">锁结构：</div><div class="line"></div><div class="line">说明有唯一键约束，insert之前，其他事务且对其next-record加了record lock，不会阻塞insert。</div><div class="line"></div><div class="line">此时的insert，也不会产生insert intension lock</div></pre></td></tr></table></figure>

<ul>
<li>有唯一键约束，insert 记录之后，发现原来的表有重复值的情况,</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">* session <span class="number">1</span>:</div><div class="line"></div><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from tb_uk where id_2 = <span class="number">30</span> <span class="keyword">for</span> update;</div><div class="line">+----+------+</div><div class="line">| id | id_2 |</div><div class="line">+----+------+</div><div class="line">| <span class="number">33</span> |   <span class="number">30</span> |</div><div class="line">+----+------+</div><div class="line"><span class="number">1</span> row <span class="keyword">in</span> <span class="keyword">set</span> (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">dba:lc_3&gt; delete from tb_uk where id_2 = <span class="number">20</span>;</div><div class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</div><div class="line"></div><div class="line">这时候的锁结构如下：</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`tb_uk` trx id <span class="number">133601943</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">301</span> page no <span class="number">4</span> n bits <span class="number">72</span> index uniq_idx of table `lc_3`.`tb_uk` trx id <span class="number">133601943</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">32</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000014</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000002</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000001</span>e; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000021</span>; <span class="built_in">asc</span>    !;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">301</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`tb_uk` trx id <span class="number">133601943</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">32</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000002</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f69a97; <span class="built_in">asc</span>       ;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> <span class="number">460000403</span>f090b; <span class="built_in">asc</span> F  @?  ;;</div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000014</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000021</span>; <span class="built_in">asc</span>    !;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f69a77; <span class="built_in">asc</span>      w;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> ad00000d010110; <span class="built_in">asc</span>        ;;</div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000001</span>e; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">对二级索引uniq_idx ： </div><div class="line">	<span class="number">1.</span> 加record lock ， [<span class="number">20</span>]，[<span class="number">30</span>]</div><div class="line"></div><div class="line">对主键索引：</div><div class="line">	<span class="number">1.</span> 加record lock，[<span class="number">2</span>],[<span class="number">33</span>]</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">* session <span class="number">2</span>: </div><div class="line"></div><div class="line">dba:lc_3&gt; insert into tb_uk <span class="keyword">select</span> <span class="number">3</span>,<span class="number">20</span>;</div><div class="line">...............waiting.................</div><div class="line"></div><div class="line"></div><div class="line">这时候，我们再来看看锁结构：</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`tb_uk` trx id <span class="number">133601949</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">301</span> page no <span class="number">4</span> n bits <span class="number">72</span> index uniq_idx of table `lc_3`.`tb_uk` trx id <span class="number">133601949</span> lock mode S waiting</div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">32</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000014</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000002</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">---TRANSACTION <span class="number">133601943</span>, ACTIVE <span class="number">490</span> sec</div><div class="line"><span class="number">3</span> lock struct(s), heap size <span class="number">1136</span>, <span class="number">4</span> row lock(s), undo <span class="built_in">log</span> entries <span class="number">1</span></div><div class="line">MySQL thread id <span class="number">11889</span>, OS thread handle <span class="number">140000878618368</span>, query id <span class="number">25018</span> localhost dba cleaning up</div><div class="line">TABLE LOCK table `lc_3`.`tb_uk` trx id <span class="number">133601943</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">301</span> page no <span class="number">4</span> n bits <span class="number">72</span> index uniq_idx of table `lc_3`.`tb_uk` trx id <span class="number">133601943</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">32</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000014</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000002</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000001</span>e; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000021</span>; <span class="built_in">asc</span>    !;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">301</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`tb_uk` trx id <span class="number">133601943</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">32</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000002</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f69a97; <span class="built_in">asc</span>       ;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> <span class="number">460000403</span>f090b; <span class="built_in">asc</span> F  @?  ;;</div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000014</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000021</span>; <span class="built_in">asc</span>    !;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f69a77; <span class="built_in">asc</span>      w;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> ad00000d010110; <span class="built_in">asc</span>        ;;</div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">8000001</span>e; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line">info bits <span class="number">32</span> 表示这条记录已经标记为删除状态  </div><div class="line"></div><div class="line">这里面的session <span class="number">2</span> ： insert into tb_uk <span class="keyword">select</span> <span class="number">3</span>,<span class="number">20</span>; 被阻塞了</div><div class="line">因为，这条insert 语句需要对 uniq_idx中的<span class="number">20</span>加lock mode S ， 但是发现session <span class="number">1</span> 已经对其加了lock_mode X locks rec but <span class="keyword">not</span> gap，而这条记录被标记为删除状态  </div><div class="line">所以发生锁等待，因为S lock 和 X lock 冲突</div></pre></td></tr></table></figure>

<ul>
<li>没有唯一键约束,insert之前，其他事务对其next-record加了Gap-lock</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">* session <span class="number">1</span>:</div><div class="line"></div><div class="line">dba:lc_3&gt; <span class="keyword">select</span> * from tb_non_uk where id_2&gt;=<span class="number">100</span> <span class="keyword">for</span> update;</div><div class="line">+----+------+</div><div class="line">| id | id_2 |</div><div class="line">+----+------+</div><div class="line">|  <span class="number">1</span> |  <span class="number">100</span> |</div><div class="line">|  <span class="number">2</span> |  <span class="number">200</span> |</div><div class="line">+----+------+</div><div class="line"><span class="number">2</span> rows in set (<span class="number">0</span>.<span class="number">00</span> sec)</div><div class="line"></div><div class="line">锁结构：</div><div class="line"></div><div class="line">TABLE LOCK table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601939</span> lock mode IX</div><div class="line">RECORD LOCKS space id <span class="number">302</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">72</span> <span class="keyword">index</span> idx_id2 of table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601939</span> lock_mode X</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">8</span>; <span class="keyword">hex</span> <span class="number">73757072656</span>d756d; asc supremum;;</div><div class="line"></div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">800000</span>c8; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</div><div class="line"></div><div class="line">RECORD LOCKS space id <span class="number">302</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> <span class="keyword">index</span> PRIMARY of table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601939</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000007</span>f69a6b; asc      k;;</div><div class="line"> <span class="number">2</span>: len <span class="number">7</span>; <span class="keyword">hex</span> a500000d36011<span class="number">0</span>; asc     <span class="number">6</span>  ;;</div><div class="line"> <span class="number">3</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">800000</span>c8; asc     ;;</div><div class="line"></div><div class="line">对idx_id2二级索引： (<span class="number">100</span>,<span class="number">200</span>],(<span class="number">200</span>,∞]</div><div class="line">对主键索引： [<span class="number">2</span>]</div><div class="line"></div><div class="line">* session <span class="number">2</span>:</div><div class="line"></div><div class="line">dba:lc_3&gt; insert into tb_non_uk <span class="keyword">select</span> <span class="number">3</span>,<span class="number">150</span>;</div><div class="line">......waiting.....</div><div class="line"></div><div class="line">---TRANSACTION <span class="number">133601940</span>, ACTIVE <span class="number">3</span> sec inserting</div><div class="line">mysql tables in <span class="keyword">use</span> <span class="number">1</span>, locked <span class="number">1</span></div><div class="line">LOCK WAIT <span class="number">2</span> lock struct(<span class="keyword">s</span>), heap size <span class="number">1136</span>, <span class="number">1</span> row lock(<span class="keyword">s</span>), undo <span class="keyword">log</span> entries <span class="number">1</span></div><div class="line">MySQL thread id <span class="number">11888</span>, OS thread handle <span class="number">140000862643968</span>, query id <span class="number">24996</span> localhost dba executing</div><div class="line">insert into tb_non_uk <span class="keyword">select</span> <span class="number">3</span>,<span class="number">150</span></div><div class="line">------- TRX HAS BEEN WAITING <span class="number">3</span> SEC FOR THIS LOCK TO BE GRANTED:</div><div class="line">RECORD LOCKS space id <span class="number">302</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">72</span> <span class="keyword">index</span> idx_id2 of table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601940</span> lock_mode X locks gap before rec insert intention waiting</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">800000</span>c8; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</div><div class="line"></div><div class="line">------------------</div><div class="line">TABLE LOCK table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601940</span> lock mode IX</div><div class="line">RECORD LOCKS space id <span class="number">302</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">72</span> <span class="keyword">index</span> idx_id2 of table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601940</span> lock_mode X locks gap before rec insert intention waiting</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">800000</span>c8; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</div><div class="line"></div><div class="line">---TRANSACTION <span class="number">133601939</span>, ACTIVE <span class="number">311</span> sec</div><div class="line"><span class="number">3</span> lock struct(<span class="keyword">s</span>), heap size <span class="number">1136</span>, <span class="number">3</span> row lock(<span class="keyword">s</span>)</div><div class="line">MySQL thread id <span class="number">11889</span>, OS thread handle <span class="number">140000878618368</span>, query id <span class="number">24994</span> localhost dba cleaning up</div><div class="line">TABLE LOCK table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601939</span> lock mode IX</div><div class="line">RECORD LOCKS space id <span class="number">302</span> page <span class="keyword">no</span> <span class="number">4</span> n bits <span class="number">72</span> <span class="keyword">index</span> idx_id2 of table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601939</span> lock_mode X</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">1</span> PHYSICAL RECORD: n_fields <span class="number">1</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">8</span>; <span class="keyword">hex</span> <span class="number">73757072656</span>d756d; asc supremum;;</div><div class="line"></div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">800000</span>c8; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</div><div class="line"></div><div class="line">RECORD LOCKS space id <span class="number">302</span> page <span class="keyword">no</span> <span class="number">3</span> n bits <span class="number">72</span> <span class="keyword">index</span> PRIMARY of table <span class="string">`lc_3`</span>.<span class="string">`tb_non_uk`</span> trx id <span class="number">133601939</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap <span class="keyword">no</span> <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">4</span>; compact <span class="keyword">format</span>; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">80000002</span>; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">6</span>; <span class="keyword">hex</span> <span class="number">000007</span>f69a6b; asc      k;;</div><div class="line"> <span class="number">2</span>: len <span class="number">7</span>; <span class="keyword">hex</span> a500000d36011<span class="number">0</span>; asc     <span class="number">6</span>  ;;</div><div class="line"> <span class="number">3</span>: len <span class="number">4</span>; <span class="keyword">hex</span> <span class="number">800000</span>c8; asc     ;;</div><div class="line"></div><div class="line"></div><div class="line">锁结构：</div><div class="line">	多了一个插入意向锁 lock_mode X locks gap before rec insert intention</div></pre></td></tr></table></figure>

<ul>
<li>总结Insert 操作的加锁流程</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">* <span class="operator"><span class="keyword">insert</span> 的流程(没有唯一索引的情况)： <span class="keyword">insert</span> N</span></div><div class="line"></div><div class="line"><span class="number">1.</span> 找到大于N的第一条记录M</div><div class="line"><span class="number">2.</span> 如果M上面没有gap ， <span class="keyword">next</span>-<span class="keyword">key</span> locking的话，可以插入  ， 否则等待  (对其<span class="keyword">next</span>-rec加<span class="keyword">insert</span> intension <span class="keyword">lock</span>，由于有gap锁，所以等待)</div><div class="line"></div><div class="line">* <span class="keyword">insert</span> 的流程(有唯一索引的情况)： <span class="keyword">insert</span> N</div><div class="line"></div><div class="line"><span class="number">1.</span> 找到大于N的第一条记录M，以及前一条记录P</div><div class="line"><span class="number">2.</span> 如果M上面没有gap ， <span class="keyword">next</span>-<span class="keyword">key</span> locking的话，进入第三步骤  ， 否则等待(对其<span class="keyword">next</span>-rec加<span class="keyword">insert</span> intension <span class="keyword">lock</span>，由于有gap锁，所以等待)</div><div class="line"><span class="number">3.</span> 检查p：</div><div class="line">    判断p是否等于n：</div><div class="line">         如果不等: 则完成插入（结束）</div><div class="line">         如果相等：</div><div class="line">                再判断P 是否有锁，</div><div class="line">                    如果没有锁:</div><div class="line">						报<span class="number">1062</span>错误（duplicate <span class="keyword">key</span>） <span class="comment">--说明该记录已经存在，报重复值错误 </span></div><div class="line">						加S-<span class="keyword">lock</span>  <span class="comment">--说明该记录被标记为删除, 事务已经提交，还没来得及purge</span></div><div class="line">                    如果有锁: 则加S-<span class="keyword">lock</span>  <span class="comment">--说明该记录被标记为删除，事务还未提交.</span></div><div class="line"></div><div class="line"></div><div class="line">* <span class="keyword">insert</span> intension <span class="keyword">lock</span> 有什么用呢？锁的兼容矩阵是啥？</div><div class="line"></div><div class="line"><span class="number">1.</span> <span class="keyword">insert</span> intension <span class="keyword">lock</span> 是一种特殊的Gap <span class="keyword">lock</span>，记住非常特殊哦  </div><div class="line"><span class="number">2.</span> <span class="keyword">insert</span> intension <span class="keyword">lock</span> 和 <span class="keyword">insert</span> intension <span class="keyword">lock</span> 是兼容的，其次都是不兼容的  </div><div class="line"><span class="number">3.</span> Gap <span class="keyword">lock</span> 是为了防止<span class="keyword">insert</span>， <span class="keyword">insert</span> intension <span class="keyword">lock</span> 是为了<span class="keyword">insert</span>并发更快，两者是有区别的  </div><div class="line"><span class="number">4.</span> 什么情况下会出发<span class="keyword">insert</span> intension <span class="keyword">lock</span> ？</div><div class="line">	当<span class="keyword">insert</span>的记录M的 <span class="keyword">next</span>-record 加了Gap <span class="keyword">lock</span>才会发生，record <span class="keyword">lock</span>并不会触发</div></pre></td></tr></table></figure>

<h2 id="实战案例">实战案例</h2>
<blockquote>
<p>RR 隔离级别<br>最后来一个比较复杂的案例作为结束<br>通过这几个案例，可以复习下之前讲过的理论，锁不仅对主键加，还要考虑二级索引哦  </p>
</blockquote>
<ul>
<li>环境</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="operator"><span class="keyword">set</span> tx_isolation = <span class="string">'repeatable-read'</span>;</span></div><div class="line"></div><div class="line"><span class="operator"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`a`</span> (</span></div><div class="line">   <span class="string">`a`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`b`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`c`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="string">`d`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">   <span class="keyword">PRIMARY</span> <span class="keyword">KEY</span> (<span class="string">`a`</span>),</div><div class="line">   <span class="keyword">UNIQUE</span> <span class="keyword">KEY</span> <span class="string">`idx_b`</span> (<span class="string">`b`</span>),</div><div class="line">   <span class="keyword">KEY</span> <span class="string">`idx_c`</span> (<span class="string">`c`</span>)</div><div class="line"> ) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8 </div><div class="line"> </div><div class="line"> dba:lc_3&gt; <span class="keyword">select</span> * <span class="keyword">from</span> a;</div><div class="line"> +<span class="comment">---+------+------+------+</span></div><div class="line"> | a | b    | c    | d    |</div><div class="line"> +<span class="comment">---+------+------+------+</span></div><div class="line"> | 1 |    3 |    5 |    7 |</div><div class="line"> | 3 |    5 |    7 |    9 |</div><div class="line"> | 5 |    7 |    9 |   11 |</div><div class="line"> | 7 |    9 |   11 |   13 |</div><div class="line"> +<span class="comment">---+------+------+------+</span></div><div class="line"> 4 rows in <span class="operator"><span class="keyword">set</span> (<span class="number">0.00</span> sec)</span></div></pre></td></tr></table></figure>

<ul>
<li>加锁语句</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> * from a where c&lt;<span class="number">9</span> <span class="keyword">for</span> update;</div><div class="line"></div><div class="line">锁结构：</div><div class="line"></div><div class="line">TABLE LOCK table `lc_3`.`a` trx id <span class="number">133601957</span> lock mode IX</div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table `lc_3`.`a` trx id <span class="number">133601957</span> lock_mode X</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">RECORD LOCKS <span class="built_in">space</span> id <span class="number">281</span> page no <span class="number">3</span> n bits <span class="number">72</span> index PRIMARY of table `lc_3`.`a` trx id <span class="number">133601957</span> lock_mode X locks rec but <span class="keyword">not</span> gap</div><div class="line">Record lock, heap no <span class="number">2</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000001</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d0110; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line">Record lock, heap no <span class="number">3</span> PHYSICAL RECORD: n_fields <span class="number">6</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000003</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">1</span>: <span class="built_in">len</span> <span class="number">6</span>; <span class="built_in">hex</span> <span class="number">000007</span>f66444; <span class="built_in">asc</span>     dD;;</div><div class="line"> <span class="number">2</span>: <span class="built_in">len</span> <span class="number">7</span>; <span class="built_in">hex</span> fc0000271d011d; <span class="built_in">asc</span>    <span class="comment">'   ;;</span></div><div class="line"> <span class="number">3</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000005</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">4</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000007</span>; <span class="built_in">asc</span>     ;;</div><div class="line"> <span class="number">5</span>: <span class="built_in">len</span> <span class="number">4</span>; <span class="built_in">hex</span> <span class="number">80000009</span>; <span class="built_in">asc</span>     ;;</div><div class="line"></div><div class="line"></div><div class="line">二级索引idx_c 加锁 <span class="keyword">next</span>-key lock： (-∞,<span class="number">5</span>],(<span class="number">5</span>,<span class="number">7</span>],(<span class="number">7</span>,<span class="number">9</span>] </div><div class="line">primary key 加锁 record lock： [<span class="number">1</span>]和[<span class="number">3</span>]</div></pre></td></tr></table></figure>

<p><img src="/image/mysql_innodb_arch/lock_update_1.jpg" alt="lock_update_1" title="lock_update_1"></p>
<ul>
<li>案例一 insert into a select 4,40,9,90</li>
</ul>
<blockquote>
<p>大家觉得能够插入成功吗？  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">dba:lc_3<span class="subst">&gt;</span> insert <span class="keyword">into</span> a <span class="keyword">select</span> <span class="number">4</span>,<span class="number">40</span>,<span class="number">9</span>,<span class="number">90</span>;</div><div class="line">^C^C <span class="subst">--</span> query aborted</div><div class="line">ERROR <span class="number">1317</span> (<span class="number">70100</span>): Query execution was interrupted</div><div class="line"><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">.</span>waiting<span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="attribute">...</span><span class="built_in">..</span></div><div class="line"></div><div class="line">显然是被锁住了</div><div class="line"></div><div class="line">TABLE LOCK table <span class="string">`lc_3`</span><span class="built_in">.</span><span class="string">`a`</span> trx id <span class="number">133601961</span> lock mode IX</div><div class="line">RECORD LOCKS space id <span class="number">281</span> page no <span class="number">5</span> n bits <span class="number">72</span> index idx_c of table <span class="string">`lc_3`</span><span class="built_in">.</span><span class="string">`a`</span> trx id <span class="number">133601961</span> lock_mode X locks gap before rec insert intention waiting</div><div class="line">Record lock, heap no <span class="number">4</span> PHYSICAL RECORD: n_fields <span class="number">2</span>; compact format; info bits <span class="number">0</span></div><div class="line"> <span class="number">0</span>: len <span class="number">4</span>; hex <span class="number">80000009</span>; asc     ;;</div><div class="line"> <span class="number">1</span>: len <span class="number">4</span>; hex <span class="number">80000005</span>; asc     ;;</div></pre></td></tr></table></figure>

<p><img src="/image/mysql_innodb_arch/lock_update_2.jpg" alt="lock_update_2" title="lock_update_2"></p>
<ul>
<li>案例二 insert into a select 6,40,9,90; </li>
</ul>
<blockquote>
<p>大家觉得能够插入成功吗？  </p>
</blockquote>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">db<span class="variable">a:lc_3</span>&gt; <span class="built_in">insert</span> into <span class="keyword">a</span> select <span class="number">6</span>,<span class="number">40</span>,<span class="number">9</span>,<span class="number">90</span>;</div><div class="line">Query OK, <span class="number">1</span> row affected (<span class="number">0.00</span> sec)</div><div class="line">Record<span class="variable">s:</span> <span class="number">1</span>  Duplicate<span class="variable">s:</span> <span class="number">0</span>  Warning<span class="variable">s:</span> <span class="number">0</span></div><div class="line"></div><div class="line">显然是插入成功了</div></pre></td></tr></table></figure>

<p><img src="/image/mysql_innodb_arch/lock_update_3.jpg" alt="lock_update_3" title="lock_update_3"></p>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/InnoDB-Lock/">InnoDB Lock</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/MySQL/">MySQL</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://Keithlan.github.io/2017/06/21/innodb_locks_algorithms/" data-title="MySQL锁系列（七）之 锁算法详解 | Focus on MySQL,Focus on Life" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2017/06/30/sql_safe_updates_practise/" title="MySQL运维之神奇的参数(终结篇)">
  <strong>PREVIOUS:</strong><br/>
  <span>
  MySQL运维之神奇的参数(终结篇)</span>
</a>
</div>


<div class="next">
<a href="/2017/06/16/innodb_locks_MVCC/"  title="MySQL锁系列（六）之 MVCC">
 <strong>NEXT:</strong><br/> 
 <span>MySQL锁系列（六）之 MVCC
</span>
</a>
</div>

</nav>

	

<!-- 多说评论框 start -->
<div class="ds-thread" data-thread-key="/2017/06/21/innodb_locks_algorithms/" data-title="MySQL锁系列（七）之 锁算法详解" data-url="https://Keithlan.github.io/2017/06/21/innodb_locks_algorithms/"></div>
<!-- 多说评论框 end -->
<!-- 多说公共JS代码 start (一个网页只需插入一次) -->
<script type="text/javascript">
var duoshuoQuery = {short_name:keithlan};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
<!-- 多说公共JS代码 end -->


</div>  
      
  <div id="toc" class="toc-aside">
  <strong class="toc-title">Contents</strong>
  <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#能学到什么"><span class="toc-number">1.</span> <span class="toc-text">能学到什么</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#隔离级别和算法"><span class="toc-number">2.</span> <span class="toc-text">隔离级别和算法</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#锁算法的案例剖析"><span class="toc-number">3.</span> <span class="toc-text">锁算法的案例剖析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#insert_操作的加锁逻辑"><span class="toc-number">4.</span> <span class="toc-text">insert 操作的加锁逻辑</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#实战案例"><span class="toc-number">5.</span> <span class="toc-text">实战案例</span></a></li></ol>
  </div>

<div id="asidepart">
<div id="authorInfo">
	
		<div class="author-logo"></div>		
	
	
	<section class="author-info">
		
			<p> 幸福,不在于得到的多</p>
		
		
			<p>	而在于计较的少</p>
		
	</section>
	 
	<div class="social-font" class="clearfix">
		
		<a href="http://weibo.com/2101743962" target="_blank" title="weibo"></a>
		
		
		
		<a href="https://github.com/Keithlan" target="_blank" title="github"></a>
		
		
	</div>
</div>
<aside class="clearfix">


  
<div class="categorieslist">
	<p class="asidetitle">Categories</p>
		<ul>
		
			<li><a href="/categories/MySQL/" title="MySQL">MySQL<sup>50</sup></a></li>
		
			<li><a href="/categories/personal/" title="personal">personal<sup>1</sup></a></li>
		
			<li><a href="/categories/分享/" title="分享">分享<sup>37</sup></a></li>
		
		</ul>
</div>


  
  <div class="archiveslist">
    <p class="asidetitle"><a href="/archives">Archives</a></p>
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">April 2020</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/03/">March 2019</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2019/01/">January 2019</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/12/">December 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/11/">November 2018</a><span class="archive-list-count">8</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/08/">August 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/07/">July 2018</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/06/">June 2018</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/05/">May 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/03/">March 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/10/">October 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/09/">September 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/06/">June 2017</a><span class="archive-list-count">9</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/02/">February 2017</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a><span class="archive-list-count">3</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a><span class="archive-list-count">5</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/08/">August 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a><span class="archive-list-count">12</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/05/">May 2015</a><span class="archive-list-count">1</span></li></ul>
  </div>


  
<div class="tagslist">
	<p class="asidetitle">Tags</p>
		<ul class="clearfix">
		
			<li><a href="/tags/Error/" title="Error">Error<sup>2</sup></a></li>
		
			<li><a href="/tags/InnoDB-Lock/" title="InnoDB Lock">InnoDB Lock<sup>9</sup></a></li>
		
			<li><a href="/tags/Life-share/" title="Life share">Life share<sup>1</sup></a></li>
		
			<li><a href="/tags/Linux-share/" title="Linux share">Linux share<sup>1</sup></a></li>
		
			<li><a href="/tags/MHA/" title="MHA">MHA<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-Error/" title="MySQL Error">MySQL Error<sup>12</sup></a></li>
		
			<li><a href="/tags/MySQL-SYS-toolkit/" title="MySQL SYS toolkit">MySQL SYS toolkit<sup>2</sup></a></li>
		
			<li><a href="/tags/MySQL-feature/" title="MySQL feature">MySQL feature<sup>4</sup></a></li>
		
			<li><a href="/tags/MySQL-share/" title="MySQL share">MySQL share<sup>46</sup></a></li>
		
			<li><a href="/tags/MySQL-tools/" title="MySQL tools">MySQL tools<sup>6</sup></a></li>
		
			<li><a href="/tags/MySQL-实战/" title="MySQL 实战">MySQL 实战<sup>1</sup></a></li>
		
			<li><a href="/tags/SQL-Tuning/" title="SQL Tuning">SQL Tuning<sup>1</sup></a></li>
		
			<li><a href="/tags/sysbench/" title="sysbench">sysbench<sup>1</sup></a></li>
		
		</ul>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >

</div>
</footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      
      $('#toc.toc-aside').css('display', 'none');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"keithlan"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 





  </body>
</html>
